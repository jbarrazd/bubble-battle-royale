import{P as e,p as t}from"./phaser-D4TLMTam.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class s{static instance;capabilities;constructor(){this.capabilities=this.detectCapabilities()}static getInstance(){return s.instance||(s.instance=new s),s.instance}detectCapabilities(){const e=navigator.userAgent.toLowerCase(),t="ontouchstart"in window||navigator.maxTouchPoints>0,s=/android|webos|iphone|ipod|blackberry|iemobile|opera mini/i.test(e),i=/ipad|android(?!.*mobile)/i.test(e),a=!s&&!i,n=window.innerWidth,r=window.innerHeight,o=n>r,h=!o,c=document.createElement("canvas"),l=c.getContext("webgl")||c.getContext("experimental-webgl"),d=!!l;let u=2048;l&&d&&(u=l.getParameter(l.MAX_TEXTURE_SIZE));const p=!!(window.AudioContext||window.webkitAudioContext),m=!!document.createElement("audio").canPlayType;return{isTouch:t,isMobile:s,isTablet:i,isDesktop:a,pixelRatio:window.devicePixelRatio||1,screenWidth:n,screenHeight:r,isLandscape:o,isPortrait:h,hasWebGL:d,maxTextureSize:u,audioSupport:{webAudio:p,audioTag:m}}}getCapabilities(){return{...this.capabilities}}updateOrientation(){const e=window.innerWidth,t=window.innerHeight;this.capabilities.screenWidth=e,this.capabilities.screenHeight=t,this.capabilities.isLandscape=e>t,this.capabilities.isPortrait=!this.capabilities.isLandscape}getQualityPreset(){const{isMobile:e,pixelRatio:t,maxTextureSize:s}=this.capabilities;return e&&t>2&&s>=4096?"high":e||s<2048?"low":"medium"}shouldReduceMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}getOptimalResolution(){const{screenWidth:e,screenHeight:t,pixelRatio:s}=this.capabilities;let i=Math.min(e,828),a=Math.min(t,1792);return i=Math.min(2*i,828),a=Math.min(2*a,1792),{width:Math.floor(i),height:Math.floor(a)}}}const i=2.5,a={MAX_WIDTH:1035,MAX_HEIGHT:2240,COLORS:{UI_SUCCESS:"#2ecc71",UI_TEXT:"#ffffff"}};var n=(e=>(e.BOOT="BootScene",e.PRELOAD="PreloadScene",e.MENU="MenuScene",e.THEME_SELECT="ThemeSelectScene",e.GAME="GameScene",e.VICTORY="VictoryScene",e.SHOP="ShopScene",e))(n||{}),r=(e=>(e.SCENE_READY="scene-ready",e.SCENE_TRANSITION="scene-transition",e.PERFORMANCE_WARNING="performance-warning",e.ASSET_LOADED="asset-loaded",e.LOADING_COMPLETE="loading-complete",e.QUALITY_CHANGED="quality-changed",e))(r||{});class o{static instance;game;currentScene="";previousScene="";transitionInProgress=!1;eventEmitter;constructor(e){this.game=e,this.eventEmitter=new Phaser.Events.EventEmitter}static getInstance(e){if(!o.instance){if(!e)throw new Error("SceneManager must be initialized with a game instance");o.instance=new o(e)}return o.instance}transitionTo(e,t){if(this.transitionInProgress)return;if(!this.game.scene.getScene(e))return;this.transitionInProgress=!0,this.previousScene=this.currentScene;const s=this.game.scene.getScene(this.currentScene);s&&s.scene.isActive()?this.fadeOutScene(s,()=>{this.switchScene(e,t)}):this.switchScene(e,t)}fadeOutScene(e,t){e.cameras&&e.cameras.main?(e.cameras.main.fadeOut(300,0,0,0),e.cameras.main.once("camerafadeoutcomplete",t)):t()}switchScene(e,t){this.currentScene&&""!==this.currentScene&&this.game.scene.stop(this.currentScene);const s={...t,transitionFrom:this.previousScene};this.game.scene.start(e,s),this.game.scene.bringToTop(e),this.currentScene=e;const i=this.game.scene.getScene(e);i&&i.cameras&&i.cameras.main?(i.cameras.main.fadeIn(300,0,0,0),i.cameras.main.once("camerafadeincomplete",()=>{this.transitionInProgress=!1,this.eventEmitter.emit(r.SCENE_READY,{scene:e,previousScene:this.previousScene})})):(this.transitionInProgress=!1,this.eventEmitter.emit(r.SCENE_READY,{scene:e,previousScene:this.previousScene}))}getCurrentScene(){return this.currentScene}getPreviousScene(){return this.previousScene}isTransitioning(){return this.transitionInProgress}restartCurrentScene(e){if(this.currentScene){this.game.scene.getScene(this.currentScene)&&(this.game.scene.stop(this.currentScene),this.game.scene.start(this.currentScene,e))}}pauseCurrentScene(){this.currentScene&&this.game.scene.pause(this.currentScene)}resumeCurrentScene(){this.currentScene&&this.game.scene.resume(this.currentScene)}launchParallelScene(e,t){this.game.scene.getScene(e)&&this.game.scene.run(e,t)}stopParallelScene(e){this.game.scene.isActive(e)&&this.game.scene.stop(e)}on(e,t){this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter.off(e,t)}once(e,t){this.eventEmitter.once(e,t)}setCurrentScene(e){this.currentScene=e}}class h{fps=60;frameTime=0;lastTime=0;deltaTime=0;frameCount=0;fpsUpdateInterval=500;lastFpsUpdate=0;frames=[];maxFrameSamples=60;warningThreshold=30;criticalThreshold=20;consecutiveLowFrames=0;eventEmitter=null;constructor(){this.lastTime=performance.now(),this.lastFpsUpdate=this.lastTime}setEventEmitter(e){this.eventEmitter=e}update(e){const t=e||performance.now();this.deltaTime=t-this.lastTime,t-this.lastFpsUpdate>=this.fpsUpdateInterval&&(this.fps=Math.round(1e3/Math.max(16.67,this.deltaTime)),this.lastFpsUpdate=t),this.lastTime=t}getFPS(){return this.fps}getFrameTime(){return this.frameTime}getDeltaTime(){return this.deltaTime}getMetrics(){return{fps:this.fps,frameTime:this.frameTime,deltaTime:this.deltaTime,drawCalls:0,memoryUsage:this.getMemoryUsage()}}shouldReduceQuality(){return this.getAverageFPS()<this.warningThreshold&&this.consecutiveLowFrames>5}shouldIncreaseQuality(){return this.getAverageFPS()>=58&&0===this.consecutiveLowFrames}getAverageFPS(){if(0===this.frames.length)return 60;const e=this.frames.reduce((e,t)=>e+t,0)/this.frames.length;return Math.round(1e3/e)}getMemoryUsage(){if("memory"in performance){const e=performance.memory;if(e&&e.usedJSHeapSize)return Math.round(e.usedJSHeapSize/1048576)}}reset(){this.fps=60,this.frameTime=0,this.lastTime=performance.now(),this.deltaTime=0,this.frameCount=0,this.lastFpsUpdate=this.lastTime,this.frames=[],this.consecutiveLowFrames=0}getPerformanceScore(){const e=this.getAverageFPS(),t=Math.min(100,e/60*100);return Math.round(t)}logMetrics(){this.getMetrics()}}class c extends t.Scene{sceneManager;deviceDetection;performanceMonitor;constructor(){super({key:n.BOOT})}init(e){this.deviceDetection=s.getInstance(),this.performanceMonitor=new h,this.sceneManager=o.getInstance(this.game),this.performanceMonitor.setEventEmitter(this.game.events),this.setupDeviceListeners(),this.checkDeviceCapabilities()}preload(){const e=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,"Initializing...",{fontFamily:"Arial, sans-serif",fontSize:"30px",color:a.COLORS.UI_TEXT,align:"center"}).setOrigin(.5),t=this.add.graphics(),s=this.add.graphics(),i=this.cameras.main.centerX-200,n=this.cameras.main.centerY+50;s.fillStyle(2236962,.8),s.fillRect(i,n,400,62.5),this.load.on("progress",e=>{t.clear(),t.fillStyle(16777215,1),t.fillRect(i+12.5,n+12.5,375*e,37.5)}),this.load.on("complete",()=>{t.destroy(),s.destroy(),e.destroy()})}create(){this.deviceDetection.getCapabilities(),this.deviceDetection.getQualityPreset();this.setupGlobalEventListeners(),this.sceneManager.setCurrentScene(n.BOOT);try{this.sceneManager.transitionTo(n.PRELOAD)}catch(e){this.scene.start(n.PRELOAD)}}update(e,t){this.performanceMonitor.update(e)}setupDeviceListeners(){window.addEventListener("resize",()=>{this.deviceDetection.updateOrientation(),this.handleOrientationChange()}),window.addEventListener("orientationchange",()=>{this.deviceDetection.updateOrientation(),this.handleOrientationChange()}),document.addEventListener("visibilitychange",()=>{document.hidden?this.handleGamePause():this.handleGameResume()})}checkDeviceCapabilities(){const e=this.deviceDetection.getCapabilities();e.hasWebGL?(e.isLandscape&&e.isMobile,e.maxTextureSize):this.showErrorMessage("WebGL is required to play this game")}handleOrientationChange(){const e=this.deviceDetection.getCapabilities();e.isMobile&&e.isLandscape;const t=Math.min(e.screenWidth,a.MAX_WIDTH),s=Math.min(e.screenHeight,a.MAX_HEIGHT);this.scale.resize(t,s)}handleGamePause(){this.sceneManager.pauseCurrentScene(),this.sound.pauseAll()}handleGameResume(){this.sceneManager.resumeCurrentScene(),this.sound.resumeAll()}setupGlobalEventListeners(){this.game.events.on("performance-warning",e=>{"critical"===e.severity&&this.handleCriticalPerformance()}),this.game.events.on("scene-ready",e=>{})}handleCriticalPerformance(){}showErrorMessage(e){const t=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,e,{fontFamily:"Arial, sans-serif",fontSize:"25px",color:"#ff0000",align:"center",wordWrap:{width:375}}).setOrigin(.5);this.add.rectangle(this.cameras.main.centerX,this.cameras.main.centerY,t.width+50,t.height+50,0,.8).setOrigin(.5),t.setDepth(1)}}const l={LOGO:"logo",BACKGROUND:"background",PLANET:"planet",BUBBLE_PLANET:"bubble_planet"},d={BUBBLE_SHOOT:"bubble-shoot",BUBBLE_ATTACH:"bubble-attach",BUBBLES_DROP:"bubbles-drop",COMBO_3:"combo-3",COMBO_4:"combo-4",COMBO_5_PLUS:"combo-5-plus",COMBO_CELEBRATION:"combo-celebration",ARSENAL_PICKUP:"arsenal-pickup",SUCCESS_OBJECTIVE:"success-objective",VICTORY:"victory",DEFEAT:"defeat",BACKGROUND_MUSIC:"background-music"};class u{scene;manifest;loadedCount=0;totalCount=0;constructor(e){this.scene=e,this.manifest={images:[{key:l.LOGO,url:"assets/images/logo-placeholder.png",type:"image",data:{}},{key:l.BACKGROUND,url:"assets/images/background-placeholder.png",type:"image",data:{}},{key:l.PLANET,url:"assets/sprites/planeta.png",type:"image",data:{}},{key:l.BUBBLE_PLANET,url:"assets/sprites/bubble_planet.png",type:"image",data:{}}],audio:[{key:d.BUBBLE_SHOOT,url:"assets/sounds/bubble-shoot.mp3",type:"audio",data:{}},{key:d.BUBBLE_ATTACH,url:"assets/sounds/bubbles-attach.mp3",type:"audio",data:{}},{key:d.BUBBLES_DROP,url:"assets/sounds/bubbles-drop.mp3",type:"audio",data:{}},{key:d.COMBO_3,url:"assets/sounds/combo-3.mp3",type:"audio",data:{}},{key:d.COMBO_4,url:"assets/sounds/combo-4.mp3",type:"audio",data:{}},{key:d.COMBO_5_PLUS,url:"assets/sounds/combo-5-plus.mp3",type:"audio",data:{}},{key:d.COMBO_CELEBRATION,url:"assets/sounds/combo-celebration.mp3",type:"audio",data:{}},{key:d.ARSENAL_PICKUP,url:"assets/sounds/arsenal-pickup.mp3",type:"audio",data:{}},{key:d.SUCCESS_OBJECTIVE,url:"assets/sounds/success-objective.mp3",type:"audio",data:{}},{key:d.VICTORY,url:"assets/sounds/victory.mp3",type:"audio",data:{}},{key:d.DEFEAT,url:"assets/sounds/defeat.mp3",type:"audio",data:{}},{key:d.BACKGROUND_MUSIC,url:"assets/sounds/background-music.mp3",type:"audio",data:{}}],atlases:[],json:[]},this.calculateTotalAssets()}calculateTotalAssets(){this.totalCount=this.manifest.images.length+this.manifest.audio.length+this.manifest.atlases.length+this.manifest.json.length}loadAssets(e){e&&this.scene.load.on("progress",t=>{e(t)}),this.scene.load.on("fileprogress",e=>{}),this.loadImages(),this.loadAudio(),this.loadAtlases(),this.loadJSON(),this.scene.load.on("complete",()=>{})}loadImages(){this.manifest.images.forEach(e=>{this.scene.textures.exists(e.key)||this.scene.load.image(e.key,e.url)})}loadAudio(){this.manifest.audio.forEach(e=>{this.scene.cache.audio.exists(e.key)||this.scene.load.audio(e.key,e.url)})}loadAtlases(){this.manifest.atlases.forEach(e=>{if(this.scene.textures.exists(e.key))return;const t=e.url.replace(".png",".json");this.scene.load.atlas(e.key,e.url,t)})}loadJSON(){this.manifest.json.forEach(e=>{this.scene.cache.json.exists(e.key)||this.scene.load.json(e.key,e.url)})}getProgress(){return this.loadedCount/Math.max(1,this.totalCount)}getTotalAssets(){return this.totalCount}getLoadedAssets(){return this.loadedCount}}class p extends t.Scene{sceneManager;assetLoader;performanceMonitor;loadingText;progressBar;progressBox;percentText;assetText;constructor(){super({key:n.PRELOAD})}init(e){this.sceneManager=o.getInstance(),this.performanceMonitor=new h,this.assetLoader=new u(this)}preload(){this.createLoadingUI(),this.setupLoadingListeners(),this.createPlaceholderAssets(),this.assetLoader.loadAssets(e=>{this.updateProgress(e)})}create(){this.add.text(this.cameras.main.centerX,this.cameras.main.centerY+100,"Assets Loaded!",{fontFamily:"Arial, sans-serif",fontSize:"20px",color:a.COLORS.UI_SUCCESS,align:"center"}).setOrigin(.5),this.cleanupLoadingUI(),this.time.delayedCall(500,()=>{this.game.events.emit(r.LOADING_COMPLETE),this.sceneManager.setCurrentScene(n.PRELOAD),this.sceneManager.transitionTo(n.MENU)})}update(e,t){this.performanceMonitor.update(e)}createLoadingUI(){const e=this.cameras.main.centerX,t=this.cameras.main.centerY;this.add.text(e,t-100,"Bubble Battle Royale",{fontFamily:"Arial, sans-serif",fontSize:"32px",color:a.COLORS.UI_TEXT,align:"center"}).setOrigin(.5),this.loadingText=this.add.text(e,t-40,"Loading...",{fontFamily:"Arial, sans-serif",fontSize:"20px",color:a.COLORS.UI_TEXT,align:"center"}).setOrigin(.5);const s=e-160,i=t;this.progressBox=this.add.graphics(),this.progressBox.fillStyle(2236962,.8),this.progressBox.fillRect(s,i,320,50),this.progressBar=this.add.graphics(),this.percentText=this.add.text(e,t+25,"0%",{fontFamily:"Arial, sans-serif",fontSize:"18px",color:a.COLORS.UI_TEXT,align:"center"}).setOrigin(.5),this.assetText=this.add.text(e,t+70,"",{fontFamily:"Arial, sans-serif",fontSize:"14px",color:a.COLORS.UI_TEXT,align:"center"}).setOrigin(.5),this.createLoadingAnimation()}createLoadingAnimation(){const e=[16711680,65280,255,16776960,16711935],t=this.cameras.main.centerX,s=this.cameras.main.centerY+150;for(let i=0;i<5;i++){const a=this.add.circle(t+40*(i-2),s,15,e[i],1);this.tweens.add({targets:a,y:s-20,duration:500,ease:"Sine.easeInOut",yoyo:!0,repeat:-1,delay:100*i})}}setupLoadingListeners(){this.load.on("progress",e=>{this.updateProgress(e)}),this.load.on("fileprogress",e=>{this.assetText.setText(`Loading: ${e.key}`)}),this.load.on("complete",()=>{this.assetText.setText("Complete!")}),this.load.on("loaderror",e=>{this.assetText.setText(`Error loading: ${e.key}`)})}updateProgress(e){const t=Math.floor(100*e);this.percentText.setText(`${t}%`),this.progressBar.clear(),this.progressBar.fillStyle(16777215,1);const s=this.cameras.main.centerX-160,i=this.cameras.main.centerY;this.progressBar.fillRect(s+10,i+10,300*e,30),e>=.5&&this.loadingText.setText("Loading Assets..."),e>=.8&&this.loadingText.setText("Almost Ready...")}createPlaceholderAssets(){const e=this.make.graphics({x:0,y:0});e.fillStyle(3447003,1),e.fillCircle(32,32,32),e.generateTexture(l.LOGO,64,64),e.clear(),e.fillStyle(2899536,1),e.fillRect(0,0,this.cameras.main.width,this.cameras.main.height),e.generateTexture(l.BACKGROUND,this.cameras.main.width,this.cameras.main.height),e.clear(),e.fillStyle(16777215,1),e.fillCircle(8,8,8),e.generateTexture("particle",16,16),e.destroy()}cleanupLoadingUI(){this.progressBar&&this.progressBar.destroy(),this.progressBox&&this.progressBox.destroy(),this.percentText&&this.percentText.destroy(),this.loadingText&&this.loadingText.setText("Ready!")}}class m extends t.Scene{sceneManager;performanceMonitor;buttons=[];titleText;versionText;fpsText;constructor(){super({key:n.MENU})}init(e){this.sceneManager=o.getInstance(),this.sceneManager.setCurrentScene(n.MENU),this.performanceMonitor=new h,this.game&&this.game.events&&this.performanceMonitor.setEventEmitter(this.game.events)}create(){this.createBackground(),this.createTitle(),this.createMenuButtons(),this.createVersionInfo(),this.createFPSDisplay(),this.addAnimations()}update(e,t){if(this.fpsText&&this.time&&this.time.now%1e3<16){const e=Math.round(this.game.loop.actualFps);this.fpsText.setText(`FPS: ${e}`),e<30?this.fpsText.setTint(16711680):e<50?this.fpsText.setTint(16776960):this.fpsText.setTint(65280)}}createBackground(){const e=this.add.image(0,0,l.BACKGROUND);e.setOrigin(0,0),e.setDisplaySize(this.cameras.main.width,this.cameras.main.height),e.setTint(1710638);for(let t=0;t<20;t++){const e=this.add.circle(Phaser.Math.Between(0,this.cameras.main.width),Phaser.Math.Between(0,this.cameras.main.height),Phaser.Math.Between(10,30),Phaser.Math.Between(3447003,10181046),.2);this.tweens.add({targets:e,y:e.y-Phaser.Math.Between(50,150),x:e.x+Phaser.Math.Between(-30,30),alpha:0,duration:Phaser.Math.Between(3e3,6e3),ease:"Sine.easeOut",repeat:-1,delay:Phaser.Math.Between(0,3e3)})}}createTitle(){this.titleText=this.add.text(this.cameras.main.centerX,100,"Bubble Battle\nRoyale",{fontFamily:"Arial, sans-serif",fontSize:"42px",color:a.COLORS.UI_TEXT,align:"center",stroke:"#000000",strokeThickness:4}).setOrigin(.5),this.tweens.add({targets:this.titleText,scaleX:1.05,scaleY:1.05,duration:2e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1})}createMenuButtons(){[{text:"PLAY",action:()=>this.startGame()},{text:"PRACTICE",action:()=>this.startPractice()},{text:"SETTINGS",action:()=>this.openSettings()},{text:"ABOUT",action:()=>this.showAbout()}].forEach((e,t)=>{const s=this.createButton(this.cameras.main.centerX,250+70*t,e.text,e.action);this.buttons.push(s),s.setAlpha(0),s.setScale(.8),this.tweens.add({targets:s,alpha:1,scaleX:1,scaleY:1,duration:500,ease:"Back.easeOut",delay:100+100*t})})}createButton(e,t,s,i){const n=this.add.container(e,t),r=this.add.rectangle(0,0,250,50,3447003,1);r.setStrokeStyle(2,16777215,1),r.setInteractive({useHandCursor:!0});const o=this.add.text(0,0,s,{fontFamily:"Arial, sans-serif",fontSize:"20px",color:a.COLORS.UI_TEXT,align:"center"}).setOrigin(.5);return n.add([r,o]),r.on("pointerover",()=>{r.setFillStyle(6139362),this.tweens.add({targets:n,scaleX:1.1,scaleY:1.1,duration:100,ease:"Power2"})}),r.on("pointerout",()=>{r.setFillStyle(3447003),this.tweens.add({targets:n,scaleX:1,scaleY:1,duration:100,ease:"Power2"})}),r.on("pointerdown",()=>{n.setScale(.95)}),r.on("pointerup",()=>{n.setScale(1),i()}),n}createVersionInfo(){this.versionText=this.add.text(10,this.cameras.main.height-30,"v1.0.0 - Development Build",{fontFamily:"Arial, sans-serif",fontSize:"12px",color:a.COLORS.UI_TEXT}).setOrigin(0,.5).setAlpha(.5)}createFPSDisplay(){this.fpsText=this.add.text(this.cameras.main.width-10,10,"FPS: 60",{fontFamily:"monospace",fontSize:"14px",color:"#00ff00"}).setOrigin(1,0)}addAnimations(){this.add.particles(0,0,l.LOGO,{x:{min:0,max:this.cameras.main.width},y:this.cameras.main.height+50,lifespan:8e3,speedY:{min:-100,max:-50},scale:{start:.1,end:0},quantity:1,frequency:2e3,alpha:{start:.3,end:0},tint:[3447003,10181046,15158332,15965202]})}startGame(){this.tweens.add({targets:this.buttons,alpha:0,duration:300,onComplete:()=>{this.sceneManager.transitionTo(n.THEME_SELECT)}})}startPractice(){this.showMessage("Practice Mode Coming Soon!")}openSettings(){this.showMessage("Settings Coming Soon!")}showAbout(){this.showMessage("Bubble Battle Royale\nBuilt with Phaser 3 & TypeScript\n\nA competitive bubble shooter game!")}showMessage(e){const t=this.add.rectangle(this.cameras.main.centerX,this.cameras.main.centerY,this.cameras.main.width,this.cameras.main.height,0,.7),s=this.add.rectangle(this.cameras.main.centerX,this.cameras.main.centerY,400,200,2899536,1);s.setStrokeStyle(2,16777215);const i=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY-30,e,{fontFamily:"Arial, sans-serif",fontSize:"18px",color:a.COLORS.UI_TEXT,align:"center",wordWrap:{width:350}}).setOrigin(.5),n=this.createButton(this.cameras.main.centerX,this.cameras.main.centerY+60,"CLOSE",()=>{t.destroy(),s.destroy(),i.destroy(),n.destroy()});t.setInteractive(),t.on("pointerdown",()=>{t.destroy(),s.destroy(),i.destroy(),n.destroy()})}}class g{scene;config;gradientGraphics;gradientTexture;parallaxLayers=[];particleEmitters=[];ambientElements=[];animationTimers=[];themes={ocean:{colors:[6707,13158,19865,26316],accent:52479,particles:6741503,name:"Ocean Depths",particleType:"bubbles",secondaryParticles:10088191},sunset:{colors:[1703987,3342438,6684825,10027212],accent:16737792,particles:16755200,name:"Twilight",particleType:"fireflies",secondaryParticles:16764006},forest:{colors:[6656,13056,19712,26112],accent:65280,particles:4500036,name:"Mystic Forest",particleType:"leaves",secondaryParticles:6741350},space:{colors:[17,34,51,68],accent:10053375,particles:16777215,name:"Deep Space",particleType:"stars",secondaryParticles:11189247},aurora:{colors:[4386,8772,13158,17544],accent:65433,particles:65450,name:"Northern Lights",particleType:"aurora",secondaryParticles:11206655}};currentTheme;width;height;constructor(e,t={}){this.scene=e,this.config={theme:t.theme||"ocean",quality:t.quality||"high",enableParticles:!1!==t.enableParticles,enableAnimation:!1!==t.enableAnimation},this.currentTheme=this.themes[this.config.theme],this.width=e.cameras.main.width,this.height=e.cameras.main.height,this.create()}create(){this.createGradientBackground(),"low"!==this.config.quality&&this.createParallaxLayers(),this.config.enableParticles&&"low"!==this.config.quality&&this.createAmbientParticles(),"high"!==this.config.quality&&"ultra"!==this.config.quality&&"stars"!==this.currentTheme.particleType||this.createAnimatedElements(),this.config.enableAnimation&&this.startAnimations()}createGradientBackground(){this.gradientGraphics=this.scene.add.graphics();const e=this.currentTheme.colors,t=this.height/(e.length-1);for(let s=0;s<e.length-1;s++){const i=e[s],a=e[s+1];for(let e=0;e<t;e++){const n=e/t,r=this.blendColors(i,a,n);this.gradientGraphics.fillStyle(r,1),this.gradientGraphics.fillRect(0,s*t+e,this.width,1)}}"ultra"===this.config.quality&&this.addNoiseTexture(),this.gradientGraphics.setDepth(-1e3)}createParallaxLayers(){const e="ultra"===this.config.quality?3:2;for(let t=0;t<e;t++){const e=this.scene.add.container(0,0);e.setDepth(10*t-900);const s="ultra"===this.config.quality?6:3;for(let i=0;i<s;i++){const s=this.createThemeElement(t);s&&(s.x=Phaser.Math.Between(0,this.width),s.y=Phaser.Math.Between(0,this.height),e.add(s))}this.parallaxLayers.push(e)}}createThemeElement(e){const t=.02+.015*e,s=.5+.3*e;switch(this.currentTheme.particleType){case"bubbles":const a=this.scene.add.circle(0,0,Phaser.Math.Between(20,40)*i*s,this.currentTheme.secondaryParticles,t);return a.setStrokeStyle(1,this.currentTheme.particles,2*t),a;case"fireflies":const n=this.scene.add.circle(0,0,Phaser.Math.Between(3,8)*i*s,this.currentTheme.particles,3*t);return this.scene.tweens.add({targets:n,alpha:{from:2*t,to:4*t},duration:Phaser.Math.Between(2e3,4e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),n;case"leaves":const r=this.scene.add.ellipse(0,0,45*s,62.5*s,Phaser.Math.RND.pick([6070364,7122540,5017676]),.12);return r.setAngle(Phaser.Math.Between(0,360)),this.scene.tweens.add({targets:r,angle:`+=${Phaser.Math.Between(-30,30)}`,duration:Phaser.Math.Between(8e3,12e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),r;case"stars":default:return null;case"aurora":const o=this.scene.add.rectangle(0,0,Phaser.Math.Between(80,120)*i*s,1250*s,Phaser.Math.RND.pick([65484,10092526,13434879]),.06+.02*e);return o.setBlendMode(Phaser.BlendModes.ADD),o.setAngle(Phaser.Math.Between(-15,15)),this.scene.tweens.add({targets:o,alpha:{from:.04,to:.08},scaleX:{from:.8,to:1.2},angle:o.angle+Phaser.Math.Between(-5,5),duration:Phaser.Math.Between(12e3,18e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),o}}drawLeaf(e,t,s,i){const a=[t,s-1.5*i,t-.7*i,s,t,s+1.5*i,t+.7*i,s];e.fillPoints(a,!0)}createAmbientParticles(){let e="ultra"===this.config.quality?8:4,t=500;"stars"===this.currentTheme.particleType&&(e="ultra"===this.config.quality?12:6,t=300);for(let s=0;s<e;s++)this.scene.time.delayedCall(s*t,()=>{this.createThemeParticle()})}createThemeParticle(){let e;const t=Phaser.Math.Between(0,this.width),s="leaves"===this.currentTheme.particleType?-20:this.height+20;switch(this.currentTheme.particleType){case"bubbles":e=this.scene.add.circle(t,this.height+20,Phaser.Math.Between(3,8)*i,this.currentTheme.particles,Phaser.Math.FloatBetween(.1,.2)),e.setStrokeStyle(1,this.currentTheme.secondaryParticles,.3),this.scene.tweens.add({targets:e,y:-20,x:t+30*Math.sin(.001*Date.now()),duration:Phaser.Math.Between(12e3,18e3),ease:"Linear",onComplete:()=>this.recycleParticle(e)}),this.scene.tweens.add({targets:e,x:`+=${Phaser.Math.Between(-30,30)}`,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});break;case"fireflies":e=this.scene.add.circle(t,Phaser.Math.Between(.3*this.height,.7*this.height),Phaser.Math.Between(2,4)*i,this.currentTheme.particles,.8),this.scene.tweens.add({targets:e,scale:{from:.8,to:1.3},alpha:{from:.4,to:1},duration:Phaser.Math.Between(1e3,2e3),yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.createFireflyPath(e),this.scene.time.delayedCall(Phaser.Math.Between(15e3,2e4),()=>{this.recycleParticle(e)});break;case"leaves":const a=Phaser.Math.Between(10,18)*i;e=this.scene.add.ellipse(t,s,.8*a,1.3*a,Phaser.Math.RND.pick([6070364,8173692,5017676,7122540]),.6),e.setStrokeStyle(1,3832378,.8),e.setAngle(Phaser.Math.Between(0,360));const n=Phaser.Math.Between(1e4,15e3);this.scene.tweens.add({targets:e,y:this.height+20,angle:`+=${Phaser.Math.Between(90,270)}`,duration:n,ease:"Linear",onComplete:()=>this.recycleParticle(e)}),this.scene.tweens.add({targets:e,x:`+=${Phaser.Math.Between(-60,60)}`,duration:2500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.scene.tweens.add({targets:e,scaleX:{from:1,to:.85},scaleY:{from:1,to:1.1},duration:3e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});break;case"stars":const r=Phaser.Math.FloatBetween(.5,2)*i;e=this.scene.add.circle(Phaser.Math.Between(0,this.width),Phaser.Math.Between(0,this.height),r,16777215,Phaser.Math.FloatBetween(.5,.9)),Phaser.Math.Between(0,10)>7?this.scene.tweens.add({targets:e,alpha:{from:e.alpha,to:.3*e.alpha},duration:Phaser.Math.Between(2e3,4e3),yoyo:!0,repeat:Phaser.Math.Between(1,3),ease:"Sine.easeInOut",onComplete:()=>{this.scene.tweens.add({targets:e,alpha:0,duration:1e3,onComplete:()=>this.recycleParticle(e)})}}):this.scene.time.delayedCall(Phaser.Math.Between(1e4,2e4),()=>{e&&e.active&&this.scene.tweens.add({targets:e,alpha:0,duration:2e3,onComplete:()=>this.recycleParticle(e)})});break;case"aurora":const o=Phaser.Math.Between(50,this.width-50),h=Phaser.Math.Between(100,180)*i,c=Phaser.Math.RND.pick([65450,56831,10092509,16755455,11193599]);e=this.scene.add.rectangle(o,this.height/2,h,1.5*this.height,c,.12),e.setBlendMode(Phaser.BlendModes.ADD),e.setAngle(Phaser.Math.Between(-10,10)),this.scene.tweens.add({targets:e,alpha:{from:.08,to:.18},scaleX:{from:.7,to:1.2},x:o+Phaser.Math.Between(-40,40),angle:e.angle+Phaser.Math.Between(-5,5),duration:Phaser.Math.Between(1e4,15e3),yoyo:!0,ease:"Sine.easeInOut",onComplete:()=>this.recycleParticle(e)});let l=0;const d=this.scene.time.addEvent({delay:3e3,callback:()=>{if(e&&e.active){const t=[c,65484,11206655];l=(l+1)%t.length,this.scene.tweens.add({targets:e,duration:2e3,onUpdate:s=>{const i=s.progress,a=t[l],n=t[(l+1)%t.length],r=Phaser.Display.Color.Interpolate.ColorWithColor(Phaser.Display.Color.IntegerToColor(a),Phaser.Display.Color.IntegerToColor(n),1,i);e.setFillStyle(Phaser.Display.Color.GetColor(r.r,r.g,r.b),e.alpha)}})}else d.destroy()},loop:!0});break;default:return}e.setDepth(-850),this.ambientElements.push(e)}createFireflyPath(e){const t=()=>{const s=e.x+Phaser.Math.Between(-100,100),i=e.y+Phaser.Math.Between(-50,50),a=Phaser.Math.Clamp(s,50,this.width-50),n=Phaser.Math.Clamp(i,.2*this.height,.8*this.height);this.scene.tweens.add({targets:e,x:a,y:n,duration:Phaser.Math.Between(2e3,3e3),ease:"Sine.easeInOut",onComplete:()=>{e&&e.active&&t()}})};t()}recycleParticle(e){e.destroy(),this.ambientElements=this.ambientElements.filter(t=>t!==e),this.createThemeParticle()}createSecondaryEffect(){const e=this.scene.time.addEvent({delay:500,callback:()=>{switch(this.currentTheme.particleType){case"bubbles":const e=Phaser.Math.Between(0,this.width);for(let n=0;n<3;n++){const t=this.scene.add.circle(e+Phaser.Math.Between(-20,20),this.height+10,Phaser.Math.Between(1,3)*i,this.currentTheme.secondaryParticles,.2);t.setDepth(-840),this.ambientElements.push(t),this.scene.tweens.add({targets:t,y:-10,duration:Phaser.Math.Between(8e3,1e4),delay:100*n,ease:"Linear",onComplete:()=>{t.destroy(),this.ambientElements=this.ambientElements.filter(e=>e!==t)}})}break;case"fireflies":const t=this.scene.add.circle(Phaser.Math.Between(0,this.width),Phaser.Math.Between(.2*this.height,.8*this.height),2.5,this.currentTheme.secondaryParticles,1);t.setDepth(-840),this.ambientElements.push(t),this.scene.tweens.add({targets:t,alpha:{from:1,to:0},scale:{from:1,to:0},duration:1e3,ease:"Power2",onComplete:()=>{t.destroy(),this.ambientElements=this.ambientElements.filter(e=>e!==t)}});break;case"stars":const s=this.scene.add.circle(Phaser.Math.Between(0,this.width),Phaser.Math.Between(0,this.height),1.25,13426175,Phaser.Math.FloatBetween(.3,.5));s.setDepth(-840),this.ambientElements.push(s),this.scene.tweens.add({targets:s,x:s.x+Phaser.Math.Between(-10,10),y:s.y+Phaser.Math.Between(-10,10),alpha:0,duration:Phaser.Math.Between(5e3,8e3),ease:"Linear",onComplete:()=>{s.destroy(),this.ambientElements=this.ambientElements.filter(e=>e!==s)}});break;default:const a=this.scene.add.star(Phaser.Math.Between(0,this.width),Phaser.Math.Between(0,this.height),4,5,10,this.currentTheme.particles);a.setAlpha(0),a.setDepth(-840),this.ambientElements.push(a),this.scene.tweens.add({targets:a,alpha:{from:0,to:.3,yoyo:!0},scale:{from:0,to:1,yoyo:!0},angle:180,duration:1500,ease:"Cubic.easeOut",onComplete:()=>{a.destroy(),this.ambientElements=this.ambientElements.filter(e=>e!==a)}})}},loop:!0});this.animationTimers.push(e)}createAnimatedElements(){"stars"===this.currentTheme.particleType&&(this.createBackgroundPlanet(),this.createShootingStarTimer())}createBackgroundPlanet(){if(this.scene.textures.exists("planet")){const e=.82*this.width,t=.18*this.height,s=.12,i=this.scene.add.image(e,t,"planet");i.setScale(s),i.setAlpha(.1),i.setDepth(-998),this.scene.tweens.add({targets:i,y:t+20,duration:45e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.ambientElements.push(i)}}createFloatingBubblesBetweenPlanets(){}createShootingStarTimer(){this.scene.time.delayedCall(5e3,()=>{this.createShootingStar()});const e=()=>{const t=Phaser.Math.Between(12e3,25e3);this.scene.time.delayedCall(t,()=>{this.scene&&this.scene.scene.isActive()&&(this.createShootingStar(),e())})};e()}createShootingStar(){const e=Phaser.Math.Between(0,.6*this.width),t=Phaser.Math.Between(0,.4*this.height),s=this.scene.add.container(e,t);for(let r=8;r>0;r--){const e=this.scene.add.circle(8*-r,0,.3*(8-r)+.5,16777215,.5*(1-r/8));e.setBlendMode(Phaser.BlendModes.ADD),s.add(e)}const i=this.scene.add.circle(0,0,3.75,16777215,1);i.setBlendMode(Phaser.BlendModes.ADD),s.add(i),s.add(i),s.setDepth(-800),s.setAngle(35),this.ambientElements.push(s);const a=e+Phaser.Math.Between(300,450),n=t+Phaser.Math.Between(150,250);this.scene.tweens.add({targets:s,x:a,y:n,duration:600,ease:"Power2.easeIn",onUpdate:e=>{const t=e.progress;s.alpha=1-.7*t},onComplete:()=>{s.destroy(),this.ambientElements=this.ambientElements.filter(e=>e!==s)}})}startAnimations(){if(this.parallaxLayers.length>0){const e=this.scene.time.addEvent({delay:50,callback:this.updateParallax.bind(this),loop:!0});this.animationTimers.push(e)}"ultra"===this.config.quality&&this.startGradientAnimation()}updateParallax(){this.parallaxLayers.forEach((e,t)=>{const s=.1*(t+1);e.x-=s,e.x<-100&&(e.x=0)})}startGradientAnimation(){let e=0;const t=this.scene.time.addEvent({delay:100,callback:()=>{e+=.5,e>360&&(e=0),this.ambientElements.forEach(t=>{if("setTint"in t){const s=this.shiftHue(this.currentTheme.accent,e);t.setTint(s)}})},loop:!0});this.animationTimers.push(t)}addNoiseTexture(){const e=this.scene.add.graphics();e.setAlpha(.02);for(let t=0;t<1e3;t++){const t=Phaser.Math.Between(0,this.width),s=Phaser.Math.Between(0,this.height),i=Phaser.Math.FloatBetween(.1,.3);e.fillStyle(16777215,i),e.fillRect(t,s,1,1)}e.setDepth(-999)}blendColors(e,t,s){const i=e>>16&255,a=e>>8&255,n=255&e,r=t>>16&255,o=t>>8&255,h=255&t;return Math.floor(i+(r-i)*s)<<16|Math.floor(a+(o-a)*s)<<8|Math.floor(n+(h-n)*s)}shiftHue(e,t){const s=(e>>16&255)/255,i=(e>>8&255)/255,a=(255&e)/255,n=Math.max(s,i,a),r=Math.min(s,i,a),o=(n+r)/2;if(n===r)return e;const h=n-r,c=o>.5?h/(2-n-r):h/(n+r);let l;l=n===s?((i-a)/h+(i<a?6:0))/6:n===i?((a-s)/h+2)/6:((s-i)/h+4)/6,l=(l+t/360)%1;const d=(e,t,s)=>(s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e),u=o<.5?o*(1+c):o+c-o*c,p=2*o-u;return Math.floor(255*d(p,u,l+1/3))<<16|Math.floor(255*d(p,u,l))<<8|Math.floor(255*d(p,u,l-1/3))}setTheme(e){this.config.theme=e,this.currentTheme=this.themes[e],this.destroy(),this.create()}setQuality(e){this.config.quality=e,this.destroy(),this.create()}destroy(){this.gradientGraphics?.destroy(),this.parallaxLayers.forEach(e=>e.destroy()),this.parallaxLayers=[],this.particleEmitters.forEach(e=>e.destroy()),this.particleEmitters=[],this.ambientElements.forEach(e=>e.destroy()),this.ambientElements=[],this.animationTimers.forEach(e=>e.destroy()),this.animationTimers=[]}}class y extends t.Scene{backgroundSystem;selectedTheme="ocean";themeContainers=[];titleText;confirmButton;previewBackground;themes=[{key:"ocean",name:"Ocean Depths",description:"Dive into deep blue waters",colors:[6707,13158,19865,26316],icon:"🌊"},{key:"sunset",name:"Twilight Dream",description:"Purple and orange sunset vibes",colors:[1703987,3342438,6684825,16737792],icon:"🌅"},{key:"forest",name:"Mystic Forest",description:"Natural green serenity",colors:[6656,13056,19712,26112],icon:"🌲"},{key:"space",name:"Deep Space",description:"Journey through the cosmos",colors:[17,34,51,10053375],icon:"🚀"},{key:"aurora",name:"Northern Lights",description:"Magical aurora borealis",colors:[4386,8772,13158,65433],icon:"🌌"}];constructor(){super({key:n.THEME_SELECT})}create(){const{width:e,height:t}=this.cameras.main;this.previewBackground=new g(this,{theme:"ocean",quality:"high",enableParticles:!0,enableAnimation:!0});const s=this.add.graphics();s.fillStyle(0,.3),s.fillRect(0,0,e,t),s.setDepth(100),this.titleText=this.add.text(e/2,100,"Choose Your Theme",{fontSize:"60px",fontFamily:"Arial Black",color:"#ffffff",stroke:"#000000",strokeThickness:3}),this.titleText.setOrigin(.5),this.titleText.setDepth(101),this.tweens.add({targets:this.titleText,scale:{from:.95,to:1.05},duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.createThemeCards(),this.createConfirmButton(),this.setupKeyboardControls(),this.selectTheme(0)}createThemeCards(){const{width:e,height:t}=this.cameras.main,s=.85*e,i=162.5,a=200+(t-200-250-(i*this.themes.length+25*(this.themes.length-1)))/2,n=e/2;this.themes.forEach((e,t)=>{const r=a+187.5*t,o=this.createThemeCard(e,n,r,s,i,t);this.themeContainers.push(o)})}createThemeCard(e,t,s,i,a,n){const r=this.add.container(t,s);r.setDepth(102);const o=this.add.graphics();o.fillStyle(0,.7),o.fillRoundedRect(-i/2,-a/2,i,a,10),o.lineStyle(2,16777215,.3),o.strokeRoundedRect(-i/2,-a/2,i,a,10),r.add(o);const h=this.add.graphics();h.lineStyle(3,65280,1),h.strokeRoundedRect(-i/2-3,-a/2-3,i+6,a+6,12),h.setVisible(!1),r.add(h),r.setData("glow",h);const c=-i/2+75,l=this.add.text(c,0,e.icon,{fontSize:"70px",fontFamily:"Arial"});l.setOrigin(.5),r.add(l);const d=this.add.text(-50,-25,e.name,{fontSize:"40px",fontFamily:"Arial Black",color:"#ffffff",align:"left"});d.setOrigin(0,.5),r.add(d);const u=this.add.text(-50,25,e.description,{fontSize:"27.5px",fontFamily:"Arial",color:"#aaaaaa",align:"left"});u.setOrigin(0,.5),r.add(u);const p=i/2-(30*e.colors.length+50);return e.colors.forEach((e,t)=>{const s=this.add.circle(p+30*t,0,10,e);s.setStrokeStyle(1,16777215,.3),r.add(s)}),r.setInteractive(new Phaser.Geom.Rectangle(-i/2,-a/2,i,a),Phaser.Geom.Rectangle.Contains),r.on("pointerover",()=>{this.tweens.add({targets:r,scale:1.05,duration:200,ease:"Power2"}),o.clear(),o.fillStyle(0,.9),o.fillRoundedRect(-i/2,-a/2,i,a,10),o.lineStyle(3,16777215,.5),o.strokeRoundedRect(-i/2,-a/2,i,a,10)}),r.on("pointerout",()=>{this.selectedTheme!==e.key&&(this.tweens.add({targets:r,scale:1,duration:200,ease:"Power2"}),o.clear(),o.fillStyle(0,.7),o.fillRoundedRect(-i/2,-a/2,i,a,10),o.lineStyle(3,16777215,.3),o.strokeRoundedRect(-i/2,-a/2,i,a,10))}),r.on("pointerdown",()=>{this.selectTheme(n)}),r.setScale(0),r.setAlpha(0),this.tweens.add({targets:r,scale:1,alpha:1,duration:500,delay:100*n,ease:"Back.easeOut"}),r}createConfirmButton(){const{width:e,height:t}=this.cameras.main,s=t-125;this.confirmButton=this.add.container(e/2,s),this.confirmButton.setDepth(103);const i=this.add.graphics(),a=.65*e,n=100;i.fillStyle(65280,.8),i.fillRoundedRect(-a/2,-50,a,n,10),this.confirmButton.add(i);const r=this.add.text(0,0,"START GAME",{fontSize:"45px",fontFamily:"Arial Black",color:"#000000"});r.setOrigin(.5),this.confirmButton.add(r),this.confirmButton.setInteractive(new Phaser.Geom.Rectangle(-a/2,-50,a,n),Phaser.Geom.Rectangle.Contains),this.confirmButton.on("pointerover",()=>{i.clear(),i.fillStyle(65280,1),i.fillRoundedRect(-a/2,-50,a,n,10),this.tweens.add({targets:this.confirmButton,scale:1.1,duration:200,ease:"Power2"})}),this.confirmButton.on("pointerout",()=>{i.clear(),i.fillStyle(65280,.8),i.fillRoundedRect(-a/2,-50,a,n,10),this.tweens.add({targets:this.confirmButton,scale:1,duration:200,ease:"Power2"})}),this.confirmButton.on("pointerdown",()=>{this.startGame()}),this.tweens.add({targets:this.confirmButton,scale:{from:.95,to:1.05},duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}selectTheme(e){const t=this.themes[e];this.selectedTheme=t.key,this.previewBackground.setTheme(t.key),this.themeContainers.forEach((t,s)=>{const i=t.getData("glow");s===e?(i.setVisible(!0),t.setScale(1.1),this.tweens.add({targets:t,y:t.y-10,duration:200,yoyo:!0,ease:"Power2"})):(i.setVisible(!1),t.setScale(1))}),this.registry.set("selectedTheme",t.key)}setupKeyboardControls(){this.input.keyboard?.on("keydown-ONE",()=>this.selectTheme(0)),this.input.keyboard?.on("keydown-TWO",()=>this.selectTheme(1)),this.input.keyboard?.on("keydown-THREE",()=>this.selectTheme(2)),this.input.keyboard?.on("keydown-FOUR",()=>this.selectTheme(3)),this.input.keyboard?.on("keydown-FIVE",()=>this.selectTheme(4)),this.input.keyboard?.on("keydown-ENTER",()=>this.startGame()),this.input.keyboard?.on("keydown-SPACE",()=>this.startGame()),this.input.keyboard?.on("keydown-ESC",()=>{this.scene.start(n.MENU)})}startGame(){this.previewBackground.destroy();const e=this.add.graphics();e.fillStyle(0,0),e.fillRect(0,0,this.cameras.main.width,this.cameras.main.height),e.setDepth(1e3),this.tweens.add({targets:e,alpha:1,duration:500,ease:"Power2",onComplete:()=>{this.scene.start(n.GAME,{theme:this.selectedTheme})}})}shutdown(){this.previewBackground?.destroy()}}var b=(e=>(e[e.RED=16711680]="RED",e[e.BLUE=255]="BLUE",e[e.GREEN=65280]="GREEN",e[e.YELLOW=16776960]="YELLOW",e[e.PURPLE=16711935]="PURPLE",e))(b||{}),f=(e=>(e.PLAYER="player",e.OPPONENT="opponent",e.OBJECTIVE="objective",e.NEUTRAL="neutral",e))(f||{});const S={width:937.5,height:1667.5,playerZoneHeight:667.5,opponentZoneHeight:667.5,objectiveZoneHeight:332.5,bubbleSize:70,objectiveSize:70,launcherOffset:112.5},w={SIZE:70,POOL_SIZE:50,ANIMATION_DURATION:200},P=7,B=5,M=3,C={PLAYER_OFFSET:300,OPPONENT_OFFSET:300,PULSE_DURATION:1e3},T=3447003,E=15158332,x=15965202,O=9807270,v=.2,A=0,k=15,I=20,L=25,D=40,G=50,F=60,R=100;class N{centerX;centerY;hexSize;gridMap;constructor(e,t){this.centerX=e,this.centerY=t,this.hexSize=w.SIZE/2+1,this.gridMap=new Map,this.initializeGrid()}initializeGrid(){for(let e=-5;e<=B;e++)for(let t=-7;t<=P;t++){const s=-e-t,i=this.getKey(e,t);this.gridMap.set(i,{q:e,r:t,s:s})}}hexToPixel(e){const t=this.hexSize*Math.sqrt(3),s=2*this.hexSize,i=Math.abs(e.r)%2==1?this.hexSize:0,a=e.q*s+i,n=e.r*t;return{x:this.centerX+a,y:this.centerY+n}}pixelToHex(e){const t=e.x-this.centerX,s=e.y-this.centerY,i=this.hexSize*Math.sqrt(3),a=2*this.hexSize,n=Math.round(s/i),r=Math.abs(n)%2==1?t-this.hexSize:t,o=Math.round(r/a);return{q:o,r:n,s:-o-n}}roundHex(e,t){const s=-e-t;let i=Math.round(e),a=Math.round(t),n=Math.round(s);const r=Math.abs(i-e),o=Math.abs(a-t),h=Math.abs(n-s);return r>o&&r>h?i=-a-n:o>h?a=-i-n:n=-i-a,{q:i,r:a,s:n}}getNeighbors(e){let t=[];return t=Math.abs(e.r)%2==1?[{q:0,r:-1},{q:1,r:-1},{q:1,r:0},{q:1,r:1},{q:0,r:1},{q:-1,r:0}]:[{q:0,r:-1},{q:1,r:0},{q:0,r:1},{q:-1,r:1},{q:-1,r:0},{q:-1,r:-1}],t.map(t=>({q:e.q+t.q,r:e.r+t.r,s:0}))}getDistance(e,t){return(Math.abs(e.q-t.q)+Math.abs(e.r-t.r)+Math.abs(e.s-t.s))/2}getRing(e,t){if(0===t)return[e];const s=[],i=[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0},{q:0,r:1,s:-1}];let a={q:e.q+i[4].q*t,r:e.r+i[4].r*t,s:e.s+i[4].s*t};for(let n=0;n<6;n++)for(let e=0;e<t;e++)s.push({...a}),a={q:a.q+i[n].q,r:a.r+i[n].r,s:a.s+i[n].s};return s}getSpiral(e,t){const s=[];for(let i=0;i<=t;i++){const t=this.getRing(e,i);s.push(...t)}return s}getKey(e,t){return`${e},${t}`}isValidPosition(e){const t=this.getKey(e.q,e.r);return this.gridMap.has(t)}getGridBounds(){return{minQ:-5,maxQ:B,minR:-7,maxR:P}}getAllBubbles(){return[]}getBubbleAt(e,t){const s=this.pixelToHex({x:e,y:t});return this.getKey(s.q,s.r),null}getBubblesInRadius(e,t,s){return[]}}class U extends Phaser.GameObjects.Container{bubbleSprite;innerGradient;highlightSprite;secondaryHighlight;shadowSprite;rimLight;gridPosition=null;color;isSpecial=!1;pooled=!1;shooter="none";idleAnimation;constructor(e,t,s,i){super(e,t,s),this.color=i;const a=w.SIZE/2;this.shadowSprite=e.add.circle(3,5,a,0,.2),this.shadowSprite.setScale(.95),this.bubbleSprite=e.add.circle(0,0,a,i),this.innerGradient=e.add.circle(0,2,a-4,this.getDarkerColor(i)),this.innerGradient.setAlpha(.5),this.innerGradient.setScale(.9),this.rimLight=e.add.circle(0,0,a-2,this.getLighterColor(i)),this.rimLight.setAlpha(0),this.rimLight.setStrokeStyle(3,this.getLighterColor(i),.6),this.highlightSprite=e.add.ellipse(.35*-a,.4*-a,.75*a,.55*a,16777215,.3),this.secondaryHighlight=e.add.circle(.3*a,.35*-a,.25*a,16777215,.2),this.bubbleSprite.setStrokeStyle(3,this.getDarkerColor(i),1),this.add([this.shadowSprite,this.bubbleSprite,this.innerGradient,this.rimLight,this.highlightSprite,this.secondaryHighlight]),this.setSize(w.SIZE,w.SIZE),this.setDepth(k),e.add.existing(this)}addIdleAnimation(){this.highlightSprite,0}setGridPosition(e){this.gridPosition=e}getGridPosition(){return this.gridPosition}setShooter(e){this.shooter=e}getShooter(){return this.shooter}getColor(){return this.color}setColor(e){this.color=e,this.bubbleSprite.setFillStyle(e),this.bubbleSprite.setStrokeStyle(2,this.getDarkerColor(e),1),this.innerGradient&&this.innerGradient.setFillStyle(this.getDarkerColor(e)),this.rimLight&&this.rimLight.setStrokeStyle(2,this.getLighterColor(e),.5)}setTint(e){this.bubbleSprite.setFillStyle(e)}clearTint(){this.bubbleSprite.setFillStyle(this.color)}setSpecial(e){this.isSpecial=e,e?this.addGlow():this.removeGlow()}getIsSpecial(){return this.isSpecial}addGlow(){const e=this.scene.add.circle(0,0,w.SIZE/2+7.5,this.color,.4);e.setStrokeStyle(2,this.getLighterColor(this.color),.6),this.addAt(e,0),this.scene.tweens.add({targets:e,alpha:{from:.2,to:.5},duration:800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}removeGlow(){if(this.length>6){const e=this.getAt(0);this.scene.tweens.killTweensOf(e),this.removeAt(0),e.destroy()}}getDarkerColor(e){const t=e>>16&255,s=e>>8&255,i=255&e;return Math.floor(.5*t)<<16|Math.floor(.5*s)<<8|Math.floor(.5*i)}getLighterColor(e){const t=e>>16&255,s=e>>8&255,i=255&e;return Math.min(255,Math.floor(1.3*t+50))<<16|Math.min(255,Math.floor(1.3*s+50))<<8|Math.min(255,Math.floor(1.3*i+50))}addColorblindPattern(e){if(!this.patternSprite)return;this.patternSprite.clear(),this.patternSprite.lineStyle(2.5,16777215,.4);const t=w.SIZE/2;switch(e){case b.RED:for(let e=5-t;e<t;e+=7.5){const s=.8*Math.sqrt(t*t-e*e);this.patternSprite.lineBetween(-s,e,s,e)}break;case b.BLUE:for(let e=5-t;e<t;e+=7.5){const s=.8*Math.sqrt(t*t-e*e);this.patternSprite.lineBetween(e,-s,e,s)}break;case b.GREEN:for(let e=-t;e<t;e+=7.5){const s=Math.max(.7*-t,e-.7*t),i=Math.max(.7*-t,-e-.7*t),a=Math.min(.7*t,e+.7*t),n=Math.min(.7*t,.7*t-e);this.patternSprite.lineBetween(s,i,a,n)}break;case b.YELLOW:for(let e=7.5-t;e<t;e+=10)for(let s=7.5-t;s<t;s+=10)e*e+s*s<t*t*.7&&(this.patternSprite.fillStyle(16777215,.5),this.patternSprite.fillCircle(e,s,2.5));break;case b.PURPLE:for(let e=-t;e<t;e+=7.5){const s=Math.max(.7*-t,e-.7*t),i=Math.max(.7*-t,-e-.7*t),a=Math.min(.7*t,e+.7*t),n=Math.min(.7*t,.7*t-e);this.patternSprite.lineBetween(s,i,a,n),this.patternSprite.lineBetween(s,-i,a,-n)}}}pop(){this.idleAnimation&&this.idleAnimation.stop(),this.scene.tweens.add({targets:this,scaleX:1.3,scaleY:1.3,alpha:0,duration:w.ANIMATION_DURATION,ease:"Back.easeOut",onComplete:()=>{this.setVisible(!1),this.returnToPool()}}),this.scene.tweens.add({targets:this,angle:Phaser.Math.Between(-45,45),duration:w.ANIMATION_DURATION,ease:"Power2"}),this.createPopParticles()}createPopParticles(){const e=[this.color,this.getLighterColor(this.color),16777215];for(let i=0;i<8;i++){const t=Phaser.Math.Between(2,6),s=i%e.length,a=this.scene.add.circle(this.x,this.y,t,e[s],1),n=2*Math.PI*i/8+.3*(Math.random()-.5),r=Phaser.Math.Between(50,150),o=Phaser.Math.Between(-360,360);this.scene.tweens.add({targets:a,x:this.x+Math.cos(n)*r,y:this.y+Math.sin(n)*r+Phaser.Math.Between(-10,30),scale:0,alpha:0,angle:o,duration:400+100*Math.random(),ease:"Expo.easeOut",onComplete:()=>{a.destroy()}})}const t=this.scene.add.circle(this.x,this.y,w.SIZE/2,16777215,.4);this.scene.tweens.add({targets:t,scale:2,alpha:0,duration:250,ease:"Power2",onComplete:()=>{t.destroy()}});const s=this.scene.add.circle(this.x,this.y,w.SIZE/2,this.color,0);s.setStrokeStyle(3,this.color,.8),this.scene.tweens.add({targets:s,scale:2.5,alpha:0,duration:300,ease:"Power2",onComplete:()=>{s.destroy()}})}reset(e,t,s){this.setPosition(e,t),this.setAlpha(1),this.setScale(1),this.setVisible(!0),this.gridPosition=null,this.isSpecial=!1,this.pooled=!1,void 0!==s&&this.setColor(s)}returnToPool(){this.pooled=!0,this.setVisible(!1),this.gridPosition=null,this.setPosition(0,0),this.setScale(1),this.setAlpha(1),this.setAngle(0),this.clearTint()}isPooled(){return this.pooled}static getRandomColor(){const e=[b.RED,b.BLUE,b.GREEN,b.YELLOW,b.PURPLE];return e[Math.floor(Math.random()*e.length)]}}var _=(e=>(e.BUBBLE_MATCH="bubble_match",e.ORPHAN_DROP="orphan_drop",e.POWER_UP="power_up",e.CHAIN_COMBO="chain_combo",e.SPECIAL_BONUS="special_bonus",e.OBJECTIVE_HIT="objective_hit",e.TIME_BONUS="time_bonus",e.PERFECT_SHOT="perfect_shot",e))(_||{});class z{scene;modules=new Map;eventQueue=[];processing=!1;totalPlayerScore=0;totalOpponentScore=0;MAX_QUEUE_SIZE=50;PROCESS_INTERVAL=16;scoreUpdateCallbacks=[];visualEffectCallbacks=[];constructor(e){this.scene=e,this.initializeDefaultModules(),this.startProcessing()}initializeDefaultModules(){this.registerModule(new j),this.registerModule(new V),this.registerModule(new q)}registerModule(e){this.modules.has(e.type)||this.modules.set(e.type,[]);const t=this.modules.get(e.type);t.push(e),t.sort((e,t)=>t.priority-e.priority)}queueEvent(e){this.eventQueue.push({context:e,timestamp:Date.now(),processed:!1}),this.eventQueue.length>this.MAX_QUEUE_SIZE&&this.eventQueue.shift()}startProcessing(){this.scene.time.addEvent({delay:this.PROCESS_INTERVAL,callback:this.processQueue,callbackScope:this,loop:!0})}processQueue(){if(this.processing||0===this.eventQueue.length)return;this.processing=!0;const e=Math.min(5,this.eventQueue.length);for(let t=0;t<e;t++){const e=this.eventQueue.shift();e&&!e.processed&&this.processEvent(e)}this.processing=!1}processEvent(e){const{context:t}=e,s=this.modules.get(t.type)||[];let i=null;for(const a of s)if(a.canProcess(t)){const e=a.calculateScore(t);i?(i.finalScore+=e.finalScore,i.visualEffectLevel=Math.max(i.visualEffectLevel,e.visualEffectLevel)):i=e}i&&(t.isPlayer?(this.totalPlayerScore+=i.finalScore,this.notifyScoreUpdate(this.totalPlayerScore,!0)):(this.totalOpponentScore+=i.finalScore,this.notifyScoreUpdate(this.totalOpponentScore,!1)),this.notifyVisualEffect(i,t.position),this.scene.events.emit("score-calculated",{context:t,result:i})),e.processed=!0}onScoreUpdate(e){this.scoreUpdateCallbacks.push(e)}onVisualEffect(e){this.visualEffectCallbacks.push(e)}notifyScoreUpdate(e,t){this.scoreUpdateCallbacks.forEach(s=>s(e,t))}notifyVisualEffect(e,t){this.visualEffectCallbacks.forEach(s=>s(e,t))}getPlayerScore(){return this.totalPlayerScore}getOpponentScore(){return this.totalOpponentScore}reset(){this.totalPlayerScore=0,this.totalOpponentScore=0,this.eventQueue=[],this.processing=!1}destroy(){this.reset(),this.modules.clear(),this.scoreUpdateCallbacks=[],this.visualEffectCallbacks=[]}}class j{type="bubble_match";priority=100;BASE_POINTS={3:10,4:20,5:30,6:40,7:50};canProcess(e){return e.type===this.type&&(e.matchSize??0)>=3}calculateScore(e){const t=e.matchSize??3,s=this.BASE_POINTS[Math.min(t,7)]||this.BASE_POINTS[7];let i=1,a=`+${s}`,n=1;if(t>=7){i=2;a=`PERFECT!\n+${Math.floor(s*i)}`,n=5}else if(t>=6){i=1.8;a=`AMAZING!\n+${Math.floor(s*i)}`,n=4}else if(t>=5){i=1.5;a=`GREAT!\n+${Math.floor(s*i)}`,n=3}else if(t>=4){i=1.2;a=`GOOD!\n+${Math.floor(s*i)}`,n=2}return{finalScore:Math.floor(s*i),displayText:a,visualEffectLevel:n,color:e.bubbleColor||16766720,comboMultiplier:i}}}class V{type="orphan_drop";priority=90;canProcess(e){return e.type===this.type}calculateScore(e){const t=e.metadata?.dropCount||1,s=5*t;let i="";return i=t<=3?`DROP!\n+${s}`:t<=6?`NICE DROP!\n+${s}`:`MEGA DROP!\n+${s}`,{finalScore:s,displayText:i,visualEffectLevel:Math.min(Math.ceil(t/3),3),color:49151,comboMultiplier:1}}}class q{type="chain_combo";priority=80;chainCount=0;lastChainTime=0;CHAIN_TIMEOUT=2e3;canProcess(e){if("bubble_match"!==e.type)return!1;const t=Date.now(),s=t-this.lastChainTime<this.CHAIN_TIMEOUT;return s?this.chainCount++:this.chainCount=0,this.lastChainTime=t,s&&this.chainCount>1}calculateScore(e){return{finalScore:10*this.chainCount,displayText:`CHAIN x${this.chainCount}`,visualEffectLevel:Math.min(this.chainCount,4),color:16738740,comboMultiplier:1+.1*this.chainCount}}}var H=(e=>(e.BOMB="bomb",e.LASER="laser",e.RAINBOW="rainbow",e.MULTIPLIER="multiplier",e.FREEZE="freeze",e.LIGHTNING="lightning",e.MAGNET="magnet",e.SHIELD="shield",e))(H||{});class Y extends U{powerUpIcon;currentPowerUp;powerUpCycleTimer;glowEffect;iconBg;powerUpSequence=[H.RAINBOW,H.BOMB,H.LIGHTNING,H.FREEZE,H.LASER,H.MULTIPLIER];sequenceIndex=0;powerUpIcons={[H.RAINBOW]:{icon:"🌈",color:16738740},[H.BOMB]:{icon:"💣",color:16729344},[H.LIGHTNING]:{icon:"⚡",color:16766720},[H.FREEZE]:{icon:"❄️",color:52945},[H.LASER]:{icon:"🎯",color:65280},[H.MULTIPLIER]:{icon:"✨",color:9662683},[H.SHIELD]:{icon:"🛡️",color:4286945},[H.MAGNET]:{icon:"🧲",color:14423100}};constructor(e,t,s){super(e,t,s,U.getRandomColor()),this.sequenceIndex=Math.floor(Math.random()*this.powerUpSequence.length),this.currentPowerUp=this.powerUpSequence[this.sequenceIndex],this.createMysteryVisuals(),this.startPowerUpCycle()}createMysteryVisuals(){const e=this.list[0];e&&e.setAlpha(.4),this.glowEffect=this.scene.add.graphics(),this.updateGlowEffect(),this.addAt(this.glowEffect,0),this.iconBg=this.scene.add.graphics(),this.iconBg.fillStyle(0,.3),this.iconBg.fillCircle(0,0,25),this.add(this.iconBg),this.powerUpIcon=this.scene.add.text(0,0,"",{fontSize:"35px",fontFamily:"Arial"}),this.powerUpIcon.setOrigin(.5),this.add(this.powerUpIcon),this.updatePowerUpDisplay(),this.scene.tweens.add({targets:[this.powerUpIcon,this.iconBg],scale:{from:.9,to:1.1},duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}updateGlowEffect(){if(!this.glowEffect)return;this.glowEffect.clear();const e=this.powerUpIcons[this.currentPowerUp];this.glowEffect.fillStyle(e.color,.2),this.glowEffect.fillCircle(0,0,35),this.glowEffect.fillStyle(e.color,.1),this.glowEffect.fillCircle(0,0,45)}updatePowerUpDisplay(){const e=this.powerUpIcons[this.currentPowerUp];this.powerUpIcon.setText(e.icon),this.updateGlowEffect(),this.scene.tweens.add({targets:this.powerUpIcon,scale:{from:1.3,to:1},duration:300,ease:"Back.easeOut"})}startPowerUpCycle(){const e=()=>{this.cyclePowerUp(),this.powerUpCycleTimer=this.scene.time.delayedCall(Phaser.Math.Between(2e3,3e3),e)};this.powerUpCycleTimer=this.scene.time.delayedCall(Phaser.Math.Between(2e3,3e3),e)}cyclePowerUp(){this.sequenceIndex=(this.sequenceIndex+1)%this.powerUpSequence.length,this.currentPowerUp=this.powerUpSequence[this.sequenceIndex]||H.RAINBOW,this.updatePowerUpDisplay()}getCurrentPowerUp(){return this.currentPowerUp}isMysteryBubble(){return!0}collectPowerUp(e=!0){const t=this.powerUpIcons[this.currentPowerUp],s=this.scene.add.text(this.x,this.y,t.icon,{fontSize:"60px",fontFamily:"Arial"});s.setOrigin(.5),s.setDepth(F);const i=this.scene.add.text(this.x,this.y+37.5,"POWER-UP!",{fontSize:"30px",fontFamily:"Arial Black",color:"#FFFFFF",stroke:"#000000",strokeThickness:5});i.setOrigin(.5),i.setDepth(F),this.scene.tweens.add({targets:[s,i],y:this.y-62.5,alpha:0,scale:1.5,duration:1e3,ease:"Cubic.easeOut",onComplete:()=>{s.destroy(),i.destroy()}});const a=this.scene.add.circle(this.x,this.y,37.5,t.color,.5);a.setDepth(F-1),this.scene.tweens.add({targets:a,scale:2,alpha:0,duration:400,ease:"Cubic.easeOut",onComplete:()=>{a.destroy()}});const n=e?"player":"opponent";this.scene.events.emit("power-up-collected",{type:this.currentPowerUp,x:this.x,y:this.y,owner:n})}destroy(){this.powerUpCycleTimer&&this.powerUpCycleTimer.destroy(),super.destroy()}}class W extends Phaser.GameObjects.Container{launcherPlatform;bubbleChamber;queuePanel;effectsLayer;platformGraphics;chamberGraphics;queueBackground;queueLabel;glowEffect;stateIndicator;readyIndicator;queueContainer;nextBubbleFrame;nextBubbleGraphics;secondBubbleGraphics;arsenalSlots=[];weaponRing;energyConduits;activePowerUp;arsenalContainer;idleAnimation;chargingTween;particles;zone;currentAngle=0;loadedBubble;nextBubbleColors=[];currentTheme;isAiming=!1;isOpponent;launcherState="idle";powerLevel=0;BUBBLE_POSITION_Y;QUEUE_POSITION_Y;ARSENAL_POSITIONS_PLAYER=[{x:175,y:-87.5},{x:275,y:-87.5},{x:375,y:-87.5}];ARSENAL_POSITIONS_OPPONENT=[{x:-175,y:-87.5},{x:-275,y:-87.5},{x:-375,y:-87.5}];SLOT_SIZE=62.5;powerUpIcons={[H.RAINBOW]:"🌈",[H.BOMB]:"💣",[H.LIGHTNING]:"⚡",[H.FREEZE]:"❄️",[H.LASER]:"🎯",[H.MULTIPLIER]:"✨",[H.SHIELD]:"🛡️",[H.MAGNET]:"🧲"};constructor(e,t,s,i){super(e,t,s),this.zone=i,this.isOpponent=i===f.OPPONENT,this.BUBBLE_POSITION_Y=-70,this.QUEUE_POSITION_Y=62.5,this.isOpponent?(this.currentAngle=90,this.setScale(1,-1)):this.currentAngle=270,this.createExceptionalLauncher(),this.createIntegratedArsenal(),this.setDepth(D),e.add.existing(this),this.updateTheme(b.BLUE),this.startEnhancedIdleAnimations(),this.setupArsenalListeners(),this.setupMobileTouchArea()}createExceptionalLauncher(){this.createLauncherPlatform(),this.createBubbleChamber(),this.createEnhancedQueueSystem(),this.createStateIndicators(),this.createEffectsLayer(),this.add([this.launcherPlatform,this.bubbleChamber,this.queueContainer,this.effectsLayer])}createLauncherPlatform(){this.launcherPlatform=this.scene.add.container(0,0),this.platformGraphics=this.scene.add.graphics(),this.launcherPlatform.add(this.platformGraphics)}createBubbleChamber(){this.bubbleChamber=this.scene.add.container(0,this.BUBBLE_POSITION_Y),this.chamberGraphics=this.scene.add.graphics(),this.glowEffect=this.scene.add.graphics(),this.bubbleChamber.add([this.glowEffect,this.chamberGraphics])}createEnhancedQueueSystem(){this.queueContainer=this.scene.add.container(0,this.QUEUE_POSITION_Y),this.queueBackground=this.scene.add.graphics(),this.nextBubbleFrame=this.scene.add.graphics(),this.queueContainer.add([this.queueBackground,this.nextBubbleFrame])}createStateIndicators(){this.stateIndicator=this.scene.add.graphics(),this.add(this.stateIndicator),this.readyIndicator=this.scene.add.circle(0,this.BUBBLE_POSITION_Y,70,0,0),this.readyIndicator.setStrokeStyle(5,0,0),this.readyIndicator.setVisible(!1),this.add(this.readyIndicator)}createEffectsLayer(){this.effectsLayer=this.scene.add.container(0,0)}updateAllVisuals(){this.renderLauncherPlatform(),this.renderBubbleChamber(),this.renderEnhancedQueue(),this.renderStateIndicators(),this.renderGlowEffects()}renderLauncherPlatform(){if(!this.platformGraphics||!this.currentTheme)return;this.platformGraphics.clear();const e=this.BUBBLE_POSITION_Y,t=this.QUEUE_POSITION_Y,s=Math.abs(t-e),i=60;this.platformGraphics.fillGradientStyle(this.currentTheme.platform.top,this.currentTheme.platform.top,this.currentTheme.platform.bottom,this.currentTheme.platform.bottom,1,1,.7,.7),this.platformGraphics.fillRoundedRect(-30,e+35,i,s-55,20),this.platformGraphics.lineStyle(2.5,this.currentTheme.chamber.highlight,.3),this.platformGraphics.lineBetween(-20,e+50,-20,t-25),this.platformGraphics.lineBetween(20,e+50,20,t-25),this.platformGraphics.lineStyle(2.5,this.currentTheme.platform.rim,.3),this.platformGraphics.strokeRoundedRect(-30,e+35,i,s-55,20)}renderBubbleChamber(){if(!this.chamberGraphics||!this.currentTheme)return;this.chamberGraphics.clear();this.chamberGraphics.fillGradientStyle(this.currentTheme.chamber.outerTop,this.currentTheme.chamber.outerTop,this.currentTheme.chamber.outerBottom,this.currentTheme.chamber.outerBottom,1,1,.9,.9),this.chamberGraphics.fillCircle(0,0,60),this.chamberGraphics.lineStyle(7.5,this.currentTheme.chamber.rim,1),this.chamberGraphics.strokeCircle(0,0,60),this.chamberGraphics.fillStyle(657930,.9),this.chamberGraphics.fillCircle(0,0,40),this.chamberGraphics.lineStyle(5,this.currentTheme.chamber.innerRim,.8),this.chamberGraphics.strokeCircle(0,0,40),this.chamberGraphics.lineStyle(2.5,this.currentTheme.chamber.highlight,.5),this.chamberGraphics.strokeCircle(0,0,47.5),this.chamberGraphics.fillStyle(this.currentTheme.chamber.highlight,.4),this.chamberGraphics.fillCircle(-12.5,-12.5,7.5)}renderEnhancedQueue(){if(!this.queueBackground||!this.currentTheme)return;this.queueBackground.clear();this.queueBackground.fillGradientStyle(this.currentTheme.chamber.outerTop,this.currentTheme.chamber.outerTop,this.currentTheme.chamber.outerBottom,this.currentTheme.chamber.outerBottom,.8,.8,.6,.6),this.queueBackground.fillCircle(0,0,50),this.queueBackground.lineStyle(6.25,this.currentTheme.chamber.rim,.8),this.queueBackground.strokeCircle(0,0,50),this.queueBackground.fillStyle(657930,.7),this.queueBackground.fillCircle(0,0,35),this.queueBackground.lineStyle(3.75,this.currentTheme.chamber.innerRim,.6),this.queueBackground.strokeCircle(0,0,35),this.queueBackground.lineStyle(2.5,this.currentTheme.chamber.highlight,.4),this.queueBackground.strokeCircle(0,0,40),this.queueBackground.fillStyle(this.currentTheme.chamber.highlight,.3),this.queueBackground.fillCircle(-10,-10,5),this.renderEnhancedQueueBubbles()}renderStateIndicators(){if(this.readyIndicator)if(this.currentTheme)switch(this.launcherState){case"ready":this.readyIndicator.setVisible(!0),this.readyIndicator.setStrokeStyle(2,this.currentTheme.platform.rim,.8);break;case"aiming":this.readyIndicator.setVisible(!0),this.readyIndicator.setStrokeStyle(2,this.currentTheme.glow.aiming,.6);break;case"charging":this.readyIndicator.setVisible(!0),this.readyIndicator.setStrokeStyle(3,this.currentTheme.glow.pulse,.9);break;default:this.readyIndicator.setVisible(!1)}else this.readyIndicator.setVisible(!1)}renderEnhancedQueueBubbles(){this.queueBackground&&this.queueContainer&&(this.nextBubbleColors.length>0&&this.nextBubbleColors[0]&&this.createNextBubble(this.nextBubbleColors[0]),this.nextBubbleColors.length>1&&this.nextBubbleColors[1]&&this.createSecondBubble(this.nextBubbleColors[1]))}createNextBubble(e){if(!this.queueContainer)return;this.nextBubbleGraphics&&(this.nextBubbleGraphics.destroy(),this.nextBubbleGraphics=void 0);const t=this.scene.add.graphics();this.queueContainer.add(t),this.nextBubbleGraphics=t,t.x=0,t.y=0;this.drawQueueBubble(t,0,0,27.5,1,e),t.setScale(0),this.scene.tweens.add({targets:t,scale:1,rotation:2*Math.PI,duration:400,ease:"Back.easeOut"}),this.scene.tweens.add({targets:t,scale:{from:1,to:1.08},duration:1200,yoyo:!0,repeat:-1,ease:"Sine.InOut",delay:400})}createSecondBubble(e){if(!this.queueContainer)return;this.secondBubbleGraphics&&(this.secondBubbleGraphics.destroy(),this.secondBubbleGraphics=void 0);const t=this.scene.add.graphics();this.queueContainer.addAt(t,0),this.secondBubbleGraphics=t,t.x=22.5,t.y=17.5;this.drawQueueBubble(t,0,0,17.5,.7,e),t.setScale(0),this.scene.tweens.add({targets:t,scale:.65,duration:400,ease:"Back.easeOut"}),this.scene.tweens.add({targets:t,y:t.y-3.75,duration:2500,yoyo:!0,repeat:-1,ease:"Sine.InOut",delay:200})}resetQueueBubbles(){this.nextBubbleGraphics&&this.scene.tweens.add({targets:this.nextBubbleGraphics,alpha:0,scale:.5,duration:150,ease:"Power2.In",onComplete:()=>{this.nextBubbleGraphics?.destroy(),this.nextBubbleGraphics=void 0}}),this.secondBubbleGraphics&&this.scene.tweens.add({targets:this.secondBubbleGraphics,alpha:0,scale:.5,duration:150,ease:"Power2.In",onComplete:()=>{this.secondBubbleGraphics?.destroy(),this.secondBubbleGraphics=void 0}})}drawQueueBubble(e,t,s,i,a,n){const r=this.getBubbleColors(n);e.fillStyle(r.primary),e.fillCircle(t,s,i),e.lineStyle(5,r.dark,.9),e.strokeCircle(t,s,i),e.fillStyle(r.light),e.fillCircle(t-.3*i,s-.3*i,.35*i),e.fillStyle(r.accent,.4),e.fillCircle(t,s,.6*i),e.setAlpha(a)}drawSmallQueueBubble(e,t,s,i,a,n){this.drawQueueBubble(e,t,s,i,a,n)}renderGlowEffects(){this.glowEffect&&this.currentTheme&&(this.glowEffect.clear(),this.isAiming&&(this.glowEffect.fillStyle(this.currentTheme.glow.aiming,.3),this.glowEffect.fillCircle(0,0,75),this.glowEffect.fillStyle(this.currentTheme.glow.pulse,.1),this.glowEffect.fillCircle(0,0,87.5)),this.loadedBubble&&(this.glowEffect.fillStyle(this.currentTheme.glow.loaded,.2),this.glowEffect.fillCircle(0,0,62.5)))}getExceptionalTheme(e){const t=this.getBubbleColors(e);return{platform:{top:t.secondary,bottom:this.darkenColor(t.secondary,30),rim:t.primary,highlight:t.light,shadow:this.darkenColor(t.dark,20)},chamber:{outerTop:t.secondary,outerBottom:this.darkenColor(t.secondary,25),innerTop:this.darkenColor(t.dark,10),innerBottom:this.darkenColor(t.dark,40),rim:t.primary,innerRim:t.accent,highlight:t.light,depth:this.darkenColor(t.dark,30)},queue:{panelTop:2763306,panelBottom:1710618,panelBorder:t.primary,panelGlow:t.light},glow:{aiming:t.primary,pulse:t.light,loaded:t.accent}}}getBubbleColors(e){switch(e){case b.RED:return{primary:16729943,secondary:15221058,accent:16739194,dark:12131880,light:16751786};case b.BLUE:return{primary:3621626,secondary:3093826,accent:6189823,dark:1976133,light:9084159};case b.GREEN:return{primary:3069299,secondary:1810247,accent:6283397,dark:1338164,light:9366427};case b.YELLOW:return{primary:16765738,secondary:16758784,accent:16768589,dark:13405952,light:16771184};case b.PURPLE:return{primary:16711935,secondary:15073510,accent:16738047,dark:13369548,light:16751103};default:return{primary:54527,secondary:38860,accent:3399167,dark:27545,light:6743807}}}darkenColor(e,t){const s=(100-t)/100;return(e>>16&255)*s<<16|(e>>8&255)*s<<8|(255&e)*s}updateTheme(e){this.scaleY,this.currentTheme=this.getExceptionalTheme(e),this.updateAllVisuals(),this.isOpponent&&this.setScale(1,-1)}startEnhancedIdleAnimations(){this.idleAnimation=this.scene.tweens.add({targets:this.bubbleChamber,scaleX:{from:1,to:1.02},scaleY:{from:1,to:1.02},duration:2200,yoyo:!0,repeat:-1,ease:"Sine.InOut"}),this.queueContainer&&(this.scene.tweens.add({targets:this.queueContainer,alpha:{from:.85,to:1},duration:3e3,yoyo:!0,repeat:-1,ease:"Sine.InOut"}),this.scene.tweens.add({targets:this.queueContainer,scaleX:{from:1,to:1.01},scaleY:{from:1,to:1.01},duration:2e3,repeat:-1,yoyo:!0,ease:"Sine.InOut"})),this.readyIndicator&&this.scene.tweens.add({targets:this.readyIndicator,alpha:{from:.4,to:.8},duration:1800,yoyo:!0,repeat:-1,ease:"Sine.InOut",paused:!0})}setupMobileTouchArea(){const e=this.scene.add.rectangle(0,0,120,120,0,0);e.setInteractive({useHandCursor:!0}),this.addAt(e,0),e.on("pointerdown",e=>{this.scene.tweens.add({targets:this,scaleX:.92,scaleY:this.isOpponent?-.92:.92,duration:60,yoyo:!0,ease:"Power3.Out"});const t=this.scene.add.circle(0,0,30,16777215,.4);this.add(t),this.scene.tweens.add({targets:t,scale:{from:0,to:4},alpha:{from:.4,to:0},duration:500,ease:"Power2.Out",onComplete:()=>t.destroy()}),this.queueContainer&&this.scene.tweens.add({targets:this.queueContainer,scaleX:{from:1,to:1.05},scaleY:{from:1,to:1.05},duration:100,yoyo:!0,ease:"Power2.Out"})}),e.on("pointerover",()=>{this.setHighlight(!0)}),e.on("pointerout",()=>{this.setHighlight(!1)})}setAimAngle(e){this.currentAngle=e;let t=e;t=this.zone===f.PLAYER&&e>180?Phaser.Math.Clamp(e,195,345):Phaser.Math.Clamp(e,15,165),this.currentAngle=t}getAimAngle(){return this.currentAngle}getAimDirection(){const e=Phaser.Math.DegToRad(this.currentAngle);return new Phaser.Math.Vector2(Math.cos(e),Math.sin(e))}showAiming(e){this.isAiming=e,this.launcherState=e?"aiming":"idle",e?(this.chargingTween=this.scene.tweens.add({targets:this.bubbleChamber,scaleX:1.08,scaleY:1.08,duration:200,ease:"Power2.Out"}),this.scene.tweens.add({targets:this.bubbleChamber,alpha:{from:1,to:.9},duration:800,yoyo:!0,repeat:-1,ease:"Sine.InOut"})):(this.chargingTween&&this.chargingTween.stop(),this.bubbleChamber&&this.scene.tweens.killTweensOf(this.bubbleChamber),this.scene.tweens.add({targets:this.bubbleChamber,scaleX:1,scaleY:1,alpha:1,duration:300,ease:"Elastic.Out"})),this.renderStateIndicators(),this.renderGlowEffects()}animateShoot(e){this.launcherState="charging",this.createEnhancedLaunchEffects(e),this.animateEnhancedLaunch(),setTimeout(()=>{this.launcherState="idle",this.renderStateIndicators()},500)}setState(e){return this.launcherState=e,this.updateStateIndicator(),this.renderStateIndicators(),this}updateStateIndicator(){if(this.stateIndicator)switch(this.stateIndicator.clear(),this.launcherState){case"idle":this.stateIndicator.fillStyle(5025616,.2),this.stateIndicator.fillCircle(0,0,87.5);break;case"aiming":this.stateIndicator.lineStyle(10,16761095,.6),this.stateIndicator.strokeCircle(0,0,100),this.stateIndicator.lineBetween(-25,0,25,0),this.stateIndicator.lineBetween(0,-25,0,25);break;case"charging":const e=this.powerLevel<30?16733986:this.powerLevel<70?16750592:5025616;this.stateIndicator.fillStyle(e,.3+this.powerLevel/200),this.stateIndicator.fillCircle(0,0,75+this.powerLevel/10);break;case"ready":this.stateIndicator.fillStyle(48340,.4),this.stateIndicator.fillCircle(0,0,87.5),this.readyIndicator&&this.readyIndicator.setVisible(!0);break;case"cooldown":this.stateIndicator.fillStyle(10395294,.2),this.stateIndicator.fillCircle(0,0,75)}}startPowerCharge(){this.launcherState="charging",this.powerLevel=0,this.scene.tweens.add({targets:this,powerLevel:100,duration:1500,ease:"Power2.Out",onUpdate:()=>{this.renderPowerIndicator()}}),this.bubbleChamber&&this.scene.tweens.add({targets:this.bubbleChamber,scaleX:{from:1,to:1.15},scaleY:{from:1,to:1.15},duration:1500,ease:"Power2.Out"}),this.renderStateIndicators()}releasePowerCharge(){const e=this.powerLevel;return this.powerLevel=0,this.bubbleChamber&&this.scene.tweens.add({targets:this.bubbleChamber,scaleX:1,scaleY:1,duration:200,ease:"Power2.Out"}),e}renderPowerIndicator(){if(this.stateIndicator&&"charging"===this.launcherState&&this.readyIndicator){const e=this.powerLevel<30?16729156:this.powerLevel<70?16755200:65416,t=.3+this.powerLevel/100*.7;this.readyIndicator.setStrokeStyle(3,e,t),this.readyIndicator.setVisible(!0)}}setHighlight(e){const t=e?1:.95;this.scene.tweens.add({targets:this,alpha:t,duration:150,ease:"Power2.Out"}),this.bubbleChamber&&e?this.scene.tweens.add({targets:this.bubbleChamber,scaleX:1.03,scaleY:1.03,duration:150,ease:"Power2.Out"}):this.bubbleChamber&&this.scene.tweens.add({targets:this.bubbleChamber,scaleX:1,scaleY:1,duration:150,ease:"Power2.Out"})}loadBubble(e){this.loadedBubble&&(this.remove(this.loadedBubble),this.loadedBubble.destroy()),this.loadedBubble=new U(this.scene,0,this.BUBBLE_POSITION_Y,e),this.loadedBubble.setScale(1),this.add(this.loadedBubble),this.bringToTop(this.loadedBubble),this.updateTheme(e),this.readyIndicator&&this.currentTheme&&this.readyIndicator.setStrokeStyle(2,this.currentTheme.platform.rim,0),this.updateArsenalTheme(),this.loadedBubble.setScale(0),this.scene.tweens.add({targets:this.loadedBubble,scale:1,duration:450,ease:"Back.Out"}),this.scene.tweens.add({targets:this.loadedBubble,alpha:{from:.7,to:1},duration:600,ease:"Power2.InOut",delay:200}),this.launcherState="ready",this.isOpponent&&-1!==this.scaleY&&this.setScale(1,-1),this.renderStateIndicators(),this.scene.tweens.add({targets:this.bubbleChamber,scaleX:{from:1,to:1.12},scaleY:{from:1,to:1.12},duration:300,yoyo:!0,ease:"Back.Out"}),this.renderGlowEffects(),this.bubbleChamber&&this.scene.time.delayedCall(500,()=>{this.scene.tweens.add({targets:this.bubbleChamber,alpha:{from:1,to:.95},duration:300,ease:"Sine.InOut"})})}getLoadedBubble(){return this.loadedBubble}clearLoadedBubble(){this.loadedBubble&&this.remove(this.loadedBubble),this.loadedBubble=void 0,this.renderGlowEffects(),this.isOpponent&&-1!==this.scaleY&&this.setScale(1,-1)}updateQueueColors(e){this.nextBubbleColors=e,this.queueContainer&&(this.nextBubbleGraphics&&this.scene.tweens.add({targets:this.nextBubbleGraphics,alpha:0,scale:0,duration:150,onComplete:()=>{this.nextBubbleGraphics?.destroy(),this.nextBubbleGraphics=void 0}}),this.secondBubbleGraphics&&this.scene.tweens.add({targets:this.secondBubbleGraphics,alpha:0,scale:0,duration:150,onComplete:()=>{this.secondBubbleGraphics?.destroy(),this.secondBubbleGraphics=void 0}}),this.scene.time.delayedCall(200,()=>{e.length>0&&e[0]&&this.createNextBubble(e[0]),e.length>1&&e[1]&&this.scene.time.delayedCall(150,()=>{this.createSecondBubble(e[1])})}))}animateEnhancedLaunch(){const e=1+this.powerLevel/100*.5;if(this.bubbleChamber&&this.scene.tweens.add({targets:this.bubbleChamber,scaleX:1.15*e,scaleY:1.15*e,duration:200+this.powerLevel,yoyo:!0,ease:"Power3.Out"}),this.launcherPlatform){const t=2*e;this.scene.tweens.add({targets:this.launcherPlatform,x:-t,duration:175,yoyo:!0,ease:"Power2.Out"})}const t=3*e;this.scene.tweens.add({targets:this,y:this.y-(this.isOpponent?-t:t),duration:100,yoyo:!0,ease:"Power2.Out"}),this.powerLevel>70&&this.scene.cameras.main.shake(150,.01)}createEnhancedLaunchEffects(e){if(!e)return;const t=this.getBubbleColors(e),s=this.isOpponent?this.y+Math.abs(this.BUBBLE_POSITION_Y):this.y+this.BUBBLE_POSITION_Y,i=.8+this.powerLevel/100*.4,a=Math.floor(8+this.powerLevel/100*8),n=22*i,r=this.scene.add.circle(this.x,s,n,t.primary,.9);r.setBlendMode(Phaser.BlendModes.ADD),this.scene.tweens.add({targets:r,scale:{from:.5,to:2.2*i},alpha:{from:.9,to:0},duration:280+2*this.powerLevel,ease:"Power2.Out",onComplete:()=>r.destroy()});for(let o=0;o<a;o++){const e=2*Math.PI/a*o,n=(10+12*Math.random())*i,r=this.x+Math.cos(e)*n,h=s+Math.sin(e)*n,c=4.5*i,l=this.scene.add.circle(r,h,c,t.primary,.95);l.setBlendMode(Phaser.BlendModes.ADD),this.scene.tweens.add({targets:l,scale:{from:1.1,to:0},alpha:{from:.9,to:0},x:r+28*Math.cos(e)*i,y:h+28*Math.sin(e)*i,duration:450+3*this.powerLevel,delay:18*o,ease:"Power2.Out",onComplete:()=>l.destroy()})}if(this.powerLevel>50)for(let o=0;o<2;o++){const e=this.scene.add.circle(this.x,s,19+5*o,t.primary,0);e.setStrokeStyle(3.5-.5*o,t.primary,.9-.2*o),e.setBlendMode(Phaser.BlendModes.ADD),this.scene.tweens.add({targets:e,scale:{from:.6,to:(2.2+.3*o)*i},alpha:{from:.8,to:0},duration:380+100*o,delay:50*o,ease:"Power2.Out",onComplete:()=>e.destroy()})}else{const e=this.scene.add.circle(this.x,s,19,t.primary,0);e.setStrokeStyle(3.5,t.primary,.9),e.setBlendMode(Phaser.BlendModes.ADD),this.scene.tweens.add({targets:e,scale:{from:.6,to:2.2},alpha:{from:.8,to:0},duration:380,ease:"Power2.Out",onComplete:()=>e.destroy()})}}updateArsenalTheme(){this.arsenalSlots&&this.currentTheme&&this.arsenalSlots.forEach(e=>{e.background&&this.drawArsenalSlotBackground(e.background,e.isActive)})}createIntegratedArsenal(){this.arsenalContainer=this.scene.add.container(0,0),this.add(this.arsenalContainer),this.createArsenalChamber();(this.isOpponent?this.ARSENAL_POSITIONS_OPPONENT:this.ARSENAL_POSITIONS_PLAYER).forEach((e,t)=>{const s=this.createArsenalSlot(e,t);this.arsenalSlots.push(s),this.arsenalContainer&&this.arsenalContainer.add(s.container)}),this.arsenalContainer.setDepth(100)}createArsenalChamber(){if(!this.arsenalContainer||!this.currentTheme)return;const e=this.scene.add.graphics(),t=this.isOpponent?-175:175,s=this.isOpponent?-375:375,a=-87.5,n=100,r=Math.abs(s-t)+100,o=Math.min(t,s)-45;e.fillStyle(0,.5),e.fillRoundedRect(o-3,-140.5,r+6,106,37.5),e.fillGradientStyle(this.currentTheme.platform.base,this.currentTheme.platform.base,this.currentTheme.secondary,this.currentTheme.secondary,.7),e.fillRoundedRect(o,-137.5,r,n,30),e.fillStyle(this.currentTheme.chamber.inner,.4),e.fillRoundedRect(o+10,-127.5,r-20,80,25);for(let i=0;i<2;i++){const s=t+100*(i+.5)*(this.isOpponent?-1:1);e.fillStyle(this.currentTheme.platform.detail,.3),e.fillRect(s-20,-112.5,40,50),e.lineStyle(2.5,this.currentTheme.glow.pulse,.4),e.lineBetween(s-15,a,s+15,a)}e.lineStyle(7.5,this.currentTheme.platform.rim,1),e.strokeRoundedRect(o,-137.5,r,n,30),e.lineStyle(2.5,this.currentTheme.chamber.detail,.6),e.strokeRoundedRect(o+10,-127.5,r-20,80,25);const h=this.isOpponent?-87.5:87.5,c=t-(this.isOpponent?-18:18)*i,l=60;e.fillStyle(0,.3),e.fillRect(Math.min(h,c)-1,-118.5,Math.abs(c-h)+2,62),e.fillStyle(this.currentTheme.platform.base,.6),e.fillRect(Math.min(h,c),-117.5,Math.abs(c-h),l),e.fillStyle(this.currentTheme.chamber.inner,.3),e.fillRect(Math.min(h,c)+2,-115.5,Math.abs(c-h)-4,56),e.lineStyle(5,this.currentTheme.platform.rim,.9),e.lineBetween(h,-117.5,c,-117.5),e.lineBetween(h,-57.5,c,-57.5),e.lineStyle(2.5,this.currentTheme.glow.pulse,.5);for(let i=0;i<3;i++){const t=15*(i+1)-117.5;e.setLineDash([12.5,12.5]),e.lineBetween(h,t,c,t)}e.setLineDash([]),e.lineStyle(5,this.currentTheme.glow.loaded,.4),e.lineBetween(o,-112.5,o+25,-137.5),e.lineBetween(o+r-25,-137.5,o+r,-112.5),this.arsenalContainer.add(e),e.setDepth(-1)}createArsenalSlot(e,t){const s=this.scene.add.container(e.x,e.y);this.isOpponent&&s.setScale(1,-1);const i=this.scene.add.graphics();this.drawArsenalSlotBackground(i,!1);const a=this.scene.add.text(0,0,"",{fontSize:"35px",fontFamily:"Arial"});a.setOrigin(.5),a.setShadow(2,2,"#000000",2,!0,!0);const n=this.scene.add.text(this.SLOT_SIZE/2-2,this.SLOT_SIZE/2-2,"",{fontSize:"15px",fontFamily:"Arial Black",color:"#FFFFFF",stroke:"#000000",strokeThickness:5});n.setOrigin(1,1);if(!this.scene.game.device.input.touch){const e=this.createKeyHintBadge(t+1);e.setPosition(-this.SLOT_SIZE/2+6,-this.SLOT_SIZE/2+6),s.add(e)}if(s.add([i,a,n]),!this.isOpponent){const e=6;s.setInteractive(new Phaser.Geom.Rectangle(-this.SLOT_SIZE/2-e,-this.SLOT_SIZE/2-e,this.SLOT_SIZE+2*e,this.SLOT_SIZE+2*e),Phaser.Geom.Rectangle.Contains),s.on("pointerdown",()=>{this.activateArsenalSlot(t)}),s.on("pointerover",()=>{const e=this.isOpponent?-1:1;this.scene.tweens.add({targets:s,scaleX:1.1,scaleY:1.1*e,duration:200,ease:"Power2"})}),s.on("pointerout",()=>{const e=this.isOpponent?-1:1;this.scene.tweens.add({targets:s,scaleX:1,scaleY:1*e,duration:200,ease:"Power2"})})}return{container:s,background:i,icon:a,countText:n,position:e,powerUpType:void 0,count:0,isActive:!1}}drawArsenalSlotBackground(e,t){e.clear();const s=this.SLOT_SIZE/2;if(!this.currentTheme)return;const i={primary:this.currentTheme.primary,secondary:this.currentTheme.secondary,glow:this.currentTheme.glow.pulse,rim:this.currentTheme.platform.rim,detail:this.currentTheme.chamber.detail};e.fillStyle(0,.4),e.fillCircle(2,3,s+2),e.fillStyle(this.currentTheme.platform.base,.7),e.fillCircle(0,0,s+1),e.fillStyle(this.currentTheme.chamber.inner,.8),e.fillCircle(0,0,s-2),e.fillStyle(i.secondary,.2),e.fillCircle(0,0,s-12.5),e.lineStyle(1.25,i.detail,.3);for(let a=0;a<8;a++){const t=2*Math.PI*a/8,i=s-20,n=s-7.5;e.lineBetween(Math.cos(t)*i,Math.sin(t)*i,Math.cos(t)*n,Math.sin(t)*n)}e.lineStyle(5,t?16766720:i.rim,t?1:.8),e.strokeCircle(0,0,s),e.lineStyle(2.5,i.detail,.5),e.strokeCircle(0,0,s-7.5),e.lineStyle(2.5,i.rim,.3),e.strokeCircle(0,0,s-15),t&&(e.lineStyle(10,16766720,.2),e.strokeCircle(0,0,s+7.5),e.lineStyle(5,16766720,.4),e.strokeCircle(0,0,s+2.5),e.fillStyle(16777215,.1),e.fillCircle(0,0,s-17.5),e.lineStyle(2.5,16777215,.6),e.arc(0,0,s-10,.7*-Math.PI,.3*-Math.PI,!1),e.strokePath()),e.fillStyle(16777215,.15),e.fillEllipse(.3*-s,.4*-s,.6*s,.4*s)}createKeyHintBadge(e){const t=this.scene.add.container(0,0),s=this.currentTheme?.glow?.pulse||16766720,i=this.scene.add.circle(0,0,17.5,s,.9);i.setStrokeStyle(2.5,0,1);const a=this.scene.add.text(0,0,`${e}`,{fontSize:"15px",fontFamily:"Arial Black",color:"#000000"});return a.setOrigin(.5),t.add([i,a]),t}setupArsenalListeners(){this.scene.events.on("power-up-collected",e=>{(this.isOpponent?"opponent"===e.owner:"player"===e.owner)&&this.addPowerUpToArsenal(e.type)}),this.isOpponent||this.scene.game.device.input.touch||(this.scene.input.keyboard?.on("keydown-ONE",()=>this.activateArsenalSlot(0)),this.scene.input.keyboard?.on("keydown-TWO",()=>this.activateArsenalSlot(1)),this.scene.input.keyboard?.on("keydown-THREE",()=>this.activateArsenalSlot(2)))}addPowerUpToArsenal(e){let t=this.arsenalSlots.find(t=>t.powerUpType===e);t?(t.count++,t.countText.setText(t.count>1?`x${t.count}`:"")):(t=this.arsenalSlots.find(e=>!e.powerUpType),t&&(t.powerUpType=e,t.count=1,t.icon.setText(this.powerUpIcons[e]),this.showPowerUpCollectionEffect(t)))}activateArsenalSlot(e){const t=this.arsenalSlots[e];!t||!t.powerUpType||t.count<=0?t&&this.showEmptySlotFeedback(t):this.activatePowerUp(t)}activatePowerUp(e){e.powerUpType&&(this.showPowerUpActivation(e),this.activePowerUp=e.powerUpType,this.scene.events.emit("activate-power-up",{type:e.powerUpType}),e.count--,e.count<=0?(e.powerUpType=void 0,e.icon.setText(""),e.countText.setText(""),e.isActive=!1):e.countText.setText(e.count>1?`x${e.count}`:""),this.startSlotCooldown(e,2e3))}showPowerUpActivation(e){if(this.renderEnergyConduit(e),this.bubbleChamber){const e=this.isOpponent?-1:1;this.scene.tweens.add({targets:this.bubbleChamber,scaleX:{from:1,to:1.2,end:1},scaleY:{from:e,to:1.2*e,end:e},duration:300,ease:"Power2"})}const t=this.scene.add.graphics();t.fillStyle(16766720,.6),t.fillCircle(e.position.x,e.position.y,this.SLOT_SIZE/2),this.arsenalContainer?.add(t),this.scene.tweens.add({targets:t,scale:2,alpha:0,duration:400,ease:"Power2",onComplete:()=>t.destroy()})}renderEnergyConduit(e){if(!this.energyConduits)return;this.energyConduits.clear();const t=e.position.x,s=e.position.y,i=this.BUBBLE_POSITION_Y;this.energyConduits.lineStyle(15,16766720,.8),this.energyConduits.lineBetween(t,s,0,i);for(let a=0;a<5;a++){const e=a/4,n=t+(0-t)*e,r=s+(i-s)*e,o=this.scene.add.circle(n,r,5,16766720);this.arsenalContainer?.add(o),this.scene.tweens.add({targets:o,x:0,y:i,scale:0,duration:500,delay:50*a,ease:"Power2",onComplete:()=>o.destroy()})}this.scene.time.delayedCall(600,()=>{this.scene.tweens.add({targets:this.energyConduits,alpha:0,duration:200,onComplete:()=>{this.energyConduits?.clear(),this.energyConduits?.setAlpha(1)}})})}showPowerUpCollectionEffect(e){const t=this.isOpponent?-1:1;this.scene.tweens.add({targets:e.container,scaleX:{from:1.3,to:1},scaleY:{from:1.3*t,to:t},duration:300,ease:"Back.easeOut"});const s=this.scene.add.graphics();s.fillStyle(16766720,.5),s.fillCircle(e.position.x,e.position.y,this.SLOT_SIZE),this.arsenalContainer?.add(s),this.scene.tweens.add({targets:s,alpha:0,scale:2,duration:500,ease:"Cubic.easeOut",onComplete:()=>s.destroy()})}showEmptySlotFeedback(e){const t=this.scene.add.graphics();t.fillStyle(16711680,.3),t.fillCircle(0,0,this.SLOT_SIZE/2),e.container.add(t),this.scene.tweens.add({targets:t,alpha:0,duration:300,onComplete:()=>t.destroy()})}startSlotCooldown(e,t){const s=this.scene.add.graphics();s.fillStyle(0,.7),s.fillCircle(0,0,this.SLOT_SIZE/2),e.container.add(s);const i=this.scene.add.graphics();e.container.add(i),this.scene.tweens.add({targets:{progress:0},progress:1,duration:t,onUpdate:e=>{const t=e.getValue();i.clear(),i.lineStyle(15,5164484,.8),i.beginPath(),i.arc(0,0,this.SLOT_SIZE/2-5,-Math.PI/2,-Math.PI/2+2*Math.PI*t,!1),i.strokePath()},onComplete:()=>{s.destroy(),i.destroy(),this.drawArsenalSlotBackground(e.background,!1)}})}destroy(){this.arsenalSlots.forEach(e=>{this.scene.tweens.killTweensOf(e.container)}),this.idleAnimation&&this.idleAnimation.destroy(),this.chargingTween&&this.chargingTween.destroy(),this.scene.events.off("power-up-collected"),this.scene.events.off("activate-power-up"),super.destroy()}}class X extends Phaser.GameObjects.Container{chestBody;chestLid;chestLock;shield;glowEffect;health;maxHealth;shielded=!0;sparkleTimer;shimmerTimer;starBurstTimer;peekTimer;constructor(e,t){super(e,t.x,t.y),this.health=t.health,this.maxHealth=t.health;const s=e.add.circle(0,0,t.size/2+15,16766720,.15);this.add(s);const i=e.add.circle(0,0,t.size/2+8,16766720,.3);this.add(i),this.glowEffect=e.add.circle(0,0,t.size/2+4,16766720,.5),e.tweens.add({targets:[this.glowEffect,i,s],scale:{from:.9,to:1.15},alpha:{from:.4,to:.8},duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),e.tweens.add({targets:s,scale:{from:1,to:1.3},alpha:{from:.15,to:.05},duration:2500,yoyo:!0,repeat:-1,ease:"Quad.easeInOut"}),this.shield=e.add.circle(0,0,t.size/2+2,65535,0),this.shield.setVisible(!1),this.shielded=!1;const a=.7*t.size;this.chestBody=e.add.rectangle(0,3,a,.8*a,9127187),this.chestLid=e.add.rectangle(0,-5,1.1*a,.4*a,10506797),this.chestLock=e.add.circle(0,3,.15*a,16766720);const n=e.add.rectangle(.3*-a,3,2,.6*a,16766720),r=e.add.rectangle(.3*a,3,2,.6*a,16766720),o=e.add.rectangle(0,3,.8*a,2,16766720);this.add([this.glowEffect,this.shield,this.chestBody,n,r,o,this.chestLid,this.chestLock]),this.sparkleTimer=e.time.addEvent({delay:300,repeat:-1,callback:()=>{const s=Phaser.Math.Between(2,4);for(let i=0;i<s;i++){const s=Phaser.Math.Between(-t.size/2,t.size/2),a=e.add.circle(s,Phaser.Math.Between(-3,3),Phaser.Math.Between(2,4),Phaser.Utils.Array.GetRandom([16766720,16753920,16777130,16769333]),1);this.add(a),e.tweens.add({targets:a,y:1.2*-t.size,x:s+Phaser.Math.Between(-8,8),alpha:{from:1,to:0},scale:{from:1,to:.2},duration:1800,ease:"Cubic.easeOut",delay:100*i,onComplete:()=>a.destroy()})}}}),this.shimmerTimer=e.time.addEvent({delay:1500,repeat:-1,callback:()=>{const s=e.add.graphics();s.lineStyle(2,16777215,.8),s.strokeCircle(0,0,t.size/2),this.add(s),e.tweens.add({targets:s,scaleX:2,scaleY:2,alpha:0,duration:800,ease:"Quad.easeOut",onComplete:()=>s.destroy()})}}),this.starBurstTimer=e.time.addEvent({delay:3e3,repeat:-1,callback:()=>{for(let s=0;s<8;s++){const i=s/8*Math.PI*2,a=.4*t.size,n=e.add.star(Math.cos(i)*a,Math.sin(i)*a,4,3,6,16777215);n.setAlpha(.9),this.add(n),e.tweens.add({targets:n,x:Math.cos(i)*t.size*1.5,y:Math.sin(i)*t.size*1.5,alpha:0,scale:0,rotation:2*Math.PI,duration:1e3,ease:"Cubic.easeOut",delay:50*s,onComplete:()=>n.destroy()})}}}),this.setSize(t.size,t.size),this.setDepth(L),e.tweens.add({targets:this,scaleX:{from:.98,to:1.02},scaleY:{from:.98,to:1.02},duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),e.tweens.add({targets:this,y:t.y-4,duration:2500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),e.tweens.add({targets:this,angle:{from:-1.5,to:1.5},duration:3200,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),e.tweens.add({targets:this.chestLock,scale:{from:.8,to:1.3},alpha:{from:.7,to:1},duration:1200,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.peekTimer=e.time.addEvent({delay:8e3,repeat:-1,callback:()=>{e.tweens.add({targets:this.chestLid,y:this.chestLid.y-3,angle:-5,duration:300,yoyo:!0,ease:"Back.easeOut"})}});[n,r,o].forEach((t,s)=>{e.tweens.add({targets:t,alpha:{from:.6,to:1},duration:800,yoyo:!0,repeat:-1,delay:200*s,ease:"Quad.easeInOut"})}),e.add.existing(this)}setShielded(e){this.shielded=e,e?(this.shield.setVisible(!0),this.scene.tweens.add({targets:this.shield,alpha:.5,duration:300,ease:"Power2"})):this.scene.tweens.add({targets:this.shield,alpha:0,scale:1.5,duration:500,ease:"Power2",onComplete:()=>{this.shield.setVisible(!1),this.showVulnerable()}})}showVulnerable(){this.scene.tweens.add({targets:this.glowEffect,scale:1.3,alpha:.8,duration:300,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.chestBody.setFillStyle(16739179),this.chestLid.setFillStyle(16746632)}hit(e=1){this.health-=e,this.scene.events.emit("objective-hit"),this.scene.tweens.add({targets:this,scaleX:.9,scaleY:.9,duration:100,yoyo:!0,ease:"Power2"});const t=this.scene.add.circle(this.x,this.y,50,16777215,.8);this.scene.tweens.add({targets:t,scale:2,alpha:0,duration:300,onComplete:()=>t.destroy()}),this.health<=0&&this.destroy()}destroy(){this.sparkleTimer&&(this.sparkleTimer.destroy(),this.sparkleTimer=void 0),this.shimmerTimer&&(this.shimmerTimer.destroy(),this.shimmerTimer=void 0),this.starBurstTimer&&(this.starBurstTimer.destroy(),this.starBurstTimer=void 0),this.peekTimer&&(this.peekTimer.destroy(),this.peekTimer=void 0),this.scene.tweens.add({targets:this.chestLid,y:-15,rotation:-.3,duration:500,ease:"Back.easeOut"}),this.scene.tweens.add({targets:this,scale:1.5,alpha:0,duration:1e3,delay:200,ease:"Power2",onComplete:()=>{this.createVictoryParticles(),super.destroy()}})}createVictoryParticles(){for(let e=0;e<20;e++){const e=this.scene.add.circle(this.x,this.y,Phaser.Math.Between(3,6),Phaser.Utils.Array.GetRandom([16766720,16753920,16737095]),1),t=Math.random()*Math.PI*2,s=Phaser.Math.Between(100,300),i=Math.cos(t)*s,a=Math.sin(t)*s;this.scene.tweens.add({targets:e,x:e.x+i,y:e.y+a,alpha:0,scale:0,duration:1e3,ease:"Power2",onComplete:()=>e.destroy()})}}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}isVulnerable(){return!this.shielded}isShielded(){return this.shielded}playVictoryAnimation(e){this.scene.tweens.killTweensOf(this.chestLid),this.scene.tweens.killTweensOf(this.glowEffect),this.shield.setVisible(!1),this.glowEffect instanceof Phaser.GameObjects.Arc&&this.glowEffect.setFillStyle(16766720,1),this.scene.tweens.add({targets:this.glowEffect,scale:2,alpha:1,duration:300,ease:"Power2"}),this.scene.tweens.add({targets:this.chestLid,y:-20,angle:-45,duration:500,ease:"Back.easeOut",delay:200});const t=this.scene.time.addEvent({delay:50,repeat:20,callback:()=>{for(let e=0;e<5;e++){const e=this.scene.add.circle(this.x+Phaser.Math.Between(-10,10),this.y,Phaser.Math.Between(4,8),Phaser.Utils.Array.GetRandom([16766720,16753920,16776960]),.8);e.setDepth(this.depth+1);const t=Phaser.Math.Between(-120,-60)*Math.PI/180,s=Phaser.Math.Between(100,300),i=Math.cos(t)*s,a=Math.sin(t)*s;this.scene.tweens.add({targets:e,x:e.x+i,y:e.y+a-200,alpha:0,scale:0,duration:1500,ease:"Power2",onComplete:()=>e.destroy()})}}});this.scene.cameras.main.shake(300,.01),this.scene.tweens.add({targets:this,scale:1.2,duration:300,yoyo:!0,ease:"Power2",onComplete:()=>{e&&e(),this.scene.time.delayedCall(1e3,()=>{t.destroy()})}}),this.scene.cameras.main.flash(500,255,215,0)}}class Z{scene;pointer;currentPosition;sensitivity=.5;isEnabled=!0;constructor(e){this.scene=e,this.currentPosition={x:0,y:0,isActive:!1},this.setupInput()}setupInput(){this.pointer=this.scene.input.activePointer,this.scene.input.on("pointermove",this.onPointerMove,this),this.scene.input.on("pointerdown",this.onPointerDown,this),this.scene.input.on("pointerup",this.onPointerUp,this)}onPointerMove(e){if(this.isEnabled)if(0===this.currentPosition.x&&0===this.currentPosition.y)this.currentPosition.x=e.x,this.currentPosition.y=e.y;else{const t=e.x,s=e.y;this.currentPosition.x+=(t-this.currentPosition.x)*this.sensitivity,this.currentPosition.y+=(s-this.currentPosition.y)*this.sensitivity}}onPointerDown(e){this.isEnabled&&(this.currentPosition.isActive=!0)}onPointerUp(e){this.currentPosition.isActive=!1}getPosition(){return this.currentPosition}getPointerPosition(){return{x:this.currentPosition.x,y:this.currentPosition.y}}getAngleFrom(t,s){const i=this.currentPosition.x-t,a=this.currentPosition.y-s;let n=Math.atan2(a,i),r=e.Math.RadToDeg(n);return r<0&&(r+=360),r}getAngleFromWithConstraints(t,s,i=15,a=165){let n=this.getAngleFrom(t,s);const r=180+i,o=360-i;return n=n>=0&&n<=180?n<90?o:r:e.Math.Clamp(n,r,o),n}setEnabled(e){this.isEnabled=e}isPointerActive(){return this.currentPosition.isActive}setSensitivity(t){this.sensitivity=e.Math.Clamp(t,.1,1)}update(){!this.currentPosition.isActive&&this.pointer&&(this.currentPosition.x=this.pointer.x,this.currentPosition.y=this.pointer.y)}destroy(){this.scene.input.off("pointermove",this.onPointerMove,this),this.scene.input.off("pointerdown",this.onPointerDown,this),this.scene.input.off("pointerup",this.onPointerUp,this)}}class ${scene;launcher;dots=[];dotPool=[];currentBubbleColor=16777215;DOT_COUNT=22;DOT_SIZE=10;DOT_SPACING=62.5;PREVIEW_PERCENTAGE=.45;MAX_PREVIEW_DISTANCE=1375;SHOOT_SPEED=1500;animationTime=0;isVisible=!1;bounds;constructor(t,s){this.scene=t,this.launcher=s,this.bounds=new e.Geom.Rectangle(0,0,t.cameras.main.width,t.cameras.main.height),this.createDotPool()}createDotPool(){for(let e=0;e<this.DOT_COUNT;e++){const e=this.scene.add.circle(0,0,this.DOT_SIZE,16777215,0);e.setDepth(G-1),e.setVisible(!1),this.dotPool.push(e)}}show(e,t){this.isVisible||(this.isVisible=!0,void 0!==t&&(this.currentBubbleColor=t),this.calculateTrajectory(e))}hide(){this.isVisible=!1,this.dots.forEach(({dot:e})=>{e.setVisible(!1),e.setAlpha(0)}),this.dots=[]}calculateTrajectory(t){this.hide(),this.isVisible=!0;let s=this.launcher.x,i=this.launcher.y-87.5;const a=e.Math.DegToRad(t);let n=Math.cos(a)*this.SHOOT_SPEED,r=Math.sin(a)*this.SHOOT_SPEED;const o=Math.sqrt(n*n+r*r);n=n/o*this.DOT_SPACING,r=r/o*this.DOT_SPACING;const h=Math.floor(this.DOT_COUNT*this.PREVIEW_PERCENTAGE);let c=0,l=0;for(;c<h&&l<this.MAX_PREVIEW_DISTANCE;){s+=n,i+=r,l+=this.DOT_SPACING;const e=16;if(s-e<=this.bounds.left&&(s=this.bounds.left+e,n=Math.abs(n)),s+e>=this.bounds.right&&(s=this.bounds.right-e,n=-Math.abs(n)),i-e<=this.bounds.top)break;if(c<this.dotPool.length){const e=this.dotPool[c];e.setPosition(s,i),e.setVisible(!0);const t=.3,a=.95*(1-(t+(.8-t)*(c/h)));this.dots.push({dot:e,targetAlpha:a}),c++}}}update(t,s,i){if(!this.isVisible)return;void 0!==i&&(this.currentBubbleColor=i),this.calculateTrajectory(t),this.animationTime+=s;this.dots.forEach(({dot:t,targetAlpha:s},i)=>{const a=.15*i,n=Math.sin(.003*this.animationTime+a),r=s*(.75+.25*n),o=1+.2*n;t.setScale(o),t.setAlpha(r);const h=i/this.dots.length,c=e.Display.Color.IntegerToColor(this.currentBubbleColor),l=Math.floor(c.red*(1-.4*h)),d=Math.floor(c.green*(1-.4*h)),u=Math.floor(c.blue*(1-.4*h)),p=e.Display.Color.GetColor(l,d,u);t.setFillStyle(p),t.setStrokeStyle(1,this.currentBubbleColor,.4)})}destroy(){this.hide(),this.dotPool.forEach(e=>e.destroy()),this.dotPool=[]}}class Q{scene;inputManager;playerLauncher;opponentLauncher;projectiles=[];currentBubble=null;nextBubbleColors=[];availableColors=[b.RED,b.BLUE,b.GREEN,b.YELLOW,b.PURPLE];canShoot=!0;cooldownTime=1e3;shootSpeed=1500;bounds;cooldownBar;cooldownBarBg;trajectoryPreview;gridAttachmentSystem;bubbleGrid;constructor(t,s,i,a,n){this.scene=t,this.inputManager=s,this.playerLauncher=i,this.gridAttachmentSystem=a,this.bubbleGrid=n,this.bounds=new e.Geom.Rectangle(0,0,t.cameras.main.width,t.cameras.main.height),this.trajectoryPreview=new $(t,i),this.generateNextBubbleColors(),this.setupShooting()}setupShooting(){this.scene.input.on("pointerdown",this.onPointerDown,this),this.scene.input.on("pointerup",this.onShoot,this),this.scene.events.on("ai-shoot",this.onAIShoot,this),this.createCooldownIndicator(),this.loadNextBubble(),this.playerLauncher.updateQueueColors(this.nextBubbleColors)}setOpponentLauncher(e){this.opponentLauncher=e}onPointerDown(){const e=this.playerLauncher.getAimAngle();let t=16777215;this.currentBubble?t=this.currentBubble.getColor():this.nextBubbleColors.length>0&&(t=this.nextBubbleColors[0]),this.trajectoryPreview.show(e,t)}createCooldownIndicator(){const e=this.playerLauncher.y+40;this.cooldownBarBg=this.scene.add.rectangle(this.playerLauncher.x,e,80,6,2899536),this.cooldownBarBg.setStrokeStyle(1,3426654),this.cooldownBarBg.setDepth(G),this.cooldownBarBg.setVisible(!1),this.cooldownBar=this.scene.add.graphics(),this.cooldownBar.setDepth(G)}startCooldownAnimation(){if(this.cooldownBarBg?.setVisible(!0),!this.cooldownBar)return;const e=this.playerLauncher.x-40,t=this.playerLauncher.y+37;this.scene.tweens.add({targets:{progress:0},progress:1,duration:this.cooldownTime,ease:"Linear",onUpdate:s=>{const i=s.getValue();this.cooldownBar?.clear(),this.cooldownBar?.fillStyle(2600544,1),this.cooldownBar?.fillRect(e,t,80*i,6)},onComplete:()=>{this.cooldownBar?.clear()}})}generateNextBubbleColors(){this.nextBubbleColors=[];for(let e=0;e<3;e++){const e=this.availableColors[Math.floor(Math.random()*this.availableColors.length)];this.nextBubbleColors.push(e)}}loadNextBubble(){const e=this.nextBubbleColors[0]||b.BLUE;this.playerLauncher.loadBubble(e),this.currentBubble=this.playerLauncher.getLoadedBubble(),this.nextBubbleColors.shift();const t=this.availableColors[Math.floor(Math.random()*this.availableColors.length)];this.nextBubbleColors.push(t),this.playerLauncher.updateQueueColors(this.nextBubbleColors)}onShoot(){if(this.trajectoryPreview.hide(),!this.canShoot||!this.currentBubble)return;this.playerLauncher.getAimAngle();const t=this.playerLauncher.getAimDirection(),s=new e.Math.Vector2(t.x*this.shootSpeed,t.y*this.shootSpeed);this.playerLauncher.clearLoadedBubble(),this.currentBubble.setPosition(this.playerLauncher.x,this.playerLauncher.y-35),this.currentBubble.setScale(1),this.currentBubble.setShooter("player"),this.currentBubble.setDepth(I),this.projectiles.push({bubble:this.currentBubble,velocity:s,isActive:!0}),this.scene.events.emit("shooting-started"),this.scene.events.emit("bubble-shoot");const i=this.currentBubble.getColor();this.playerLauncher.animateShoot(i),this.canShoot=!1,this.startCooldownAnimation(),this.scene.time.delayedCall(this.cooldownTime,()=>{this.canShoot=!0,this.playerLauncher.setHighlight(!1),this.cooldownBarBg?.setVisible(!1),this.loadNextBubble()}),this.playerLauncher.setHighlight(!0),this.currentBubble=null}onAIShoot=t=>{if(!this.opponentLauncher)return;let s;t.bubble?(s=t.bubble,s.setShooter("ai"),s.setDepth(I)):(s=new U(this.scene,this.opponentLauncher.x,this.opponentLauncher.y+35,t.color),s.setShooter("ai"),s.setDepth(I));const i=e.Math.DegToRad(t.angle),a={bubble:s,velocity:new e.Math.Vector2(Math.cos(i)*this.shootSpeed,Math.sin(i)*this.shootSpeed),isActive:!0};this.projectiles.push(a),this.scene.events.emit("shooting-started",{isAI:!0}),this.scene.events.emit("bubble-shoot",{isAI:!0}),this.opponentLauncher.setHighlight(!0),this.scene.time.delayedCall(200,()=>{this.opponentLauncher.setHighlight(!1)})};update(t){if(this.inputManager.isPointerActive()){const e=this.playerLauncher.getAimAngle();let s=16777215;this.currentBubble?s=this.currentBubble.getColor():this.nextBubbleColors.length>0&&(s=this.nextBubbleColors[0]),this.trajectoryPreview.update(e,t,s)}this.checkProjectileCollisions();for(let s=this.projectiles.length-1;s>=0;s--){const i=this.projectiles[s];if(i.isActive)if(i.bubble.x+=i.velocity.x*(t/1e3),i.bubble.y+=i.velocity.y*(t/1e3),this.scene.events.emit("bubble-position-update",i.bubble),i.bubble.visible){if(this.gridAttachmentSystem){const t=this.gridAttachmentSystem.checkCollision(i.bubble);if(t){this.scene.events.emit("bubble-attach-collision");const s=this.gridAttachmentSystem.findAttachmentPosition(i.bubble,t);if(s){const t=this.bubbleGrid?.hexToPixel(s);if(t){if(e.Math.Distance.Between(i.bubble.x,i.bubble.y,t.x,t.y)<2*w.SIZE){i.isActive=!1,i.velocity.x=0,i.velocity.y=0,this.gridAttachmentSystem.attachToGrid(i.bubble,s,()=>{this.scene.events.emit("shooting-complete")});continue}}}}}this.checkWallCollision(i),(i.bubble.y<-50||i.bubble.y>this.bounds.height+50)&&(i.isActive=!1,i.bubble.destroy())}else i.isActive=!1;else this.projectiles.splice(s,1)}}checkProjectileCollisions(){const t=w.SIZE/2;for(let s=0;s<this.projectiles.length;s++){const i=this.projectiles[s];if(i.isActive)for(let a=s+1;a<this.projectiles.length;a++){const s=this.projectiles[a];if(!s.isActive)continue;const n=e.Math.Distance.Between(i.bubble.x,i.bubble.y,s.bubble.x,s.bubble.y);if(n<2*t){const e=s.bubble.x-i.bubble.x,a=s.bubble.y-i.bubble.y,r=Math.sqrt(e*e+a*a);if(r>0){const o=e/r,h=a/r,c=2*t-n;i.bubble.x-=o*c*.5,i.bubble.y-=h*c*.5,s.bubble.x+=o*c*.5,s.bubble.y+=h*c*.5;const l=(s.velocity.x-i.velocity.x)*o+(s.velocity.y-i.velocity.y)*h;if(l<0)continue;const d=.8*l;i.velocity.x+=d*o,i.velocity.y+=d*h,s.velocity.x-=d*o,s.velocity.y-=d*h,i.velocity.x+=20*(Math.random()-.5),i.velocity.y+=20*(Math.random()-.5),s.velocity.x+=20*(Math.random()-.5),s.velocity.y+=20*(Math.random()-.5),this.scene.events.emit("projectile-collision")}}}}}checkWallCollision(e){const t=e.bubble,s=w.SIZE/2;t.x-s<=this.bounds.left&&(t.x=this.bounds.left+s,e.velocity.x=Math.abs(e.velocity.x),this.scene.events.emit("wall-bounce")),t.x+s>=this.bounds.right&&(t.x=this.bounds.right-s,e.velocity.x=-Math.abs(e.velocity.x),this.scene.events.emit("wall-bounce")),t.y-s<=this.bounds.top&&(e.isActive=!1,t.pop())}isReady(){return this.canShoot}getProjectileCount(){return this.projectiles.length}destroy(){this.scene.input.off("pointerdown",this.onPointerDown,this),this.scene.input.off("pointerup",this.onShoot,this),this.trajectoryPreview?.destroy(),this.projectiles.forEach(e=>{e.bubble&&e.bubble.destroy()}),this.projectiles=[],this.currentBubble&&this.currentBubble.destroy(),this.cooldownBar?.destroy(),this.cooldownBarBg?.destroy()}}class K{scene;bubbleGrid;gridBubbles=[];attachmentInProgress=!1;attachmentQueue=[];matchDetectionSystem;spatialGrid=new Map;gridPositions=new Map;constructor(e,t){this.scene=e,this.bubbleGrid=t}setMatchDetectionSystem(e){this.matchDetectionSystem=e}addGridBubble(e){this.gridBubbles.includes(e)||(this.gridBubbles.push(e),this.updateSpatialGrid())}removeGridBubble(e){const t=this.gridBubbles.indexOf(e);t>-1&&(this.gridBubbles.splice(t,1),this.updateSpatialGrid())}checkCollision(e){const t={x:e.x,y:e.y},s=w.SIZE-2,i=this.bubbleGrid.hexToPixel({q:0,r:0,s:0});if(Phaser.Math.Distance.Between(t.x,t.y,i.x,i.y)<w.SIZE&&!this.isPositionOccupied({q:0,r:0,s:0})){const e=new U(this.scene,i.x,i.y,0);return e.setGridPosition({q:0,r:0,s:0}),e.setVisible(!1),e}const a=this.getNearbyBubbles(t.x,t.y);for(const n of a){if(!n.visible)continue;if(Phaser.Math.Distance.Between(t.x,t.y,n.x,n.y)<s)return n}return null}getNearbyBubbles(e,t){const s=2*w.SIZE,i=Math.floor(e/s),a=Math.floor(t/s),n=[];for(let r=-1;r<=1;r++)for(let e=-1;e<=1;e++){const t=`${i+r},${a+e}`,s=this.spatialGrid.get(t);s&&n.push(...s)}return n}updateSpatialGrid(){this.spatialGrid.clear();const e=2*w.SIZE;for(const t of this.gridBubbles){if(!t.visible)continue;const s=`${Math.floor(t.x/e)},${Math.floor(t.y/e)}`;this.spatialGrid.has(s)||this.spatialGrid.set(s,[]),this.spatialGrid.get(s).push(t)}}findAttachmentPosition(e,t){const s=t.getGridPosition();if(!s)return null;const i=e.x-t.x,a=e.y-t.y,n=(180*Math.atan2(a,i)/Math.PI+360)%360;let r=[];r=Math.abs(s.r)%2==1?[{q:0,r:-1,angle:270},{q:1,r:-1,angle:315},{q:1,r:0,angle:0},{q:1,r:1,angle:45},{q:0,r:1,angle:90},{q:-1,r:0,angle:180}]:[{q:0,r:-1,angle:270},{q:1,r:0,angle:0},{q:0,r:1,angle:90},{q:-1,r:1,angle:135},{q:-1,r:0,angle:180},{q:-1,r:-1,angle:225}];let o=null,h=360;for(const c of r){const e={q:s.q+c.q,r:s.r+c.r,s:0};if(this.isPositionOccupied(e))continue;let t=Math.abs(n-c.angle);t>180&&(t=360-t),t<h&&(h=t,o=e)}return o&&this.bubbleGrid.hexToPixel(o),o}findBestAvailablePosition(e,t){if(!this.isPositionOccupied(e)&&this.isValidPosition(e))return e;for(let s=1;s<=3;s++){const i=this.bubbleGrid.getRing(e,s);let a=null,n=1/0;for(const e of i)if(!this.isPositionOccupied(e)&&this.isValidPosition(e)){const s=this.bubbleGrid.hexToPixel(e),i=Phaser.Math.Distance.Between(t.x,t.y,s.x,s.y);i<n&&(n=i,a=e)}if(a)return a}return null}isValidPosition(e){if(0===e.q&&0===e.r)return!0;return this.bubbleGrid.getNeighbors(e).some(e=>this.isPositionOccupied(e))}isPositionOccupied(e){const t=this.hexToKey(e);if(this.gridPositions.has(t)){const e=this.gridPositions.get(t);return!!e&&e.visible}const s=this.bubbleGrid.hexToPixel(e),i=.8*w.SIZE;return this.getNearbyBubbles(s.x,s.y).some(e=>{if(!e.visible)return!1;return Phaser.Math.Distance.Between(e.x,e.y,s.x,s.y)<i})}hexToKey(e){return`${e.q},${e.r}`}attachToGrid(e,t,s){if(this.attachmentInProgress)return void this.attachmentQueue.push({bubble:e,hexPos:t,onComplete:s});if(!(t=this.findBestAvailablePosition(t,e)))return e.destroy(),void(s&&s());this.attachmentInProgress=!0;const i=this.bubbleGrid.hexToPixel(t);this.cleanupMisalignedBubbles(t,e),e.setGridPosition(t);const a=this.hexToKey(t);this.gridPositions.set(a,e),this.addGridBubble(e);const n=Phaser.Math.Distance.Between(e.x,e.y,i.x,i.y),r=Math.min(200,Math.max(50,.5*n));this.scene.tweens.add({targets:e,x:i.x,y:i.y,duration:r,ease:"Power2",onComplete:()=>{this.createAttachmentEffect(e),this.scene.tweens.add({targets:e,scaleX:1.15,scaleY:1.15,duration:80,ease:"Back.easeOut",yoyo:!0})}}),this.scene.time.delayedCall(r+100,async()=>{const i=this.bubbleGrid.hexToPixel(t);if(Phaser.Math.Distance.Between(e.x,e.y,i.x,i.y)>5&&e.setPosition(i.x,i.y),this.matchDetectionSystem&&await this.matchDetectionSystem.checkForMatches(e),this.checkDisconnectedBubbles(),this.attachmentInProgress=!1,e.visible&&e.getGridPosition()&&this.scene.events.emit("bubble-attached",{bubble:e,position:t}),this.scene.time.delayedCall(100,()=>{this.scene.events.emit("matches-resolved")}),s&&s(),this.attachmentQueue.length>0){const e=this.attachmentQueue.shift();e&&this.scene.time.delayedCall(50,()=>{this.attachToGrid(e.bubble,e.hexPos,e.onComplete)})}})}createAttachmentEffect(e){const t=e.getColor(),s=this.scene.add.circle(e.x,e.y,w.SIZE/2,t,0);s.setStrokeStyle(2,t,.6),s.setDepth(e.depth-1),this.scene.tweens.add({targets:s,scale:1.5,alpha:0,duration:300,ease:"Power2",onComplete:()=>{s.destroy()}});for(let i=0;i<4;i++){const s=this.scene.add.circle(e.x,e.y,2,t,.8),a=2*Math.PI*i/4,n=20;this.scene.tweens.add({targets:s,x:e.x+Math.cos(a)*n,y:e.y+Math.sin(a)*n,scale:0,alpha:0,duration:250,ease:"Power2",onComplete:()=>{s.destroy()}})}}cleanupMisalignedBubbles(e,t){const s=this.bubbleGrid.hexToPixel(e),i=.9*w.SIZE,a=[];this.gridBubbles.forEach(e=>{if(e===t||!e.visible)return;Phaser.Math.Distance.Between(e.x,e.y,s.x,s.y)<i&&a.push(e)}),a.forEach(e=>{this.removeGridBubble(e),e.destroy()})}checkDisconnectedBubbles(){const e=this.findDisconnectedGroups(),t=[];e.forEach(e=>{t.push(...e)}),t.length>0&&this.applyBidirectionalGravity(t)}findDisconnectedGroups(){const e=new Map;e.set(f.PLAYER,[]),e.set(f.OPPONENT,[]),e.set(f.OBJECTIVE,[]);const t=new Set,s=new Set,i={q:0,r:0,s:0},a=[],n=this.getBubbleAtPosition(i);n&&a.push(n);return this.bubbleGrid.getNeighbors(i).forEach(e=>{const t=this.getBubbleAtPosition(e);t&&a.push(t)}),0===a.length?(this.gridBubbles.forEach(t=>{if(t.visible){const s=this.getZoneForBubble(t);e.get(s)?.push(t)}}),e):(a.forEach(e=>{this.floodFill(e,t,s)}),this.gridBubbles.forEach(t=>{if(!s.has(t)&&t.visible){const s=this.getZoneForBubble(t);e.get(s)?.push(t)}}),e.forEach((e,t)=>{e.length}),e)}floodFill(e,t,s){if(t.has(e))return;t.add(e),s.add(e);const i=e.getGridPosition();if(!i)return;this.bubbleGrid.getNeighbors(i).forEach(e=>{const i=this.getBubbleAtPosition(e);i&&!t.has(i)&&this.floodFill(i,t,s)})}getBubbleAtPosition(e){return this.gridBubbles.find(t=>{const s=t.getGridPosition();return s&&s.q===e.q&&s.r===e.r})||null}getZoneForBubble(e){const t=this.scene.cameras.main.height,s=.4*t,i=.6*t;return e.y<s?f.OPPONENT:e.y>i?f.PLAYER:f.OBJECTIVE}applyBidirectionalGravity(e){const t=this.scene.cameras.main.centerY,s=[],i=[];e.forEach(e=>{e.y<t?s.push(e):i.push(e)}),s.length>0&&this.animateFallingBubbles(s,"up"),i.length>0&&this.animateFallingBubbles(i,"down")}animateFallingBubbles(e,t){const s="down"===t?this.scene.cameras.main.height+100:-100,i=this.scene.cameras.main.centerX;e.sort((e,t)=>Math.abs(e.x-i)-Math.abs(t.x-i)),e.forEach((e,i)=>{this.removeGridBubble(e);const a=e.getGridPosition();if(a){const e=this.hexToKey(a);this.gridPositions.delete(e)}e.setGridPosition(null);const n=Phaser.Math.Between(-30,30),r=Phaser.Math.Between(2*-Math.PI,2*Math.PI);e.setTint(16777215),this.scene.time.delayedCall(100,()=>{e.clearTint()}),this.scene.tweens.add({targets:e,y:s,x:e.x+n,rotation:r,scale:.8,alpha:.3,duration:800+20*i,ease:"Quad.easeIn",delay:30*i,onComplete:()=>{const s="up"===t?15:10;this.scene.events.emit("bubble-dropped",{direction:t,points:s,color:e.getColor()}),e.returnToPool()}})}),e.length>=5&&this.scene.cameras.main.shake(150,.002)}getGridBubbles(){return this.gridBubbles}clearGrid(){this.gridBubbles=[]}debugDrawConnections(e){e.lineStyle(1,65280,.5),this.gridBubbles.forEach(t=>{const s=t.getGridPosition();if(!s)return;this.bubbleGrid.getNeighbors(s).forEach(s=>{const i=this.getBubbleAtPosition(s);i&&e.lineBetween(t.x,t.y,i.x,i.y)})})}hasGridPosition(e){return this.gridPositions.has(e)}}class J{scene;bubbleGrid;gridAttachmentSystem;minimumMatchSize=3;isProcessing=!1;totalScore=0;combo=0;lastMatchTime=0;comboTimeout=2e3;constructor(e,t,s){this.scene=e,this.bubbleGrid=t,this.gridAttachmentSystem=s}async checkForMatches(e){if(this.isProcessing||!e.visible)return;const t=e.getColor();if(null==t)return;this.isProcessing=!0;const s=this.findColorMatches(e,t);if(s.size>=this.minimumMatchSize){let t,i=0,a=0;s.forEach(e=>{const s=e.getWorldTransformMatrix();i+=s.tx,a+=s.ty,t||(t=e.getColor())}),i/=s.size,a/=s.size;const n="ai"===e.getShooter();this.highlightMatches(Array.from(s)),await new Promise(e=>setTimeout(e,200)),this.updateCombo();const r=this.calculateScore(s);if(this.totalScore+=r,this.scene.events.emit("match-found",{matchSize:s.size,combo:this.combo,isAI:n,x:i,y:a,bubbleColor:t}),this.scene.events.emit("score-update",{score:this.totalScore,delta:r,combo:this.combo,isAI:n,matchSize:s.size,x:i,y:a,bubbleColor:t}),void 0!==t){const e=[];s.forEach(t=>{const s=t.getWorldTransformMatrix();e.push({x:s.tx,y:s.ty})}),this.scene.events.emit("bubble-exploded",{x:i,y:a,positions:e,color:t,comboMultiplier:s.size}),this.scene.events.emit("bubbles-popped",{color:t,count:s.size})}await this.removeMatches(Array.from(s),!n),this.checkFloatingBubbles(),this.scene.events.emit("match-completed",{count:s.size,score:r,totalScore:this.totalScore,combo:this.combo})}this.isProcessing=!1}findColorMatches(e,t){const s=new Set,i=new Set,a=[e];for(;a.length>0;){const e=a.shift();if(i.has(e))continue;i.add(e);const n=e.getColor()===t;if(!e.visible||!n)continue;s.add(e);const r=this.getNeighborBubbles(e);for(const t of r)i.has(t)||a.push(t)}return s}getNeighborBubbles(e){const t=[],s=e.getGridPosition();if(!s)return t;const i=this.bubbleGrid.getNeighbors(s),a=this.gridAttachmentSystem.getGridBubbles();for(const n of i){const e=a.find(e=>{const t=e.getGridPosition();return t&&t.q===n.q&&t.r===n.r&&e.visible});e&&t.push(e)}return t}highlightMatches(e){e.forEach(e=>{this.scene.tweens.killTweensOf(e),this.scene.tweens.add({targets:e,scaleX:1.2,scaleY:1.2,duration:100,yoyo:!0,repeat:1,ease:"Sine.easeInOut"}),e.setTint(16777215)})}async removeMatches(e,t){e.forEach(e=>{e instanceof Y&&e.collectPowerUp(t)});const s=e.reduce((e,t)=>e+t.x,0)/e.length,i=e.reduce((e,t)=>e+t.y,0)/e.length;e.sort((e,t)=>Phaser.Math.Distance.Between(e.x,e.y,s,i)-Phaser.Math.Distance.Between(t.x,t.y,s,i));const a=e.length;this.getPopAnimationStyle(a);const n=[];e.forEach((t,s)=>{const i=new Promise(i=>{if(this.scene.tweens.killTweensOf(t),t.clearTint(),t.setVisible(!0),t.setAlpha(1),t.setScale(1),a>=4){const e=t.getColor();null!=e&&this.createParticles(t.x,t.y,e)}if(3===a)this.scene.tweens.add({targets:t,scale:.8,alpha:0,duration:150,ease:"Power2",delay:15*s,onComplete:()=>{this.gridAttachmentSystem.removeGridBubble(t),t.setGridPosition(null),t.returnToPool(),i()}});else if(4===a)this.scene.tweens.add({targets:t,scale:1.2,alpha:0,duration:200,ease:"Back.easeOut",delay:20*s,onComplete:()=>{this.gridAttachmentSystem.removeGridBubble(t),t.setGridPosition(null),t.returnToPool(),i()}});else if(5===a)this.scene.tweens.add({targets:t,scale:{from:1,to:1.4},alpha:0,y:t.y-10,duration:250,ease:"Bounce.easeOut",delay:25*s,onComplete:()=>{this.gridAttachmentSystem.removeGridBubble(t),t.setGridPosition(null),t.returnToPool(),i()}});else if(6===a){const a=s/e.length*Math.PI*2;this.scene.tweens.add({targets:t,x:t.x+30*Math.cos(a),y:t.y+30*Math.sin(a),scale:1.5,alpha:0,angle:180,duration:300,ease:"Cubic.easeOut",delay:20*s,onComplete:()=>{this.gridAttachmentSystem.removeGridBubble(t),t.setGridPosition(null),t.returnToPool(),i()}})}else{const e=Math.random()*Math.PI*2,a=Phaser.Math.Between(50,100);t.clearTint(),t.setVisible(!0),t.setAlpha(1),this.scene.tweens.add({targets:t,x:t.x+Math.cos(e)*a,y:t.y+Math.sin(e)*a,scale:0,alpha:0,angle:360,duration:400,ease:"Power3.easeOut",delay:10*s,onComplete:()=>{t.setVisible(!1),t.clearTint(),t.setScale(1),t.setAlpha(1),t.setAngle(0),this.gridAttachmentSystem.removeGridBubble(t),t.setGridPosition(null),t.returnToPool(),i()}})}});n.push(i)}),e.length>=6&&this.scene.cameras.main.shake(150,.002),await Promise.all(n)}getPopAnimationStyle(e){return 3===e?"fade":4===e?"pop":5===e?"bounce":6===e?"spiral":"explode"}checkFloatingBubbles(){const e=this.gridAttachmentSystem.findDisconnectedGroups(),t=[];if(e.forEach(e=>{t.push(...e)}),t.length>0){let e=0,s=0;t.forEach(t=>{e+=t.x,s+=t.y}),e/=t.length,s/=t.length;const i=this.scene.cameras.main.centerY,a=t.filter(e=>e.y<i).length,n=t.filter(e=>e.y>=i).length,r=10,o=t.length*r;if(o>0){this.totalScore+=o,this.scene.events.emit("floating-bubbles-drop",{count:t.length,x:e,y:s});const i=a>n;this.scene.events.emit("score-update",{score:this.totalScore,delta:o,combo:0,isAI:i,matchSize:0,x:e,y:s+40,isOrphanBonus:!0,metadata:{dropCount:t.length}})}this.gridAttachmentSystem.applyBidirectionalGravity(t)}}showOrphanBonus(e,t,s,i){const a=t+30,n=this.scene.add.container(e,a);n.setDepth(G+15);const r=this.scene.add.text(0,-8,"DROP BONUS",{fontSize:"18px",color:"#00FFFF",fontFamily:"Impact, Arial Black",fontStyle:"bold",stroke:"#000000",strokeThickness:3});r.setOrigin(.5),r.setShadow(1,1,"#0066CC",2,!0,!0);const o=this.scene.add.text(0,12,`+${i}`,{fontSize:"22px",color:"#FFD700",fontFamily:"Impact, Arial Black",fontStyle:"bold",stroke:"#000000",strokeThickness:3});o.setOrigin(.5),n.add([r,o]),n.setScale(0),this.scene.tweens.add({targets:n,scale:{from:0,to:1.1},duration:250,ease:"Back.easeOut",onComplete:()=>{this.scene.tweens.add({targets:n,scale:1,duration:100,ease:"Sine.easeInOut"})}}),this.scene.time.delayedCall(700,()=>{this.scene.tweens.add({targets:n,y:a+40,alpha:0,scale:.9,duration:600,ease:"Cubic.easeOut",onComplete:()=>{n.destroy(!0)}})}),this.createDropParticles(e,a,s)}createDropParticles(e,t,s){const i=Math.min(3*s,15);for(let a=0;a<i;a++){const s=this.scene.add.circle(e+Phaser.Math.Between(-20,20),t+Phaser.Math.Between(-20,20),3,65535,.8);s.setDepth(G+5),this.scene.tweens.add({targets:s,y:s.y-Phaser.Math.Between(30,60),alpha:0,scale:0,duration:Phaser.Math.Between(500,800),delay:20*a,ease:"Cubic.easeOut",onComplete:()=>{s.destroy()}})}}calculateScore(e){let t=0;t=10*e.size,e.size>3&&(t+=5*(e.size-3)),this.combo>0&&(t=Math.floor(t*(1+.2*this.combo)));let s=1;return e.forEach(e=>{const t=this.getZone(e);t===f.OPPONENT?s=Math.max(s,2):t===f.OBJECTIVE&&(s=Math.max(s,1.5))}),t=Math.floor(t*s),t}updateCombo(){const e=Date.now();e-this.lastMatchTime<this.comboTimeout?this.combo++:this.combo=0,this.lastMatchTime=e}getZone(e){const t=this.scene.cameras.main.height,s=.4*t,i=.6*t;return e.y<s?f.OPPONENT:e.y>i?f.PLAYER:f.OBJECTIVE}createParticles(e,t,s){for(let i=0;i<6;i++){const a=this.scene.add.circle(e,t,4,s,1);a.setDepth(k);const n=i/6*Math.PI*2,r=Phaser.Math.Between(50,150);this.scene.tweens.add({targets:a,x:e+Math.cos(n)*r,y:t+Math.sin(n)*r,alpha:0,scale:0,duration:400,ease:"Power2",onComplete:()=>{a.destroy()}})}}getScore(){return this.totalScore}reset(){this.totalScore=0,this.combo=0,this.lastMatchTime=0,this.isProcessing=!1}}var ee=(e=>(e.EASY="EASY",e.MEDIUM="MEDIUM",e.HARD="HARD",e))(ee||{});class te{scene;launcher;currentBubble=null;nextBubbleColors=[];availableColors=[b.RED,b.BLUE,b.GREEN,b.YELLOW,b.PURPLE];isActive=!1;shootTimer;difficulty="HARD";isOnCooldown=!1;COOLDOWN_TIME=1e3;SHOOT_SPEED=600;constructor(e,t){this.scene=e,this.launcher=t,this.generateNextBubbleColors(),this.scene.events.on("shooting-complete",this.onShootingComplete,this)}setDifficulty(e){this.difficulty=e}start(){this.isActive=!0,this.launcher.setAimAngle(90),this.loadNextBubble(),this.scheduleNextShot()}stop(){this.isActive=!1,this.shootTimer&&(this.shootTimer.destroy(),this.shootTimer=void 0),this.currentBubble&&(this.currentBubble.destroy(),this.currentBubble=null)}generateNextBubbleColors(){this.nextBubbleColors=[];for(let e=0;e<3;e++){const e=this.availableColors[Math.floor(Math.random()*this.availableColors.length)];this.nextBubbleColors.push(e)}}loadNextBubble(){const e=this.nextBubbleColors[0]||b.BLUE;this.launcher.loadBubble(e),this.currentBubble=this.launcher.getLoadedBubble(),this.nextBubbleColors.shift();const t=this.availableColors[Math.floor(Math.random()*this.availableColors.length)];this.nextBubbleColors.push(t),this.launcher.updateQueueColors(this.nextBubbleColors)}scheduleNextShot(){if(!this.isActive||this.isOnCooldown)return;let e;switch(this.difficulty){case"EASY":e=3e3+2e3*Math.random();break;case"MEDIUM":e=2e3+1e3*Math.random();break;case"HARD":e=1e3+500*Math.random()}this.shootTimer=this.scene.time.delayedCall(e,()=>{this.isActive&&!this.isOnCooldown&&this.performShot()})}performShot(){if(this.isOnCooldown||!this.currentBubble)return;const e=this.currentBubble.getColor();this.currentBubble.getData("bubbleId");const t=this.calculateBestShot(e);this.launcher.setAimAngle(t.angle);const s=this.currentBubble;this.currentBubble=null,this.launcher.clearLoadedBubble(),this.launcher.animateShoot(e),s.setPosition(this.launcher.x,this.launcher.y+30),s.setScale(1),s.setDepth(I),this.scene.events.emit("ai-shoot",{angle:t.angle,color:e,bubble:s}),this.isOnCooldown=!0,this.scene.time.delayedCall(this.COOLDOWN_TIME,()=>{this.isOnCooldown=!1,this.loadNextBubble(),this.scheduleNextShot()})}calculateBestShot(t){const s=this.getGridBubbles().filter(e=>e.getColor()===t),i=s;let a=null;if("HARD"===this.difficulty){const n=this.checkObjectiveShot();if(n)return n;let r=[];if(!this.isObjectiveExposed()){const t=this.scene.cameras.main.centerX,i=this.scene.cameras.main.centerY,a=s.filter(s=>e.Math.Distance.Between(s.x,s.y,t,i)<4*w.SIZE);a.length>0&&s.unshift(...a)}if(i.length>0)for(const s of i){const i=[this.calculateAngleToTarget(s.x,s.y),this.calculateAngleToTarget(s.x,s.y-w.SIZE),this.calculateAngleToTarget(s.x-.5*w.SIZE,s.y)];for(const a of i)if(a>=15&&a<=165){const i={x:s.x,y:s.y};if(this.isTrajectoryLikelyClear(a,i)){const i=this.countPotentialMatch(s,t),n=i>=3?2:0,o=this.scene.cameras.main.centerX,h=this.scene.cameras.main.centerY,c=e.Math.Distance.Between(s.x,s.y,o,h)<4*w.SIZE,l=c?200+30*i:100+20*i,d=300*n;r.push({angle:a,useWallBounce:"none",targetBubble:s,score:l+d,totalValue:l+d,potentialFalls:n,reasoning:`match-${i}${n>0?` causing ${n} falls`:""}${c?" NEAR OBJECTIVE":""}`});break}}}if(i.length>0&&i.length<5){const e=this.findWallBounceTargets(t,i.slice(0,3));r.push(...e)}r.length>0&&(r.sort((e,t)=>(t.totalValue||t.score)-(e.totalValue||e.score)),a=r[0])}if(a||(a=this.findStraightShotTarget(s)),!a){const e=this.getGridBubbles();for(const t of e){const e=this.calculateAngleToTarget(t.x,t.y);if(e>=15&&e<=165){const s={x:t.x,y:t.y};if(this.isTrajectoryLikelyClear(e,s)){a={angle:e,useWallBounce:"none",score:10,reasoning:"any available target"};break}}}}if(!a){const e=[85,90,95,75,105];a={angle:e[Math.floor(Math.random()*e.length)],useWallBounce:"none",score:0,reasoning:"safe fallback"}}return a}findStraightShotTarget(e){const t=this.getGridBubbles(),s=e.length>0?e:t;for(const i of s){const e=this.calculateAngleToTarget(i.x,i.y);if(e>=15&&e<=165){const t={x:i.x,y:i.y};if(this.isTrajectoryLikelyClear(e,t))return{angle:e,useWallBounce:"none",targetBubble:i,score:50,reasoning:`direct shot to ${this.getColorName(i.getColor())}`}}}return null}findTargetsViaWallBounce(e){const t=[],s=this.getGridBubbles().filter(t=>t.getColor()===e);for(const i of s){const a=this.getAttachmentPoints(i);for(const n of a){const a=this.countConnectedBubbles(n,e,s);if(a>=2){const e=this.calculateAngleToTarget(n.x,n.y);e>=15&&e<=165&&this.isTrajectoryLikelyClear(e,n)&&t.push({angle:e,useWallBounce:"none",targetBubble:i,score:100+50*a,reasoning:`match-${a+1}`})}}}return t.sort((e,t)=>t.score-e.score)}findWallBounceTargets(e,t){const s=[],i=this.scene.cameras.main.width;for(const a of t){const e=-a.x,t=this.calculateAngleToTarget(e,a.y);t>=100&&t<=165&&s.push({angle:t,useWallBounce:"left",targetBubble:a,score:80,reasoning:"left wall bounce"});const n=i+(i-a.x),r=this.calculateAngleToTarget(n,a.y);r>=15&&r<=80&&s.push({angle:r,useWallBounce:"right",targetBubble:a,score:80,reasoning:"right wall bounce"})}return s.sort((e,t)=>t.score-e.score)}findBestWallBounce(e,t){for(const s of t){const t=-s.x,i=this.calculateAngleToTarget(t,s.y);if(i>=100&&i<=165){const t={x:0,y:this.launcher.y+Math.tan(i*Math.PI/180)*this.launcher.x};if(this.isTrajectoryLikelyClear(i,t))return{angle:i,useWallBounce:"left",score:100,reasoning:`left bounce to ${this.getColorName(e)}`}}const a=this.scene.cameras.main.width,n=a+(a-s.x),r=this.calculateAngleToTarget(n,s.y);if(r>=15&&r<=80){const t={x:a,y:this.launcher.y+Math.tan(r*Math.PI/180)*(a-this.launcher.x)};if(this.isTrajectoryLikelyClear(r,t))return{angle:r,useWallBounce:"right",score:100,reasoning:`right bounce to ${this.getColorName(e)}`}}}return null}getAttachmentPoints(e){const t=[],s=w.SIZE,i=[{x:s,y:0},{x:-s,y:0},{x:s/2,y:.866*-s},{x:-s/2,y:.866*-s},{x:s/2,y:.866*s},{x:-s/2,y:.866*s}];for(const a of i)t.push({x:e.x+a.x,y:e.y+a.y});return t}countConnectedBubbles(t,s,i){let a=0;const n=1.1*w.SIZE;for(const r of i){e.Math.Distance.Between(t.x,t.y,r.x,r.y)<n&&a++}return a}calculateAngleToTarget(e,t){const s=e-this.launcher.x,i=t-this.launcher.y;let a=Math.atan2(i,s);return a*=180/Math.PI,a<0&&(a+=360),a}isTrajectoryClear(t,s){const i=t*(Math.PI/180),a=Math.cos(i)*this.SHOOT_SPEED,n=Math.sin(i)*this.SHOOT_SPEED;let r=this.launcher.x,o=this.launcher.y;const h=e.Math.Distance.Between(this.launcher.x,this.launcher.y,s.x,s.y)/10;for(let c=1;c<10;c++){const t=h*c/this.SHOOT_SPEED;r=this.launcher.x+a*t,o=this.launcher.y+n*t;const i=this.getGridBubbles();for(const a of i){if(e.Math.Distance.Between(r,o,a.x,a.y)<.8*w.SIZE){if(e.Math.Distance.Between(a.x,a.y,s.x,s.y)>w.SIZE)return!1}}}return!0}getGridBubbles(){const e=[];return this.scene.children.list.forEach(t=>{t instanceof U&&t.visible&&t.getGridPosition()&&e.push(t)}),e}getColorName(e){switch(e){case b.RED:return"RED";case b.BLUE:return"BLUE";case b.GREEN:return"GREEN";case b.YELLOW:return"YELLOW";case b.PURPLE:return"PURPLE";case b.MYSTERY:return"MYSTERY";default:return"UNKNOWN"}}getClosestBubbles(t,s){const i=this.scene.cameras.main.centerX,a=this.scene.cameras.main.centerY;return t.sort((t,s)=>{const n=e.Math.Distance.Between(this.launcher.x,this.launcher.y,t.x,t.y),r=e.Math.Distance.Between(this.launcher.x,this.launcher.y,s.x,s.y);return.3*n+.7*e.Math.Distance.Between(t.x,t.y,i,a)-(.3*r+.7*e.Math.Distance.Between(s.x,s.y,i,a))}).slice(0,s)}isTrajectoryLikelyClear(t,s){const i=this.getGridBubbles(),a=t*Math.PI/180,n=Math.cos(a),r=Math.sin(a),o=e.Math.Distance.Between(this.launcher.x,this.launcher.y,s.x,s.y);for(let h=.3;h<.9;h+=.3){const t=this.launcher.x+n*o*h,s=this.launcher.y+r*o*h;for(const a of i){if(!a.visible)continue;if(e.Math.Distance.Between(t,s,a.x,a.y)<.7*w.SIZE)return!1}}return!0}quickCountPotentialMatch(e,t){const s=this.getNeighborBubbles(e);let i=1;for(const a of s)a.getColor()===t&&i++;return i}countPotentialMatch(e,t){const s=new Set,i=[e];let a=1;for(;i.length>0;){const n=i.pop();if(!s.has(n)&&(s.add(n),n.getColor()===t)){n!==e&&a++;const r=this.getNeighborBubbles(n);for(const e of r)s.has(e)||e.getColor()!==t||i.push(e)}}return a}predictFallsFromShot(e,t){if(this.countPotentialMatch(e,t)<3)return 0;const s=this.getNeighborBubbles(e);let i=0;for(const a of s)if(a.getColor()!==t){const s=this.getNeighborBubbles(a);s.filter(s=>s===e||s.getColor()===t).length>=s.length-1&&i++}return i}getNeighborBubbles(t){const s=[],i=this.getGridBubbles(),a=1.1*w.SIZE;for(const n of i){if(n===t)continue;e.Math.Distance.Between(t.x,t.y,n.x,n.y)<a&&s.push(n)}return s}checkObjectiveShot(){const e=this.scene.cameras.main.centerX,t=this.scene.cameras.main.centerY,s=this.calculateAngleToTarget(e,t);if(s>=15&&s<=165){const i={x:e,y:t};if(this.isTrajectoryLikelyClear(s,i))return{angle:s,useWallBounce:"none",score:1e4,reasoning:"🏆 DIRECT HIT ON OBJECTIVE!"}}return null}isObjectiveExposed(){const t=this.scene.cameras.main.centerX,s=this.scene.cameras.main.centerY,i=this.getGridBubbles();for(const a of i){if(e.Math.Distance.Between(a.x,a.y,t,s)<1.5*w.SIZE)return!1}return!0}onShootingComplete=()=>{};destroy(){this.stop(),this.scene.events.off("shooting-complete",this.onShootingComplete)}}class se extends e.GameObjects.Container{playerScore=0;opponentScore=0;playerScoreText;opponentScoreText;playerNameText;opponentNameText;playerDisplayScore=0;opponentDisplayScore=0;playerTargetScore=0;opponentTargetScore=0;playerLeadIndicator;opponentLeadIndicator;currentLeader="tie";playerContainer;opponentContainer;constructor(e){super(e,0,0),this.createPlayerDisplay(),this.createOpponentDisplay(),this.setDepth(1e3),e.add.existing(this)}createPlayerDisplay(){const e=100,t=this.scene.cameras.main.height-75-e;this.playerContainer=this.scene.add.container(37.5,t);const s=this.scene.add.graphics();s.fillStyle(1710638,.9),s.fillRoundedRect(0,0,175,e,20),s.lineStyle(5,1492890,1),s.strokeRoundedRect(0,0,175,e,20),this.playerNameText=this.scene.add.text(20,15,"PLAYER",{fontSize:"17.5px",color:"#16C79A",fontFamily:"Arial",fontStyle:"bold"}),this.playerScoreText=this.scene.add.text(20,45,"0",{fontSize:"30px",color:"#FFFFFF",fontFamily:"Arial Black",fontStyle:"bold"}),this.playerLeadIndicator=this.scene.add.text(137.5,50,"👑",{fontSize:"22.5px",fontFamily:"Arial"}),this.playerLeadIndicator.setOrigin(.5),this.playerLeadIndicator.setVisible(!1),this.playerContainer.add([s,this.playerNameText,this.playerScoreText,this.playerLeadIndicator]),this.add(this.playerContainer)}createOpponentDisplay(){const e=175,t=this.scene.cameras.main.width-37.5-e;this.opponentContainer=this.scene.add.container(t,87.5);const s=this.scene.add.graphics();s.fillStyle(1710638,.9),s.fillRoundedRect(0,0,e,100,20),s.lineStyle(5,16013414,1),s.strokeRoundedRect(0,0,e,100,20),this.opponentNameText=this.scene.add.text(155,15,"OPPONENT",{fontSize:"17.5px",color:"#F45866",fontFamily:"Arial",fontStyle:"bold"}),this.opponentNameText.setOrigin(1,0),this.opponentScoreText=this.scene.add.text(155,45,"0",{fontSize:"30px",color:"#FFFFFF",fontFamily:"Arial Black",fontStyle:"bold"}),this.opponentScoreText.setOrigin(1,0),this.opponentLeadIndicator=this.scene.add.text(37.5,50,"👑",{fontSize:"22.5px",fontFamily:"Arial"}),this.opponentLeadIndicator.setOrigin(.5),this.opponentLeadIndicator.setVisible(!1),this.opponentContainer.add([s,this.opponentNameText,this.opponentScoreText,this.opponentLeadIndicator]),this.add(this.opponentContainer)}updatePlayerScore(e,t=!1){if(this.playerTargetScore=e,t)return this.playerDisplayScore=e,void this.playerScoreText.setText(this.formatScore(e));this.scene.tweens.add({targets:this,playerDisplayScore:e,duration:500,ease:"Cubic.easeOut",onUpdate:()=>{this.playerScoreText.setText(this.formatScore(Math.floor(this.playerDisplayScore)))},onComplete:()=>{this.pulseScore(this.playerScoreText),this.updateLeaderIndicator()}})}updateOpponentScore(e,t=!1){if(this.opponentTargetScore=e,t)return this.opponentDisplayScore=e,void this.opponentScoreText.setText(this.formatScore(e));this.scene.tweens.add({targets:this,opponentDisplayScore:e,duration:500,ease:"Cubic.easeOut",onUpdate:()=>{this.opponentScoreText.setText(this.formatScore(Math.floor(this.opponentDisplayScore)))},onComplete:()=>{this.pulseScore(this.opponentScoreText),this.updateLeaderIndicator()}})}pulseScore(e){this.scene.tweens.add({targets:e,scale:1.1,duration:150,yoyo:!0,ease:"Power2"})}formatScore(e){return e.toLocaleString()}getPlayerScore(){return this.playerTargetScore}getOpponentScore(){return this.opponentTargetScore}reset(){this.playerScore=0,this.opponentScore=0,this.playerDisplayScore=0,this.opponentDisplayScore=0,this.playerTargetScore=0,this.opponentTargetScore=0,this.playerScoreText.setText("0"),this.opponentScoreText.setText("0")}updateLeaderIndicator(){const e=this.playerTargetScore,t=this.opponentTargetScore;let s="tie";e>t?s="player":t>e&&(s="opponent"),s!==this.currentLeader&&(this.playerLeadIndicator.setVisible("player"===s),this.opponentLeadIndicator.setVisible("opponent"===s),"player"===s?(this.animateLeader(this.playerLeadIndicator),this.playerContainer.setScale(1.02),this.opponentContainer.setScale(1)):"opponent"===s?(this.animateLeader(this.opponentLeadIndicator),this.opponentContainer.setScale(1.02),this.playerContainer.setScale(1)):(this.playerContainer.setScale(1),this.opponentContainer.setScale(1)),this.currentLeader=s)}animateLeader(e){this.scene.tweens.add({targets:e,scale:{from:0,to:1},duration:300,ease:"Back.easeOut"}),this.scene.tweens.add({targets:e,angle:{from:-10,to:10},duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.InOut"})}destroy(){this.scene&&this.scene.tweens&&(this.scene.tweens.killTweensOf(this),this.scene.tweens.killTweensOf(this.playerScoreText),this.scene.tweens.killTweensOf(this.opponentScoreText),this.scene.tweens.killTweensOf(this.playerLeadIndicator),this.scene.tweens.killTweensOf(this.opponentLeadIndicator),this.scene.tweens.killTweensOf(this.playerContainer),this.scene.tweens.killTweensOf(this.opponentContainer)),super.destroy()}}class ie{scene;currentCombo=0;comboMultiplier=1;lastMatchTime=0;comboTimeout=2e3;comboContainers=[];BASE_POINTS={3:10,4:20,5:30,6:40,7:50};COMBO_CONFIGS=[{tier:"",multiplier:1,color:16766720,minBubbles:3},{tier:"COMBO x2",multiplier:1.2,color:65280,minBubbles:4},{tier:"COMBO x3",multiplier:1.5,color:49151,minBubbles:5},{tier:"COMBO x4",multiplier:1.8,color:16729344,minBubbles:6},{tier:"COMBO x5",multiplier:2,color:16716947,minBubbles:7}];CHAIN_BONUS={2:1.1,3:1.2,4:1.3};constructor(e){this.scene=e}createComboDisplay(e,t){const s=this.scene.add.container(e,t);s.setDepth(1200);const i=this.scene.add.text(0,0,"",{fontSize:"24px",color:"#FFFFFF",fontFamily:"Impact, Arial Black",fontStyle:"bold",stroke:"#000000",strokeThickness:4});return i.setOrigin(.5),i.setShadow(3,3,"#000000",5,!0,!0),s.add(i),this.comboContainers.push(s),s}calculateScore(e,t,s,i){const a=this.BASE_POINTS[Math.min(e,7)]||this.BASE_POINTS[7],n=Date.now();n-this.lastMatchTime<this.comboTimeout?this.currentCombo++:this.currentCombo=1,this.lastMatchTime=n;const r=this.getComboConfig(e);this.comboMultiplier=r.multiplier;const o=this.CHAIN_BONUS[Math.min(this.currentCombo,4)]||this.CHAIN_BONUS[4];return Math.floor(a*this.comboMultiplier*o)}getComboConfig(e){for(let t=this.COMBO_CONFIGS.length-1;t>=0;t--)if(e>=this.COMBO_CONFIGS[t].minBubbles)return this.COMBO_CONFIGS[t];return this.COMBO_CONFIGS[0]}showCombo(e,t,s,i,a,n){const r=this.createComboDisplay(s,i),o=r.list[0];a>=4&&this.addComboBackground(r,a,n||e.color);const h=n||e.color;if(3===a)o.setText(`+${t}`),o.setTint(h),o.setFontSize(20);else{o.setText(e.tier),o.setTint(h),o.setFontSize(28),o.setStyle({fontSize:"28px",fontFamily:"Impact, Arial Black",fontStyle:"bold",stroke:"#000000",strokeThickness:5});const s=this.scene.add.text(0,26,`+${t}`,{fontSize:"20px",color:"#FFD700",fontFamily:"Impact, Arial Black",fontStyle:"bold",stroke:"#000000",strokeThickness:3});s.setOrigin(.5),s.setShadow(2,2,"#FF6600",3,!0,!0),r.add(s)}r.setVisible(!0),r.setScale(0),r.setAlpha(1),this.scene.tweens.add({targets:r,scale:{from:0,to:1.1},duration:200,ease:"Back.easeOut",onComplete:()=>{this.scene.tweens.add({targets:r,scale:1,duration:100,ease:"Sine.easeInOut"})}}),this.scene.tweens.add({targets:r,y:r.y-60,duration:1e3,ease:"Cubic.easeOut"}),this.scene.time.delayedCall(800,()=>{this.scene.tweens.add({targets:r,alpha:0,y:r.y-20,scale:.9,duration:400,ease:"Cubic.easeIn",onComplete:()=>{const e=this.comboContainers.indexOf(r);e>-1&&this.comboContainers.splice(e,1),r.destroy(!0)}})}),this.scene.time.delayedCall(300,()=>{this.createParticleEffect(s,i,e,n),a>=6&&this.createImpactFlash(s,i,e)}),a>=5&&this.addComboStars(e,r,a,n),a>=7?(this.scene.cameras.main.shake(200,.008),this.scene.cameras.main.flash(100,255,255,255,!1)):a>=6?(this.scene.cameras.main.shake(150,.005),this.scene.cameras.main.flash(50,255,200,100,!1)):a>=5&&this.scene.cameras.main.shake(100,.003)}addComboStars(e,t,s,i){const a=Math.min(s-4,3);for(let n=0;n<a;n++){const s=20*(n-(a-1)/2),r=this.scene.add.star(s,-20,5,4,8,i||e.color);r.setAlpha(.8),t.add(r),this.scene.tweens.add({targets:r,angle:360,duration:1e3,ease:"Linear"}),this.scene.tweens.add({targets:r,scale:{from:.5,to:.8},alpha:{from:.8,to:1},duration:300,yoyo:!0,repeat:1,ease:"Sine.easeInOut"})}}createParticleEffect(e,t,s,i){let a;a=3===s.minBubbles?8:4===s.minBubbles?16:5===s.minBubbles?30:6===s.minBubbles?50:80,s.minBubbles>=7?this.createFireExplosion(e,t,s,i):s.minBubbles>=6?this.createExplosionEffect(e,t,s,i):s.minBubbles>=5&&this.createColorBurst(e,t,s,i);const n=3===s.minBubbles?[1,2]:4===s.minBubbles?[2,3]:5===s.minBubbles?[2,4]:[3,6],r=3===s.minBubbles?[30,60]:4===s.minBubbles?[40,100]:5===s.minBubbles?[60,150]:[80,250];for(let o=0;o<a;o++){const h=i||s.color,c=Phaser.Math.Between(-.2,.2),l=Phaser.Display.Color.Interpolate.ColorWithColor(Phaser.Display.Color.ValueToColor(h),Phaser.Display.Color.ValueToColor(16777215),100,100*Math.abs(c)),d=Phaser.Display.Color.GetColor(l.r,l.g,l.b),u=this.scene.add.circle(e,t,Phaser.Math.Between(n[0],n[1]),d,3===s.minBubbles?.6:1);u.setDepth(1150);const p=2*Math.PI*o/a,m=Phaser.Math.Between(r[0],r[1]);this.scene.tweens.add({targets:u,x:e+Math.cos(p)*m,y:t+Math.sin(p)*m,alpha:0,scale:{from:1,to:0},duration:3===s.minBubbles?400:Phaser.Math.Between(600,1e3),ease:"Power2.easeOut",delay:o*(3===s.minBubbles?2:5),onComplete:()=>{u.destroy()}})}s.minBubbles>=5&&this.createGlowEffect(e,t,s)}createExplosionEffect(e,t,s,i){const a=i||s.color,n=this.scene.add.graphics();if(n.lineStyle(3,a,1),n.strokeCircle(0,0,20),n.setPosition(e,t),n.setDepth(1049),n.setScale(0),this.scene.tweens.add({targets:n,scale:3,alpha:0,duration:600,ease:"Cubic.easeOut",onComplete:()=>{n.destroy()}}),s.minBubbles>=7)for(let r=0;r<8;r++){const a=2*Math.PI*r/8,n=this.scene.add.star(e+20*Math.cos(a),t+20*Math.sin(a),5,3,6,i||s.color);n.setDepth(1051),n.setScale(0),this.scene.tweens.add({targets:n,x:e+100*Math.cos(a),y:t+100*Math.sin(a),scale:{from:0,to:1},alpha:{from:1,to:0},angle:360,duration:800,delay:50*r,ease:"Cubic.easeOut",onComplete:()=>{n.destroy()}})}}createGlowEffect(e,t,s){for(let i=0;i<3;i++){const a=this.scene.add.circle(e,t,20+10*i,s.color,.4-.1*i);a.setDepth(1048-i),a.setScale(0),this.scene.tweens.add({targets:a,scale:2+.5*i,alpha:0,duration:600+100*i,delay:50*i,ease:"Sine.easeOut",onComplete:()=>{a.destroy()}})}}createColorBurst(e,t,s){const i=[16711680,16744192,16776960,65280,255,9699539];for(let a=0;a<12;a++){const s=2*Math.PI*a/12,n=i[a%i.length],r=this.scene.add.rectangle(e,t,40,4,n);r.setOrigin(0,.5),r.setRotation(s),r.setDepth(1049),r.setScale(0,1),this.scene.tweens.add({targets:r,scaleX:2,alpha:{from:1,to:0},duration:500,ease:"Power2.easeOut",onComplete:()=>{r.destroy()}})}}addComboBackground(e,t,s){if(t>=7){const t=this.scene.add.graphics();t.fillStyle(16739072,.3),t.fillCircle(0,0,40),t.fillStyle(16711680,.2),t.fillCircle(0,0,50),t.setDepth(-1),this.scene.tweens.add({targets:t,scale:{from:.8,to:1.2},alpha:{from:.3,to:.6},duration:300,yoyo:!0,repeat:2,ease:"Sine.easeInOut"}),e.addAt(t,0);for(let s=0;s<6;s++){const t=2*Math.PI*s/6,i=25,a=this.scene.add.circle(Math.cos(t)*i,Math.sin(t)*i,3,16729344,.8);e.add(a),this.scene.tweens.add({targets:a,scale:{from:.5,to:1.5},alpha:{from:.8,to:0},duration:600,delay:50*s,ease:"Power2.easeOut"})}}else if(t>=6){const t=this.scene.add.graphics();t.fillStyle(s,.2),t.fillCircle(0,0,35),t.lineStyle(2,s,.5),t.strokeCircle(0,0,35),t.setDepth(-1),this.scene.tweens.add({targets:t,scale:{from:0,to:1.1},alpha:{from:.5,to:.2},duration:400,ease:"Back.easeOut"}),e.addAt(t,0)}else if(t>=5){const t=this.scene.add.star(0,0,8,15,30,s);t.setAlpha(.25),t.setDepth(-1),this.scene.tweens.add({targets:t,angle:360,scale:{from:0,to:1.2},alpha:{from:.4,to:.1},duration:800,ease:"Power2.easeOut"}),e.addAt(t,0)}else{const t=this.scene.add.circle(0,0,25,s,.15);t.setDepth(-1),this.scene.tweens.add({targets:t,scale:{from:0,to:1},alpha:{from:.3,to:.1},duration:500,ease:"Sine.easeOut"}),e.addAt(t,0)}}createFireExplosion(e,t,s,i){const a=i||s.color,n=[a,Phaser.Display.Color.Interpolate.ColorWithColor(Phaser.Display.Color.ValueToColor(a),Phaser.Display.Color.ValueToColor(16711680),100,30),Phaser.Display.Color.Interpolate.ColorWithColor(Phaser.Display.Color.ValueToColor(a),Phaser.Display.Color.ValueToColor(16766720),100,50)].map(e=>void 0!==e.color?e.color:Phaser.Display.Color.GetColor(e.r,e.g,e.b)),r=this.scene.add.graphics();r.lineStyle(5,a,1),r.strokeCircle(0,0,30),r.setPosition(e,t),r.setDepth(1048),r.setScale(0),this.scene.tweens.add({targets:r,scale:4,alpha:0,duration:400,ease:"Power2.easeOut",onComplete:()=>{r.destroy()}});for(let o=0;o<50;o++){const s=n[Math.floor(Math.random()*n.length)],i=Phaser.Math.Between(3,8),a=this.scene.add.circle(e+Phaser.Math.Between(-20,20),t+Phaser.Math.Between(-20,20),i,s);a.setDepth(1051);const r=Math.random()*Math.PI*2,h=Phaser.Math.Between(100,300),c=e+Math.cos(r)*h,l=t+Math.sin(r)*h-Phaser.Math.Between(50,150);this.scene.tweens.add({targets:a,x:c,y:l,alpha:{from:1,to:0},scale:{from:1.5,to:0},duration:Phaser.Math.Between(600,1e3),delay:10*o,ease:"Cubic.easeOut",onComplete:()=>{a.destroy()}});const d=this.scene.add.circle(a.x,a.y,2*i,s,.3);d.setDepth(1050),this.scene.tweens.add({targets:d,x:c,y:l,alpha:0,scale:2,duration:Phaser.Math.Between(600,1e3),delay:10*o,ease:"Cubic.easeOut",onComplete:()=>{d.destroy()}})}if(s.minBubbles>=7){const s=this.scene.add.text(e,t-50,"🔥",{fontSize:"48px"});s.setOrigin(.5),s.setDepth(1052),s.setScale(0),this.scene.tweens.add({targets:s,scale:{from:0,to:2},alpha:{from:1,to:0},y:t-100,duration:800,ease:"Back.easeOut",onComplete:()=>{s.destroy()}})}}createImpactFlash(e,t,s){const i=this.scene.add.graphics();i.fillStyle(16777215,.8),i.fillCircle(0,0,50),i.setPosition(e,t),i.setDepth(1047),i.setBlendMode(Phaser.BlendModes.ADD),this.scene.tweens.add({targets:i,alpha:0,scale:3,duration:200,ease:"Cubic.easeOut",onComplete:()=>{i.destroy()}});const a=this.scene.add.graphics();a.fillStyle(s.color,.5),a.fillCircle(0,0,80),a.setPosition(e,t),a.setDepth(1046),a.setBlendMode(Phaser.BlendModes.ADD),this.scene.tweens.add({targets:a,alpha:0,scale:2,duration:400,ease:"Sine.easeOut",onComplete:()=>{a.destroy()}})}reset(){this.currentCombo=0,this.comboMultiplier=1,this.lastMatchTime=0,this.comboContainers.forEach(e=>e.destroy(!0)),this.comboContainers=[]}getCurrentCombo(){return this.currentCombo}getMultiplier(){return this.comboMultiplier}}class ae extends e.GameObjects.Container{particles;constructor(e,t,s,i){super(e,e.cameras.main.centerX,e.cameras.main.centerY);const a=e.add.rectangle(0,0,2*e.cameras.main.width,2*e.cameras.main.height,0,.75);a.setInteractive();const n=e.add.rectangle(0,0,400,500,1710638,.95);n.setStrokeStyle(4,16766720);const r=e.add.rectangle(0,-150,350,100,16766720);r.setStrokeStyle(3,16753920);const o=e.add.text(0,-150,"VICTORY!",{fontSize:"52px",color:"#FFFFFF",fontFamily:"Arial Black",fontStyle:"bold"}).setOrigin(.5);o.setShadow(0,0,"#FFD700",10);const h=e.add.text(0,-150,"VICTORY!",{fontSize:"48px",color:"#FFFFFF",fontFamily:"Arial Black",fontStyle:"bold",stroke:"#FF6600",strokeThickness:6}).setOrigin(.5),c=this.createStar(e,-120,-150,20,16766720),l=this.createStar(e,120,-150,20,16766720),d=this.createStar(e,0,-200,15,16753920),u=e.add.rectangle(0,-20,300,80,2899536,.8);u.setStrokeStyle(2,16766720);const p=e.add.text(0,-40,"FINAL SCORE",{fontSize:"20px",color:"#FFD700",fontFamily:"Arial",fontStyle:"bold"}).setOrigin(.5),m=e.add.text(0,-5,"0",{fontSize:"42px",color:"#FFFFFF",fontFamily:"Arial Black",fontStyle:"bold"}).setOrigin(.5),g=e.add.text(0,50,"Great job!",{fontSize:"18px",color:"#FFD700",fontFamily:"Arial"}).setOrigin(.5),y=this.createButton(e,0,130,"PLAY AGAIN",43520,65280,s),b=this.createButton(e,0,200,"MAIN MENU",26316,39423,i);this.add([a,n,r,c,l,d,o,h,u,p,m,g,y,b]),this.setAlpha(0),n.setScale(0),r.setScale(0),h.setScale(0),o.setScale(0),e.tweens.add({targets:this,alpha:1,duration:300,ease:"Power2"}),e.tweens.add({targets:n,scaleX:1,scaleY:1,duration:400,ease:"Back.easeOut",delay:100}),e.tweens.add({targets:[r,h,o],scaleX:1,scaleY:1,duration:500,ease:"Back.easeOut",delay:300}),e.tweens.add({targets:[c,l,d],angle:360,duration:3e3,repeat:-1,ease:"Linear"});const f={value:0};e.tweens.add({targets:f,value:t,duration:1500,ease:"Cubic.easeOut",delay:800,onUpdate:()=>{m.setText(Math.floor(f.value).toString())},onComplete:()=>{e.tweens.add({targets:m,scale:1.1,duration:300,yoyo:!0,ease:"Power2"})}}),this.createConfetti(e),e.cameras.main.shake(300,.005),this.setDepth(2e3),e.add.existing(this)}createStar(e,t,s,i,a){const n=e.add.star(t,s,5,.5*i,i,a);return n.setStrokeStyle(2,16777215),n}createButton(e,t,s,i,a,n,r){const o=e.add.container(t,s),h=e.add.rectangle(0,0,220,55,a);h.setInteractive({useHandCursor:!0}),h.setStrokeStyle(3,16777215);const c=e.add.rectangle(0,3,220,55,0,.3);c.setDepth(-1);const l=e.add.text(0,0,i,{fontSize:"22px",color:"#FFFFFF",fontFamily:"Arial Black",fontStyle:"bold"}).setOrigin(.5);return o.add([c,h,l]),h.on("pointerover",()=>{h.setFillStyle(n),e.tweens.add({targets:[h,l],scale:1.05,duration:100,ease:"Power2"})}),h.on("pointerout",()=>{h.setFillStyle(a),e.tweens.add({targets:[h,l],scale:1,duration:100,ease:"Power2"})}),h.on("pointerdown",()=>{e.events.emit("ui-click");try{r&&"function"==typeof r&&r()}catch(t){}e.tweens.add({targets:o,scale:.9,duration:100,yoyo:!0,ease:"Power2"})}),o.setScale(0),e.tweens.add({targets:o,scale:1,duration:400,ease:"Back.easeOut",delay:1e3+(s>150?200:0)}),o}createConfetti(t){const s=[16766720,16753920,16738740,52945,10025880,16737095],i=t.time.addEvent({delay:100,repeat:30,callback:()=>{for(let i=0;i<6;i++){const i=e.Math.Between(-100,100),a=-250,n=Math.random()>.5?t.add.circle(i,a,e.Math.Between(3,6),e.Utils.Array.GetRandom(s),.9):t.add.rectangle(i,a,e.Math.Between(8,12),e.Math.Between(4,6),e.Utils.Array.GetRandom(s),.9);n.setRotation(Math.random()*Math.PI*2),this.add(n);const r=e.Math.Between(-110,-70)*Math.PI/180,o=e.Math.Between(100,350),h=Math.cos(r)*o,c=Math.sin(r)*o;t.tweens.add({targets:n,x:n.x+h,y:n.y+c+600,rotation:n.rotation+e.Math.Between(-6,6),alpha:0,scale:0,duration:3e3,ease:"Power2",onComplete:()=>n.destroy()})}}});t.time.delayedCall(3e3,()=>{i.destroy()})}destroy(){this.scene.tweens.killTweensOf(this),super.destroy()}}class ne extends e.GameObjects.Container{constructor(e,t,s,i){super(e,e.cameras.main.centerX,e.cameras.main.centerY);const a=e.add.rectangle(0,0,2*e.cameras.main.width,2*e.cameras.main.height,0,.85);a.setInteractive();const n=e.add.rectangle(0,0,400,450,2894910,.95);n.setStrokeStyle(3,8087790);const r=e.add.rectangle(0,-140,350,90,4915330,.9);r.setStrokeStyle(2,8087790);const o=e.add.text(0,-140,"GAME OVER",{fontSize:"42px",color:"#FFFFFF",fontFamily:"Arial Black",fontStyle:"bold"}).setOrigin(.5);o.setShadow(2,2,"#000000",5);const h=e.add.text(0,-80,"Don't give up!",{fontSize:"20px",color:"#FFD700",fontFamily:"Arial",fontStyle:"italic"}).setOrigin(.5),c=e.add.rectangle(0,-10,280,70,1710638,.8);c.setStrokeStyle(2,8087790);const l=e.add.text(0,-28,"YOUR SCORE",{fontSize:"18px",color:"#B8B8B8",fontFamily:"Arial"}).setOrigin(.5),d=e.add.text(0,2,t.toString(),{fontSize:"36px",color:"#FFFFFF",fontFamily:"Arial Black",fontStyle:"bold"}).setOrigin(.5);let u="You can do better!";t>1e3&&(u="Great effort!"),t>5e3&&(u="So close! Try again!"),t>1e4&&(u="Amazing score! Almost there!");const p=e.add.text(0,50,u,{fontSize:"18px",color:"#FFA500",fontFamily:"Arial"}).setOrigin(.5),m=this.createButton(e,0,120,"TRY AGAIN",16739179,16748174,!0,s),g=this.createButton(e,0,185,"Main Menu",6053002,8158378,!1,i);this.add([a,n,r,o,h,c,l,d,p,m,g]),this.setAlpha(0),n.setScale(.8),o.setScale(0),e.tweens.add({targets:this,alpha:1,duration:500,ease:"Power2"}),e.tweens.add({targets:n,scaleX:1,scaleY:1,duration:600,ease:"Quad.easeOut",delay:100}),e.tweens.add({targets:o,scaleX:1,scaleY:1,duration:400,ease:"Quad.easeOut",delay:300}),e.tweens.add({targets:h,scale:1.05,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),d.setScale(0),e.tweens.add({targets:d,scale:1,duration:400,ease:"Back.easeOut",delay:500}),this.createFloatingBubbles(e),this.setDepth(2e3),e.add.existing(this)}createButton(e,t,s,i,a,n,r,o){const h=e.add.container(t,s),c=r?240:200,l=r?60:50,d=r?"24px":"20px",u=e.add.rectangle(0,0,c,l,a);u.setInteractive({useHandCursor:!0}),u.setStrokeStyle(r?3:2,16777215);const p=e.add.rectangle(0,3,c,l,0,.3);p.setDepth(-1);const m=e.add.text(0,0,i,{fontSize:d,color:"#FFFFFF",fontFamily:r?"Arial Black":"Arial",fontStyle:"bold"}).setOrigin(.5);return h.add([p,u,m]),r&&e.tweens.add({targets:u,scale:1.05,duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),u.on("pointerover",()=>{u.setFillStyle(n),e.tweens.add({targets:[u,m],scale:1.1,duration:100,ease:"Power2"})}),u.on("pointerout",()=>{u.setFillStyle(a),e.tweens.add({targets:[u,m],scale:1,duration:100,ease:"Power2"})}),u.on("pointerdown",()=>{e.events.emit("ui-click");try{o&&"function"==typeof o&&o()}catch(t){}e.tweens.add({targets:h,scale:.9,duration:100,yoyo:!0,ease:"Power2"})}),h.setAlpha(0),e.tweens.add({targets:h,alpha:1,duration:500,ease:"Power2",delay:800+(r?0:200)}),h}createFloatingBubbles(t){const s=[8087790,4915330,6970061];for(let i=0;i<5;i++){const a=e.Math.Between(-150,150),n=e.Math.Between(-200,200),r=t.add.circle(a,n,15,s[i%s.length],.2);this.add(r),t.tweens.add({targets:r,y:n-30,duration:3e3+500*i,yoyo:!0,repeat:-1,ease:"Sine.easeInOut",delay:200*i}),t.tweens.add({targets:r,x:a+e.Math.Between(-20,20),duration:2e3+300*i,yoyo:!0,repeat:-1,ease:"Sine.easeInOut",delay:150*i})}}destroy(){this.scene.tweens.killTweensOf(this),super.destroy()}}class re{type="floating_text";active=!1;gameObject;scene;text;tween;constructor(e){this.scene=e,this.gameObject=e.add.container(0,0),this.gameObject.setDepth(1200),this.text=e.add.text(0,0,"",{fontSize:"25px",color:"#FFFFFF",fontFamily:"Arial Black",fontStyle:"bold",stroke:"#000000",strokeThickness:5}),this.text.setOrigin(.5),this.text.setShadow(2.5,2.5,"#000000",5,!0,!0),this.gameObject.add(this.text),this.deactivate()}reset(){this.tween&&(this.tween.stop(),this.tween=void 0),this.gameObject.setScale(1),this.gameObject.setAlpha(1),this.gameObject.setPosition(0,0)}activate(e,t,s,i,a=1e3){this.reset(),this.active=!0,this.gameObject.setVisible(!0),this.gameObject.setPosition(e,t),this.text.setText(s),this.text.setTint(i),s.includes("PERFECT")?this.text.setFontSize("45px"):s.includes("AMAZING")||s.includes("GREAT")?this.text.setFontSize("42.5px"):s.includes("GOOD")?this.text.setFontSize("40px"):s.includes("CHAIN")?this.text.setFontSize("42.5px"):(s.includes("DROP"),this.text.setFontSize("40px")),this.gameObject.setScale(0);const n=s.includes("PERFECT")||s.includes("AMAZING")||s.includes("GREAT")||s.includes("GOOD")||s.includes("CHAIN")?1.1:1;this.scene.tweens.add({targets:this.gameObject,scale:{from:0,to:n},duration:250,ease:"Back.easeOut",onComplete:()=>{this.scene.tweens.add({targets:this.gameObject,scale:1,duration:100,ease:"Sine.easeInOut"})}}),this.tween=this.scene.tweens.add({targets:this.gameObject,y:t-60,alpha:0,duration:a,delay:300,ease:"Cubic.easeOut",onComplete:()=>{this.deactivate()}})}deactivate(){this.active=!1,this.gameObject.setVisible(!1),this.reset()}}class oe{type="particle_burst";active=!1;gameObject;scene;particles=[];tweens=[];MAX_PARTICLES=30;constructor(e){this.scene=e,this.gameObject=e.add.container(0,0),this.gameObject.setDepth(1150);for(let t=0;t<this.MAX_PARTICLES;t++){const t=e.add.circle(0,0,3,16777215);t.setVisible(!1),this.particles.push(t),this.gameObject.add(t)}this.deactivate()}reset(){this.tweens.forEach(e=>e.stop()),this.tweens=[],this.particles.forEach(e=>{e.setVisible(!1),e.setPosition(0,0),e.setScale(1),e.setAlpha(1)})}activate(e,t,s,i=20,a=1){this.reset(),this.active=!0,this.gameObject.setVisible(!0),this.gameObject.setPosition(e,t);const n=Math.min(i,this.MAX_PARTICLES),r=100*a;for(let o=0;o<n;o++){const e=this.particles[o];e.setVisible(!0),e.setFillStyle(s),e.setRadius(Phaser.Math.Between(2,4));const t=2*Math.PI*o/n,i=Phaser.Math.Between(.5*r,1.5*r),a=this.scene.tweens.add({targets:e,x:Math.cos(t)*i,y:Math.sin(t)*i,alpha:0,scale:0,duration:Phaser.Math.Between(400,800),ease:"Power2.easeOut",delay:5*o,onComplete:()=>{e.setVisible(!1),o===n-1&&this.deactivate()}});this.tweens.push(a)}}deactivate(){this.active=!1,this.gameObject.setVisible(!1),this.reset()}}class he{type="ring_explosion";active=!1;gameObject;scene;tween;constructor(e){this.scene=e,this.gameObject=e.add.graphics(),this.gameObject.setDepth(1049),this.deactivate()}reset(){this.tween&&(this.tween.stop(),this.tween=void 0),this.gameObject.clear(),this.gameObject.setScale(1),this.gameObject.setAlpha(1)}activate(e,t,s,i=30){this.reset(),this.active=!0,this.gameObject.setVisible(!0),this.gameObject.setPosition(e,t),this.gameObject.lineStyle(5,s,1),this.gameObject.strokeCircle(0,0,i),this.gameObject.setScale(0),this.tween=this.scene.tweens.add({targets:this.gameObject,scale:3,alpha:0,duration:600,ease:"Cubic.easeOut",onComplete:()=>{this.deactivate()}})}deactivate(){this.active=!1,this.gameObject.setVisible(!1),this.reset()}}class ce{scene;pools=new Map;activeEffects=[];POOL_SIZES={floating_text:20,particle_burst:10,ring_explosion:8,star_burst:6,combo_display:10};constructor(e){this.scene=e,this.initializePools()}initializePools(){this.createPool("floating_text",()=>new re(this.scene)),this.createPool("particle_burst",()=>new oe(this.scene)),this.createPool("ring_explosion",()=>new he(this.scene))}createPool(e,t){const s=[],i=this.POOL_SIZES[e]||10;for(let a=0;a<i;a++)s.push(t());this.pools.set(e,s)}getEffect(e){const t=this.pools.get(e);if(!t)return null;for(const i of t)if(!i.active)return this.activeEffects.push(i),i;const s=t[0];return s.deactivate(),this.activeEffects.push(s),s}showFloatingText(e,t,s,i=16766720,a=1e3){const n=this.getEffect("floating_text");n&&n.activate(e,t,s,i,a)}showParticleBurst(e,t,s,i=20,a=1){const n=this.getEffect("particle_burst");n&&n.activate(e,t,s,i,a)}showRingExplosion(e,t,s,i=30){const a=this.getEffect("ring_explosion");a&&a.activate(e,t,s,i)}showComboEffect(e,t,s,i,a){this.showFloatingText(e,t-20,`+${i}`,a),s>=2&&this.showParticleBurst(e,t,a,10*s,.5*s),s>=4&&this.showRingExplosion(e,t,a,20+5*s)}update(e){this.activeEffects=this.activeEffects.filter(t=>(t.active&&t.update&&t.update(e),t.active))}reset(){this.pools.forEach(e=>{e.forEach(e=>e.deactivate())}),this.activeEffects=[]}destroy(){this.reset(),this.pools.forEach(e=>{e.forEach(e=>{e.gameObject&&e.gameObject.destroy()})}),this.pools.clear()}}class le{scene;effectPool;feedbackQueue=[];activeFeedbacks=[];processing=!1;MIN_VERTICAL_SPACING=35;MIN_HORIZONTAL_SPACING=50;FEEDBACK_DURATION=1500;MAX_QUEUE_SIZE=30;constructor(e){this.scene=e,this.effectPool=new ce(e),this.startProcessing()}startProcessing(){this.scene.time.addEvent({delay:16,callback:this.processQueue,callbackScope:this,loop:!0})}queueFeedback(e,t){this.feedbackQueue.push({result:e,position:t,timestamp:Date.now()}),this.feedbackQueue.length>this.MAX_QUEUE_SIZE&&this.feedbackQueue.shift()}processQueue(){if(this.processing||0===this.feedbackQueue.length)return;this.processing=!0;const e=Date.now();this.activeFeedbacks=this.activeFeedbacks.filter(t=>t.endTime>e);const t=Math.min(3,this.feedbackQueue.length);for(let s=0;s<t;s++){const e=this.feedbackQueue.shift();e&&this.showFeedback(e)}this.processing=!1}showFeedback(e){const{result:t,position:s}=e,i=this.calculateOffset(s),a={x:s.x+i.x,y:s.y+i.y};this.activeFeedbacks.push({position:a,endTime:Date.now()+this.FEEDBACK_DURATION}),this.showEffectsForLevel(t,a)}calculateOffset(e){let t=0,s=0,i=0;for(const a of this.activeFeedbacks){const n=Math.abs(e.x-a.position.x),r=Math.abs(e.y-a.position.y);n<this.MIN_HORIZONTAL_SPACING&&r<this.MIN_VERTICAL_SPACING&&(i++,i%2==0?s-=this.MIN_VERTICAL_SPACING:s+=this.MIN_VERTICAL_SPACING,t=20*(i%3-1))}return{x:t,y:s}}showEffectsForLevel(e,t){const{visualEffectLevel:s,displayText:i,color:a,finalScore:n}=e;switch(this.effectPool.showFloatingText(t.x,t.y,i,a,800+150*s),s){case 1:this.effectPool.showParticleBurst(t.x,t.y,a,6,.4),this.createSparkleEffect(t.x,t.y,a,3),this.createPopEffect(t.x,t.y,a,.8);break;case 2:this.effectPool.showParticleBurst(t.x,t.y,a,12,.6),this.createSparkleEffect(t.x,t.y,a,5),this.createPopEffect(t.x,t.y,a,1),this.addScreenShake(30,.001);break;case 3:this.effectPool.showParticleBurst(t.x,t.y,a,25,.9),this.effectPool.showRingExplosion(t.x,t.y,a,20),this.createSparkleEffect(t.x,t.y,a,8),this.addScreenShake(80,.002);break;case 4:this.effectPool.showParticleBurst(t.x,t.y,a,40,1.2),this.effectPool.showRingExplosion(t.x,t.y,a,30),this.createSparkleEffect(t.x,t.y,a,12),this.addScreenShake(120,.004),this.addCameraFlash(40,a);break;case 5:this.effectPool.showParticleBurst(t.x,t.y,a,60,1.4),this.effectPool.showRingExplosion(t.x,t.y,a,40),this.createFireEffect(t.x,t.y,a),this.createSparkleEffect(t.x,t.y,a,20),this.addScreenShake(180,.006),this.addCameraFlash(80,a)}}createSparkleEffect(e,t,s,i){for(let a=0;a<i;a++){const i=this.scene.add.star(e+Phaser.Math.Between(-20,20),t+Phaser.Math.Between(-20,20),4,2,4,s);i.setDepth(1150),i.setScale(0),i.setAlpha(.8),this.scene.tweens.add({targets:i,scale:{from:0,to:Phaser.Math.FloatBetween(.3,.6)},alpha:{from:.8,to:0},angle:360,duration:Phaser.Math.Between(600,900),delay:50*a,ease:"Sine.easeOut",onComplete:()=>{i.destroy()}})}}createPopEffect(e,t,s,i){const a=this.scene.add.circle(e,t,15,s,.3);a.setDepth(1140),a.setScale(0),a.setBlendMode(Phaser.BlendModes.ADD),this.scene.tweens.add({targets:a,scale:i,alpha:0,duration:300,ease:"Back.easeOut",onComplete:()=>{a.destroy()}})}createFireEffect(e,t,s){for(let i=0;i<30;i++){const a=2*Math.PI*i/30,n=Phaser.Math.Between(50,150),r=this.scene.add.circle(e+10*Math.cos(a),t+10*Math.sin(a),Phaser.Math.Between(3,6),s);r.setDepth(1051),r.setBlendMode(Phaser.BlendModes.ADD);const o=e+Math.cos(a)*n,h=t+Math.sin(a)*n-Phaser.Math.Between(20,60);this.scene.tweens.add({targets:r,x:o,y:h,alpha:{from:1,to:0},scale:{from:1.5,to:0},duration:Phaser.Math.Between(600,1e3),delay:10*i,ease:"Cubic.easeOut",onComplete:()=>{r.destroy()}})}}addScreenShake(e,t){this.scene.cameras.main.shake(e,t)}addCameraFlash(e,t){const s=Phaser.Display.Color.IntegerToColor(t);this.scene.cameras.main.flash(e,s.red,s.green,s.blue,!1)}update(e){this.effectPool.update(e)}reset(){this.feedbackQueue=[],this.activeFeedbacks=[],this.effectPool.reset()}destroy(){this.reset(),this.effectPool.destroy()}}var de,ue,pe=(e=>(e.NORMAL="crosshair",e.RAINBOW="rainbow_sphere",e.LASER="extended_line",e.BOMB_NORMAL="explosion_radius",e.BOMB_BALLISTIC="ballistic_arc",e.LIGHTNING="selection_cursor",e.FREEZE="snowflake_area",e.MULTI="triple_arrow",e))(pe||{});class me{scene;currentMode="crosshair";aimingGraphics;trajectoryLine;cursorSprite;modeIndicator;activePowerUp;trajectoryPoints=[];MAX_BOUNCES=3;TRAJECTORY_STEPS=50;constructor(e){this.scene=e,this.aimingGraphics=e.add.graphics(),this.aimingGraphics.setDepth(G),this.aimingGraphics.setVisible(!1),this.trajectoryLine=e.add.graphics(),this.trajectoryLine.setDepth(G-1),this.trajectoryLine.setVisible(!1)}setMode(e,t){this.currentMode=e,this.activePowerUp=t,this.clearGraphics(),"crosshair"!==e?(this.aimingGraphics.setVisible(!0),this.trajectoryLine?.setVisible(!0)):(this.aimingGraphics.setVisible(!1),this.trajectoryLine?.setVisible(!1)),this.createModeIndicator(),this.updateCursorStyle()}updateAiming(e,t,s,i){switch(this.clearGraphics(),this.currentMode){case"crosshair":this.drawNormalCrosshair(e,t),this.drawBasicTrajectory(s,i,e,t);break;case"rainbow_sphere":this.drawRainbowCrosshair(e,t),this.drawBasicTrajectory(s,i,e,t);break;case"extended_line":this.drawLaserSight(s,i,e,t);break;case"explosion_radius":this.drawBombRadius(e,t),this.drawBasicTrajectory(s,i,e,t);break;case"ballistic_arc":this.drawBallisticArc(s,i,e,t);break;case"selection_cursor":this.drawSelectionCursor(e,t);break;case"snowflake_area":this.drawFreezeArea(e,t);break;case"triple_arrow":this.drawTripleArrow(s,i,e,t)}}drawNormalCrosshair(e,t){this.aimingGraphics.lineStyle(2,16777215,.8),this.aimingGraphics.beginPath(),this.aimingGraphics.moveTo(e-10,t),this.aimingGraphics.lineTo(e+10,t),this.aimingGraphics.moveTo(e,t-10),this.aimingGraphics.lineTo(e,t+10),this.aimingGraphics.strokePath(),this.aimingGraphics.strokeCircle(e,t,15)}drawRainbowCrosshair(e,t){const s=[16711680,16776960,65280,65535,255,16711935];for(let i=0;i<6;i++){const a=i/6*Math.PI*2,n=(i+1)/6*Math.PI*2;this.aimingGraphics.lineStyle(3,s[i],.8),this.aimingGraphics.beginPath(),this.aimingGraphics.arc(e,t,20,a,n),this.aimingGraphics.strokePath()}this.aimingGraphics.fillStyle(16777215,1),this.aimingGraphics.fillCircle(e,t,3)}drawLaserSight(e,t,s,i){this.calculateTrajectory(e,t,s,i,!0),this.trajectoryLine.lineStyle(3,16711680,1),this.trajectoryLine.lineBetween(this.trajectoryPoints[0].x,this.trajectoryPoints[0].y,this.trajectoryPoints[0].x,this.trajectoryPoints[0].y);const a=.001*Date.now();for(let r=0;r<this.trajectoryPoints.length-1;r++){const e=1-r/this.trajectoryPoints.length*.5,t=3-r/this.trajectoryPoints.length*2,s=.3*Math.sin(3*a+.2*r)+.7;this.trajectoryLine.lineStyle(t,16711680,e*s),this.trajectoryLine.lineBetween(this.trajectoryPoints[r].x,this.trajectoryPoints[r].y,this.trajectoryPoints[r+1].x,this.trajectoryPoints[r+1].y)}const n=this.trajectoryPoints[this.trajectoryPoints.length-1];this.aimingGraphics.fillStyle(16711680,1),this.aimingGraphics.fillCircle(n.x,n.y,5)}drawBombRadius(e,t){const s=100;this.aimingGraphics.lineStyle(2,16729344,.3),this.aimingGraphics.fillStyle(16729344,.1),this.aimingGraphics.fillCircle(e,t,s),this.aimingGraphics.strokeCircle(e,t,s),this.aimingGraphics.lineStyle(1,16737095,.5),this.aimingGraphics.strokeCircle(e,t,66),this.aimingGraphics.strokeCircle(e,t,33),this.aimingGraphics.fillStyle(16711680,1),this.aimingGraphics.fillCircle(e,t,5);if(!this.cursorSprite){const i=this.scene.add.text(e,t-s-20,"💣",{fontSize:"24px"});i.setOrigin(.5),i.setDepth(G+1),this.scene.time.delayedCall(50,()=>i.destroy())}}drawBallisticArc(e,t,s,i){const a=[],n=Math.min(t,i)-100;for(let r=0;r<=30;r++){const o=r/30,h=Phaser.Math.Linear(e,s,o),c=Phaser.Math.Linear(t,i,o)-Math.sin(o*Math.PI)*(t-n);a.push(new Phaser.Geom.Point(h,c))}this.trajectoryLine.lineStyle(3,16711680,.5);for(let r=0;r<a.length-1;r++){const e=.5+r/a.length*.5;this.trajectoryLine.lineStyle(2,16729344,e),this.trajectoryLine.lineBetween(a[r].x,a[r].y,a[r+1].x,a[r+1].y)}this.aimingGraphics.fillStyle(16711680,.3),this.aimingGraphics.fillCircle(s,i,30),this.aimingGraphics.lineStyle(3,16711680,1),this.aimingGraphics.strokeCircle(s,i,30)}drawSelectionCursor(e,t){const s=20;this.aimingGraphics.lineStyle(3,16776960,1),this.aimingGraphics.beginPath(),this.aimingGraphics.moveTo(e-s,t-s+5),this.aimingGraphics.lineTo(e-s,t-s),this.aimingGraphics.lineTo(e-s+5,t-s),this.aimingGraphics.strokePath(),this.aimingGraphics.beginPath(),this.aimingGraphics.moveTo(e+s-5,t-s),this.aimingGraphics.lineTo(e+s,t-s),this.aimingGraphics.lineTo(e+s,t-s+5),this.aimingGraphics.strokePath(),this.aimingGraphics.beginPath(),this.aimingGraphics.moveTo(e-s,t+s-5),this.aimingGraphics.lineTo(e-s,t+s),this.aimingGraphics.lineTo(e-s+5,t+s),this.aimingGraphics.strokePath(),this.aimingGraphics.beginPath(),this.aimingGraphics.moveTo(e+s-5,t+s),this.aimingGraphics.lineTo(e+s,t+s),this.aimingGraphics.lineTo(e+s,t+s-5),this.aimingGraphics.strokePath(),this.aimingGraphics.lineStyle(2,16776960,1),this.aimingGraphics.beginPath(),this.aimingGraphics.moveTo(e-5,t-10),this.aimingGraphics.lineTo(e+2,t),this.aimingGraphics.lineTo(e-2,t),this.aimingGraphics.lineTo(e+5,t+10),this.aimingGraphics.strokePath()}drawFreezeArea(e,t){this.aimingGraphics.fillStyle(8900331,.2),this.aimingGraphics.fillCircle(e,t,150);for(let s=0;s<6;s++){const i=s/6*Math.PI*2,a=e+150*Math.cos(i)*.7,n=t+150*Math.sin(i)*.7;this.aimingGraphics.lineStyle(2,16777215,.8),this.aimingGraphics.beginPath();for(let e=0;e<6;e++){const t=e/6*Math.PI*2;this.aimingGraphics.moveTo(a,n),this.aimingGraphics.lineTo(a+10*Math.cos(t),n+10*Math.sin(t))}this.aimingGraphics.strokePath()}}drawTripleArrow(e,t,s,i){const a=Math.atan2(i-t,s-e);[-15,0,15].forEach((s,i)=>{const n=a+Phaser.Math.DegToRad(s),r=e+200*Math.cos(n),o=t+200*Math.sin(n),h=[16739179,16777215,7039999];this.trajectoryLine.lineStyle(2,h[i],.6),this.trajectoryLine.lineBetween(e,t,r,o),this.drawArrowHead(r,o,n,h[i])})}drawArrowHead(e,t,s,i){const a=s-Phaser.Math.DegToRad(150),n=s+Phaser.Math.DegToRad(150);this.aimingGraphics.lineStyle(2,i,.8),this.aimingGraphics.beginPath(),this.aimingGraphics.moveTo(e,t),this.aimingGraphics.lineTo(e+10*Math.cos(a),t+10*Math.sin(a)),this.aimingGraphics.moveTo(e,t),this.aimingGraphics.lineTo(e+10*Math.cos(n),t+10*Math.sin(n)),this.aimingGraphics.strokePath()}drawBasicTrajectory(e,t,s,i){this.trajectoryLine.lineStyle(1,16777215,.5);const a=Phaser.Math.Distance.Between(e,t,s,i),n=Math.floor(a/20);for(let r=0;r<n;r+=2){const a=r/n,o=Math.min((r+1)/n,1),h=Phaser.Math.Linear(e,s,a),c=Phaser.Math.Linear(t,i,a),l=Phaser.Math.Linear(e,s,o),d=Phaser.Math.Linear(t,i,o);this.trajectoryLine.lineBetween(h,c,l,d)}}calculateTrajectory(e,t,s,i,a=!1){this.trajectoryPoints=[];const n=Math.atan2(i-t,s-e);let r=e,o=t,h=10*Math.cos(n),c=10*Math.sin(n),l=0;const d=a?200:100,u=this.scene.cameras.main.width;for(let p=0;p<d&&(this.trajectoryPoints.push(new Phaser.Geom.Point(r,o)),r+=h,o+=c,(r<=10||r>=u-10)&&l<this.MAX_BOUNCES&&(h=-h,l++),!(o<=0||o>=this.scene.cameras.main.height));p++);}createModeIndicator(){this.modeIndicator&&this.modeIndicator.destroy();const e=this.scene.cameras.main.centerX;this.modeIndicator=this.scene.add.container(e,50),this.modeIndicator.setDepth(G+10);const t=this.scene.add.graphics();t.fillStyle(0,.7),t.fillRoundedRect(-60,-20,120,40,10),this.modeIndicator.add(t);const s={crosshair:"NORMAL",rainbow_sphere:"🌈 RAINBOW",extended_line:"🎯 LASER",explosion_radius:"💣 BOMB",ballistic_arc:"💣 BALLISTIC",selection_cursor:"⚡ LIGHTNING",snowflake_area:"❄️ FREEZE",triple_arrow:"🎱 MULTI"},i=this.scene.add.text(0,0,s[this.currentMode],{fontSize:"16px",fontFamily:"Arial Black",color:"#FFFFFF"});i.setOrigin(.5),this.modeIndicator.add(i),this.modeIndicator.setAlpha(0),this.scene.tweens.add({targets:this.modeIndicator,alpha:1,duration:300,ease:"Cubic.easeOut"})}updateCursorStyle(){const e=this.scene.game.canvas;switch(this.currentMode){case"selection_cursor":case"ballistic_arc":e.style.cursor="crosshair";break;default:e.style.cursor="default"}}clearGraphics(){this.aimingGraphics.clear(),this.trajectoryLine&&this.trajectoryLine.clear()}getTargetingInfo(){return{mode:this.currentMode,position:{x:0,y:0},trajectory:this.trajectoryPoints}}reset(){this.setMode("crosshair"),this.clearGraphics(),this.modeIndicator&&(this.modeIndicator.destroy(),this.modeIndicator=void 0)}destroy(){this.reset(),this.aimingGraphics.destroy(),this.trajectoryLine&&this.trajectoryLine.destroy(),this.cursorSprite&&this.cursorSprite.destroy()}}class ge{type=H.RAINBOW;rainbowBubble;visualElements=[];activate(e){e.aimingMode.setMode(pe.RAINBOW,this.type);const t=e.scene.add.text(e.scene.cameras.main.centerX,e.scene.cameras.main.centerY,"🌈 RAINBOW BUBBLE!",{fontSize:"28px",fontFamily:"Arial Black",color:"#FF69B4",stroke:"#000000",strokeThickness:3});t.setOrigin(.5),t.setDepth(1e3),e.scene.tweens.add({targets:t,scale:{from:0,to:1.2},alpha:{from:1,to:0},y:t.y-50,duration:1500,ease:"Power2",onComplete:()=>t.destroy()}),e.shotsRemaining=1}applyRainbowEffect(e){const t=e.scene.add.graphics();t.setDepth(e.depth+1),e.scene.time.addEvent({delay:100,callback:()=>{if(!e||!e.scene)return;t.clear();const s=.001*Date.now(),i=[16711680,16776960,65280,65535,255,16711935];for(let a=0;a<6;a++){const n=a/6*Math.PI*2,r=(a+1)/6*Math.PI*2,o=Math.floor((s+a)%i.length);t.lineStyle(2,i[o],.8),t.beginPath(),t.arc(e.x,e.y,18,n,r),t.strokePath()}},loop:!0})}deactivate(e){if(this.rainbowBubble){const e=this.rainbowBubble.getData("rainbowShimmer");e&&e.destroy()}e.aimingMode.setMode(pe.NORMAL)}}class ye{type=H.LASER;remainingShots=5;visualElements=[];activate(e){e.aimingMode.setMode(pe.LASER,this.type),this.remainingShots=5,e.shotsRemaining=5,this.createShotCounter(e)}createShotCounter(e){const t=e.scene.add.container(100,100);t.setDepth(G+10);const s=e.scene.add.graphics();s.fillStyle(0,.7),s.fillRoundedRect(-40,-20,80,40,10),t.add(s);const i=e.scene.add.text(0,0,`🎯 ${this.remainingShots}`,{fontSize:"20px",fontFamily:"Arial Black",color:"#FF0000"});i.setOrigin(.5),t.add(i)}update(e,t){const s=e.launcher.getData("laserCounterText");s&&void 0!==e.shotsRemaining&&s.setText(`🎯 ${e.shotsRemaining}`)}deactivate(e){const t=e.launcher.getData("laserCounter");t&&t.destroy(),e.aimingMode.setMode(pe.NORMAL)}}class be{type=H.BOMB;targetMode="bubbles";visualElements=[];activate(e){this.targetMode=e.targetMode||"bubbles","castle"===this.targetMode&&e.opponentLauncher?(e.aimingMode.setMode(pe.BOMB_BALLISTIC,this.type),this.prepareBallistic(e)):(e.aimingMode.setMode(pe.BOMB_NORMAL,this.type),this.prepareNormalBomb(e)),e.shotsRemaining=1}prepareNormalBomb(e){const t=e.launcher.x,s=e.launcher.y,i=e.scene.add.graphics();i.setDepth(999),this.visualElements.push(i);let a=0;const n=e.scene.time.addEvent({delay:50,callback:()=>{i.clear();for(let e=0;e<3;e++){const n=(a+15*e)%60,r=Math.max(0,1-n/60);i.lineStyle(3,16729344,.5*r),i.strokeCircle(t,s-30,n)}a=(a+2)%60},loop:!0}),r=e.scene.add.container(t,s-30);r.setDepth(1e3),this.visualElements.push(r);const o=e.scene.time.addEvent({delay:100,callback:()=>{for(let t=0;t<2;t++){const t=e.scene.add.circle(0,0,Phaser.Math.Between(2,4),Phaser.Math.RND.pick([16729344,16737536,16755200]));t.setBlendMode(Phaser.BlendModes.ADD),r.add(t);const s=Phaser.Math.Between(-110,-70)*Math.PI/180,i=Phaser.Math.Between(100,200),a=Math.cos(s)*i,n=Math.sin(s)*i;e.scene.tweens.add({targets:t,x:t.x+.6*a,y:t.y+.6*n,scale:{from:1,to:0},alpha:{from:1,to:0},duration:600,ease:"Sine.easeOut",onComplete:()=>t.destroy()})}},loop:!0});this.sparkTimer=o;const h=e.scene.add.circle(t,s-30,8,16729344);h.setDepth(1001),this.visualElements.push(h),e.scene.tweens.add({targets:h,scale:{from:.8,to:1.3},alpha:{from:1,to:.6},duration:400,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const c=e.scene.add.text(t,s-60,"BOMB ARMED",{fontSize:"14px",fontFamily:"Arial Black",color:"#FFFFFF",stroke:"#FF4500",strokeThickness:4,shadow:{offsetX:2,offsetY:2,color:"#000000",blur:4,fill:!0}});c.setOrigin(.5),c.setDepth(1002),this.visualElements.push(c),e.scene.tweens.add({targets:c,alpha:{from:0,to:1},scale:{from:1.5,to:1},duration:300,ease:"Back.easeOut"}),this.glowTimer=n}prepareBallistic(e){e.opponentLauncher}explodeAt(e,t,s){const i=120,a=s.scene.add.graphics();a.setDepth(I-1);let n=0;const r=s.scene.time.addEvent({delay:20,callback:()=>{if(a.clear(),n<240){const s=Math.max(0,1-n/240);a.lineStyle(4,16777215,s),a.strokeCircle(e,t,n),a.lineStyle(8,16729344,.5*s),a.strokeCircle(e,t,.9*n),n+=8}else r.destroy(),a.destroy()},loop:!0}),o=s.scene.add.circle(e,t,36,16777215,1);o.setDepth(I),o.setBlendMode(Phaser.BlendModes.ADD),s.scene.tweens.add({targets:o,scale:{from:0,to:4},alpha:{from:1,to:0},duration:300,ease:"Expo.easeOut",onComplete:()=>o.destroy()});const h=s.scene.add.container(e,t);h.setDepth(I+1);for(let d=0;d<30;d++){const e=s.scene.add.circle(0,0,Phaser.Math.Between(3,6),Phaser.Math.RND.pick([16777215,16729344,16737536,16755200]));e.setBlendMode(Phaser.BlendModes.ADD),h.add(e);const t=Phaser.Math.Between(0,360)*Math.PI/180,i=Phaser.Math.Between(200,400),a=Math.cos(t)*i,n=Math.sin(t)*i;s.scene.tweens.add({targets:e,x:.8*a,y:.8*n,scale:{from:1,to:0},alpha:{from:1,to:0},duration:800,ease:"Power3",onComplete:()=>e.destroy()})}const c=s.scene.add.container(e,t);c.setDepth(I);for(let d=0;d<15;d++){const e=s.scene.add.rectangle(0,0,Phaser.Math.Between(4,8),Phaser.Math.Between(4,8),Phaser.Math.RND.pick([16729344,16737536,16755200]));c.add(e);const t=Phaser.Math.Between(-120,-60)*Math.PI/180,i=Phaser.Math.Between(100,300),a=Math.cos(t)*i,n=Math.sin(t)*i;s.scene.tweens.add({targets:e,x:e.x+a,y:e.y+n+400,scale:{from:.3,to:.1},angle:Phaser.Math.Between(0,360),duration:1200,ease:"Quad.easeIn",onComplete:()=>e.destroy()})}const l=s.scene.add.container(e,t);l.setDepth(I-2);for(let d=0;d<8;d++){const e=s.scene.add.circle(Phaser.Math.Between(-10,10),Phaser.Math.Between(-10,10),Phaser.Math.Between(20,30),6710886);e.setAlpha(.4),l.add(e),s.scene.tweens.add({targets:e,scale:{from:1,to:2},alpha:0,y:e.y-Phaser.Math.Between(20,50),duration:1500,ease:"Sine.easeOut",onComplete:()=>e.destroy()})}s.scene.cameras.main.shake(300,.02),s.scene.cameras.main.flash(100,255,100,0,!0),s.scene.time.delayedCall(2e3,()=>{h.destroy(),c.destroy(),l.destroy()});s.bubbleGrid.getBubblesInRadius(e,t,i).forEach((a,n)=>{const r=Phaser.Math.Distance.Between(e,t,a.x,a.y)/i*200;s.scene.time.delayedCall(r,()=>{if(a&&a.visible){const e=s.scene.add.circle(a.x,a.y,15,16737536,.8);e.setDepth(I),s.scene.tweens.add({targets:e,scale:{from:0,to:1.5},alpha:0,duration:200,ease:"Cubic.easeOut",onComplete:()=>e.destroy()}),a.destroy()}})})}deactivate(e){this.glowTimer&&(this.glowTimer.destroy(),this.glowTimer=null),this.sparkTimer&&(this.sparkTimer.destroy(),this.sparkTimer=null),this.visualElements.forEach(e=>{e&&e.destroy&&e.destroy()}),this.visualElements=[],e.aimingMode.setMode(pe.NORMAL)}}class fe{type=H.LIGHTNING;selectionHandler;visualElements=[];activate(e){e.aimingMode.setMode(pe.LIGHTNING,this.type);const t=e.scene.add.text(e.scene.cameras.main.centerX,e.scene.cameras.main.centerY,"⚡ LIGHTNING STRIKE!",{fontSize:"28px",fontFamily:"Arial Black",color:"#FFFF00",stroke:"#000000",strokeThickness:3});t.setOrigin(.5),t.setDepth(1e3),e.scene.tweens.add({targets:t,scale:{from:0,to:1.2},alpha:{from:1,to:0},y:t.y-50,duration:1500,ease:"Power2",onComplete:()=>t.destroy()}),e.shotsRemaining=1}destroyWithLightning(e,t){const s=t.scene.add.graphics();s.setDepth(I+10),s.lineStyle(4,16776960,1),s.beginPath();let i=e.x,a=0;for(let n=0;n<5;n++){const t=e.x+Phaser.Math.Between(-30,30),r=0+(e.y-0)/5*(n+1);s.moveTo(i,a),s.lineTo(t,r),i=t,a=r}s.lineTo(e.x,e.y),s.strokePath(),t.scene.cameras.main.flash(100,255,255,0),e.destroy(),t.scene.tweens.add({targets:s,alpha:0,duration:200,onComplete:()=>s.destroy()})}deactivate(e){this.selectionHandler&&e.scene.input.off("pointerdown",this.selectionHandler),e.aimingMode.setMode(pe.NORMAL)}}class Se{type=H.FREEZE;frozenBubbles=[];frostOverlay;visualElements=[];activate(e){e.aimingMode.setMode(pe.FREEZE,this.type),e.scene.physics&&e.scene.physics.pause&&e.scene.physics.pause(),this.createFrostOverlay(e),this.frozenBubbles=[];const t=e.scene.add.text(e.scene.cameras.main.centerX,e.scene.cameras.main.centerY,"TIME FROZEN!",{fontSize:"32px",fontFamily:"Arial Black",color:"#00FFFF",stroke:"#003366",strokeThickness:4});t.setOrigin(.5),t.setDepth(1e3),e.scene.tweens.add({targets:t,scale:{from:0,to:1.5},alpha:{from:1,to:0},duration:2e3,ease:"Power2",onComplete:()=>t.destroy()}),e.scene.time.delayedCall(5e3,()=>{this.deactivate(e)})}createFrostOverlay(e){this.frostOverlay=e.scene.add.graphics(),this.frostOverlay.setDepth(G-1),this.frostOverlay.fillStyle(8900331,.2),this.frostOverlay.fillRect(0,0,e.scene.cameras.main.width,e.scene.cameras.main.height);for(let t=0;t<20;t++){const s=e.scene.add.text(Phaser.Math.Between(0,e.scene.cameras.main.width),Phaser.Math.Between(0,e.scene.cameras.main.height),"❄️",{fontSize:"20px"});s.setDepth(G),e.scene.tweens.add({targets:s,y:s.y+100,alpha:{from:1,to:0},duration:3e3,repeat:-1,delay:150*t})}}deactivate(e){if(e.scene.physics&&e.scene.physics.resume&&e.scene.physics.resume(),this.frozenBubbles.forEach(e=>{e&&e.scene&&e.clearTint()}),this.frostOverlay){for(let e=0;e<20;e++){const t=this.frostOverlay.getData(`snowflake_${e}`);t&&t.destroy()}this.frostOverlay.destroy()}e.aimingMode.setMode(pe.NORMAL)}}class we{type=H.MULTIPLIER;visualElements=[];activate(e){e.aimingMode.setMode(pe.MULTI,this.type);const t=e.scene.add.text(e.scene.cameras.main.centerX,e.scene.cameras.main.centerY,"✨ MULTI-SHOT!",{fontSize:"28px",fontFamily:"Arial Black",color:"#FFD700",stroke:"#000000",strokeThickness:3});t.setOrigin(.5),t.setDepth(1e3),e.scene.tweens.add({targets:t,scale:{from:0,to:1.2},alpha:{from:1,to:0},y:t.y-50,duration:1500,ease:"Power2",onComplete:()=>t.destroy()}),e.shotsRemaining=1}deactivate(e){e.aimingMode&&e.aimingMode.setMode(pe.NORMAL)}}class Pe{scene;effects;activeEffect;context;constructor(e,t,s,i){this.scene=e,this.context={scene:e,launcher:t,aimingMode:i,bubbleGrid:s},this.effects=new Map([[H.RAINBOW,new ge],[H.LASER,new ye],[H.BOMB,new be],[H.LIGHTNING,new fe],[H.FREEZE,new Se],[H.MULTIPLIER,new we]]),this.setupEventListeners()}setupEventListeners(){this.scene.events.on("activate-power-up",e=>{this.activatePowerUp(e.type)})}activatePowerUp(e){this.activeEffect&&this.activeEffect.deactivate&&this.activeEffect.deactivate(this.context),this.context.aimingMode.setMode(pe.NORMAL);const t=this.effects.get(e);t&&(this.activeEffect=t,t.activate(this.context),this.scene.events.emit("power-up-activated",{type:e}),this.showActivationFeedback(e))}showActivationFeedback(e){const t={[H.RAINBOW]:"RAINBOW MODE!",[H.LASER]:"LASER SIGHT!",[H.BOMB]:"BOMB READY!",[H.LIGHTNING]:"LIGHTNING STRIKE!",[H.FREEZE]:"FREEZE TIME!",[H.MULTIPLIER]:"MULTI-SHOT!",[H.SHIELD]:"SHIELD UP!",[H.MAGNET]:"MAGNET ON!"},s=this.scene.add.text(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY-100,t[e]||"POWER-UP!",{fontSize:"32px",fontFamily:"Arial Black",color:"#FFD700",stroke:"#000000",strokeThickness:4});s.setOrigin(.5),s.setDepth(1e3),this.scene.tweens.add({targets:s,scale:{from:0,to:1.2},alpha:{from:1,to:0},y:s.y-50,duration:1500,ease:"Power2",onComplete:()=>{s.destroy()}}),this.scene.cameras.main.flash(250,255,215,0)}update(e){this.activeEffect&&this.activeEffect.update&&this.activeEffect.update(this.context,e)}destroy(){this.activeEffect&&this.activeEffect.deactivate&&this.activeEffect.deactivate(this.context),this.effects.clear()}}class Be{scene;splatters=[];config;static DEFAULT_CONFIG={minDropletSize:1.5,maxDropletSize:4,minDroplets:3,maxDroplets:7,minSpread:10,maxSpread:28,fadeStartDelay:1500,fadeDuration:1e3,initialAlpha:.45,colorVariation:.12,maxSplatters:120,cleanupBatchSize:20,scaleWithCombo:!0,comboScaleFactor:.2,maxComboScale:1.8};constructor(e,t){this.scene=e,this.config={...Be.DEFAULT_CONFIG,...t},this.setupEventListeners()}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}setupEventListeners(){this.scene.events.on("bubble-exploded",this.handleBubbleExplosion,this)}handleBubbleExplosion(e){if(e.positions&&e.positions.length>0){const t=this.calculateDropletsPerBubble(e.comboMultiplier||1,e.positions.length);e.positions.forEach(s=>{this.createSplatterAtPosition(s.x,s.y,e.color,t)})}else this.createSplatter(e.x,e.y,e.color,e.comboMultiplier||1)}calculateDropletsPerBubble(e,t){let s;s=e<=3?Phaser.Math.Between(5,6):4===e?Phaser.Math.Between(8,10):5===e?Phaser.Math.Between(12,14):6===e?Phaser.Math.Between(16,18):Phaser.Math.Between(20,24);const i=s%t;return Math.max(1,Math.floor(s/t))+(Math.random()<i/t?1:0)}createSplatterAtPosition(e,t,s,i){if(this.isValidPosition(e,t))for(let a=0;a<i;a++)this.createDroplet(e,t,s,1)}createSplatter(e,t,s,i){if(!this.isValidPosition(e,t))return;if(this.splatters.length>this.config.maxSplatters){this.splatters.splice(0,this.config.cleanupBatchSize).forEach(e=>{this.scene.tweens.killTweensOf(e),e.destroy()})}let a;a=i<=3?Phaser.Math.Between(5,6):4===i?Phaser.Math.Between(8,10):5===i?Phaser.Math.Between(12,14):6===i?Phaser.Math.Between(16,18):Phaser.Math.Between(20,24),a=Math.min(a,3*this.config.maxDroplets);for(let n=0;n<a;n++)this.createDroplet(e,t,s,i)}createDroplet(e,t,s,i){const a=Math.random()*Math.PI*2,n=this.config.scaleWithCombo?Math.min(1+.1*(i-1),1.5):1,r=Phaser.Math.Between(this.config.minSpread*n,this.config.maxSpread*n),o=e+Math.cos(a)*r,h=t+Math.sin(a)*r;if(!this.isValidPosition(o,h))return;const c=this.scene.add.graphics(),l=this.config.scaleWithCombo&&i>3?1+.05*(i-3):1,d=Phaser.Math.FloatBetween(this.config.minDropletSize*l,this.config.maxDropletSize*l),u=this.applyColorVariation(s);c.setDepth(A+1),c.setAlpha(this.config.initialAlpha),c.fillStyle(u,1);const p=Math.random();if(p<.4)c.fillCircle(o,h,d);else if(p<.7){const e=Math.random()*Math.PI;c.save(),c.translateCanvas(o,h),c.rotateCanvas(e),c.fillEllipse(0,0,1.5*d,.6*d),c.restore()}else if(p<.9)c.save(),c.translateCanvas(o,h),c.rotateCanvas(a),c.beginPath(),c.arc(0,0,d,0,2*Math.PI),c.lineTo(1.5*d,0),c.closePath(),c.fillPath(),c.restore();else{c.beginPath(),c.moveTo(o,h);const e=Phaser.Math.Between(4,7);for(let t=0;t<e;t++){const s=t/e*Math.PI*2,i=d*(.6+.8*Math.random()),a=o+Math.cos(s)*i,n=h+Math.sin(s)*i;0===t?c.moveTo(a,n):c.lineTo(a,n)}c.closePath(),c.fillPath()}if(this.splatters.push(c),this.splatters.length>.7*this.config.maxSplatters){const e=Math.min(5,this.splatters.length-.5*this.config.maxSplatters);for(let t=0;t<e;t++){const e=this.splatters.shift();e&&(this.scene.tweens.killTweensOf(e),e.destroy())}}this.scene.time.delayedCall(this.config.fadeStartDelay,()=>{this.scene.tweens.add({targets:c,alpha:0,duration:this.config.fadeDuration,ease:"Power2",onComplete:()=>{const e=this.splatters.indexOf(c);e>-1&&this.splatters.splice(e,1),c.destroy()}})})}applyColorVariation(e){const t=e>>16&255,s=e>>8&255,i=255&e,a=this.config.colorVariation,n=.8+.2*Math.random(),r=Math.min(255,Math.max(0,t*n+255*(Math.random()-.5)*a)),o=Math.min(255,Math.max(0,s*n+255*(Math.random()-.5)*a)),h=Math.min(255,Math.max(0,i*n+255*(Math.random()-.5)*a));return Math.floor(r)<<16|Math.floor(o)<<8|Math.floor(h)}isValidPosition(e,t){const s=this.scene.cameras.main;return e>=-50&&e<=s.width+50&&t>=-50&&t<=s.height+50&&!isNaN(e)&&!isNaN(t)&&isFinite(e)&&isFinite(t)}getSplatterCount(){return this.splatters.length}clear(){this.splatters.forEach(e=>{this.scene.tweens.killTweensOf(e),e.destroy()}),this.splatters=[]}setQualityPreset(e){switch(e){case"low":this.updateConfig({minDroplets:1,maxDroplets:2,minDropletSize:1,maxDropletSize:2,maxSplatters:30,fadeStartDelay:800,fadeDuration:500,initialAlpha:.25});break;case"medium":this.updateConfig({minDroplets:2,maxDroplets:4,minDropletSize:1,maxDropletSize:3,maxSplatters:60,fadeStartDelay:1200,fadeDuration:800,initialAlpha:.3});break;case"high":this.updateConfig({minDroplets:3,maxDroplets:8,minDropletSize:1.5,maxDropletSize:5,maxSplatters:120,fadeStartDelay:1500,fadeDuration:1e3,initialAlpha:.45});break;case"ultra":this.updateConfig({minDroplets:3,maxDroplets:8,minDropletSize:1,maxDropletSize:5,maxSplatters:150,fadeStartDelay:2e3,fadeDuration:1200,initialAlpha:.4,scaleWithCombo:!0,maxComboScale:2})}}destroy(){this.scene.events.off("bubble-exploded",this.handleBubbleExplosion,this),this.clear()}}class Me{static currentDifficulty=ee.HARD;scene;config;bubbleGrid;objective;playerLauncher;opponentLauncher;bubbles=[];bubblePool=[];zones=new Map;debugGraphics;debugEnabled=!1;inputManager;shootingSystem;gridAttachmentSystem;matchDetectionSystem;aiOpponent;isSinglePlayer=!0;enhancedScoreDisplay;comboManager;scoreEventManager;unifiedFeedbackSystem;playerPowerUpInventory;opponentPowerUpInventory;powerUpActivation;aimingModeSystem;playerScore=0;aiScore=0;gameOver=!1;victoryScreen;defeatScreen;isRestarting=!1;playerDangerLine;opponentDangerLine;dangerWarningActive=!1;paintSplatterSystem;dangerCheckCounter=0;DANGER_CHECK_INTERVAL=10;shieldCheckCounter=0;SHIELD_CHECK_INTERVAL=15;cachedShieldState=!1;aimingCheckCounter=0;AIMING_CHECK_INTERVAL=2;lastAimAngle=0;constructor(e){this.scene=e,this.config=S,this.inputManager=new Z(e);const t=e.cameras.main.centerX,s=e.cameras.main.centerY;this.bubbleGrid=new N(t,s),this.gridAttachmentSystem=new K(e,this.bubbleGrid),this.matchDetectionSystem=new J(e,this.bubbleGrid,this.gridAttachmentSystem),this.gridAttachmentSystem.setMatchDetectionSystem(this.matchDetectionSystem),this.initializeZones(),this.createBubblePool()}initializeZones(){const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height;this.zones.set(f.PLAYER,{x:0,y:t-this.config.playerZoneHeight,width:e,height:this.config.playerZoneHeight,zone:f.PLAYER}),this.zones.set(f.OPPONENT,{x:0,y:0,width:e,height:this.config.opponentZoneHeight,zone:f.OPPONENT}),this.zones.set(f.OBJECTIVE,{x:0,y:this.config.opponentZoneHeight,width:e,height:this.config.objectiveZoneHeight,zone:f.OBJECTIVE})}createBubblePool(){for(let e=0;e<w.POOL_SIZE;e++){const e=new U(this.scene,-1e3,-1e3,U.getRandomColor());e.setVisible(!1),this.bubblePool.push(e)}}setupArena(e=!0,t){this.isSinglePlayer=e,void 0!==t&&(Me.currentDifficulty=t);const s=Me.currentDifficulty;this.createLaunchers(),this.createObjective(),this.createInitialBubbles(),this.createZoneVisuals(),this.enhancedScoreDisplay=new se(this.scene),this.comboManager=new ie(this.scene),this.scoreEventManager=new z(this.scene),this.unifiedFeedbackSystem=new le(this.scene),this.paintSplatterSystem=new Be(this.scene,{fadeStartDelay:1500,fadeDuration:1e3,initialAlpha:.5,minDropletSize:1.5,maxDropletSize:5,minDroplets:3,maxDroplets:8,minSpread:10,maxSpread:30,maxSplatters:150,scaleWithCombo:!0,comboScaleFactor:.25,maxComboScale:2}),this.aimingModeSystem=new me(this.scene),this.playerLauncher&&(this.powerUpActivation=new Pe(this.scene,this.playerLauncher,this.bubbleGrid,this.aimingModeSystem)),this.scoreEventManager.onScoreUpdate((e,t)=>{t?(this.playerScore=e,this.enhancedScoreDisplay?.updatePlayerScore(e)):(this.aiScore=e,this.enhancedScoreDisplay?.updateOpponentScore(e))}),this.scoreEventManager.onVisualEffect((e,t)=>{this.unifiedFeedbackSystem?.queueFeedback(e,t)}),this.playerScore=0,this.aiScore=0,this.shootingSystem=new Q(this.scene,this.inputManager,this.playerLauncher,this.gridAttachmentSystem,this.bubbleGrid),this.shootingSystem.setOpponentLauncher(this.opponentLauncher),this.isSinglePlayer&&(this.aiOpponent=new te(this.scene,this.opponentLauncher),this.aiOpponent.setDifficulty(s),this.scene.time.delayedCall(2e3,()=>{this.aiOpponent?.start()})),this.scene.events.on("score-update",this.onScoreUpdate,this),this.scene.events.on("bubble-attached",this.checkVictoryCondition,this),this.scene.events.on("bubble-position-update",this.checkChestHit,this),this.scene.input.keyboard?.on("keydown-D",()=>{this.toggleDebug()}),this.isSinglePlayer&&this.aiOpponent&&(this.scene.input.keyboard?.on("keydown-ONE",()=>{this.changeAIDifficulty(ee.EASY)}),this.scene.input.keyboard?.on("keydown-TWO",()=>{this.changeAIDifficulty(ee.MEDIUM)}),this.scene.input.keyboard?.on("keydown-THREE",()=>{this.changeAIDifficulty(ee.HARD)}))}createLaunchers(){const e=this.scene.cameras.main.centerX,t=this.zones.get(f.PLAYER);this.playerLauncher=new W(this.scene,e,t.y+t.height-this.config.launcherOffset,f.PLAYER);const s=this.zones.get(f.OPPONENT);this.opponentLauncher=new W(this.scene,e,s.y+this.config.launcherOffset,f.OPPONENT)}createObjective(){const e=this.scene.cameras.main.centerX,t=this.scene.cameras.main.centerY;this.objective=new X(this.scene,{x:e,y:t,size:this.config.objectiveSize,health:1})}createInitialBubbles(){const e={q:0,r:0,s:0};const t=this.scene.cameras.main.height/2,s=[];for(let o=1;o<=M;o++){this.bubbleGrid.getRing(e,o).forEach(e=>{const t=this.bubbleGrid.hexToPixel(e);s.push({hexPos:e,pixelPos:t})})}const i=s.length,a=Math.floor(.125*i),n=Math.floor(a/2),r=new Set;for(const o of["player","opponent"]){let e=0;const i=100;let a=0;for(;e<n&&a<i;){const i=Math.floor(Math.random()*s.length);if(!r.has(i)){const a=s[i].pixelPos.y>t;("player"===o&&a||"opponent"===o&&!a)&&(r.add(i),e++)}a++}}s.forEach((e,s)=>{if(r.has(s)){const s=new Y(this.scene,e.pixelPos.x,e.pixelPos.y);s.setGridPosition(e.hexPos),this.bubbles.push(s),this.gridAttachmentSystem.addGridBubble(s),e.pixelPos.y>t?0:0}else{const t=this.getBubbleFromPool();t&&(t.reset(e.pixelPos.x,e.pixelPos.y,U.getRandomColor()),t.setGridPosition(e.hexPos),this.bubbles.push(t),this.gridAttachmentSystem.addGridBubble(t))}}),this.updateObjectiveShield()}getBubbleFromPool(){const e=this.bubblePool.find(e=>e.isPooled()||!e.visible);if(e){const t=this.bubblePool.indexOf(e);t>-1&&this.bubblePool.splice(t,1)}return e||null}returnBubbleToPool(e){e.returnToPool(),this.bubblePool.push(e);const t=this.bubbles.indexOf(e);t>-1&&this.bubbles.splice(t,1)}createZoneVisuals(){}toggleDebug(){this.debugEnabled=!this.debugEnabled,this.debugEnabled?this.showDebugOverlay():this.hideDebugOverlay()}showDebugOverlay(){this.debugGraphics||(this.debugGraphics=this.scene.add.graphics(),this.debugGraphics.setDepth(R)),this.debugGraphics.clear(),this.zones.forEach((e,t)=>{let s=O;switch(t){case f.PLAYER:s=T;break;case f.OPPONENT:s=E;break;case f.OBJECTIVE:s=x}this.debugGraphics.fillStyle(s,v),this.debugGraphics.fillRect(e.x,e.y,e.width,e.height);this.scene.add.text(e.x+10,e.y+10,t.toUpperCase(),{fontSize:"14px",color:"#ffffff",backgroundColor:"#000000"}).setDepth(R+1)}),this.drawHexGrid(),this.gridAttachmentSystem&&this.debugGraphics&&this.gridAttachmentSystem.debugDrawConnections(this.debugGraphics)}drawHexGrid(){if(!this.debugGraphics)return;this.debugGraphics.lineStyle(1,16777215,.3);const e=this.bubbleGrid.getGridBounds();for(let t=e.minQ;t<=e.maxQ;t++)for(let s=e.minR;s<=e.maxR;s++){const e={q:t,r:s,s:-t-s},i=this.bubbleGrid.hexToPixel(e),a=w.SIZE/2,n=[];for(let t=0;t<6;t++){const e=Math.PI/3*t;n.push(i.x+a*Math.cos(e)),n.push(i.y+a*Math.sin(e))}this.debugGraphics.strokePoints(n,!0)}}hideDebugOverlay(){this.debugGraphics&&this.debugGraphics.clear(),this.scene.children.list.forEach(e=>{e instanceof Phaser.GameObjects.Text&&e.getData("isDebugLabel")&&e.destroy()})}updateObjectiveShield(){if(!this.objective)return;const e=this.bubbleGrid.getNeighbors({q:0,r:0,s:0});let t=!1;for(const s of e){const e=`${s.q},${s.r}`;if(this.gridAttachmentSystem.hasGridPosition(e)){t=!0;break}}t!==this.cachedShieldState&&(this.cachedShieldState=t,this.objective.setShielded(t))}getZoneBounds(e){return this.zones.get(e)}getBubbles(){return this.bubbles}getObjective(){return this.objective}getPlayerLauncher(){return this.playerLauncher}getOpponentLauncher(){return this.opponentLauncher}update(e,t){const s=this.inputManager.isPointerActive();s?this.inputManager.update():(this.aimingCheckCounter++,this.aimingCheckCounter>=2*this.AIMING_CHECK_INTERVAL&&(this.aimingCheckCounter=0,this.inputManager.update())),(s||0===this.aimingCheckCounter)&&this.updateLauncherAiming(),this.shootingSystem?.update(t),this.powerUpActivation?.update(t),this.shieldCheckCounter++,this.shieldCheckCounter>=this.SHIELD_CHECK_INTERVAL&&(this.shieldCheckCounter=0,this.updateObjectiveShield()),this.dangerCheckCounter++,this.dangerCheckCounter>=this.DANGER_CHECK_INTERVAL&&(this.dangerCheckCounter=0,this.checkDangerZoneProximity()),this.unifiedFeedbackSystem?.update(t)}updateLauncherAiming(){const e={x:this.playerLauncher.x,y:this.playerLauncher.y},t=this.inputManager.getAngleFromWithConstraints(e.x,e.y,15,165);Math.abs(t-this.lastAimAngle)>.5&&(this.playerLauncher.setAimAngle(t),this.lastAimAngle=t);const s=this.inputManager.isPointerActive();if(this.playerLauncher.showAiming(s),this.debugEnabled&&this.debugGraphics){this.debugGraphics.clear(),this.showDebugOverlay(),this.debugGraphics.lineStyle(2,65280,.8),this.debugGraphics.beginPath(),this.debugGraphics.moveTo(e.x,e.y);const s=200,i=Phaser.Math.DegToRad(t-90),a=e.x+Math.cos(i)*s,n=e.y+Math.sin(i)*s;this.debugGraphics.lineTo(a,n),this.debugGraphics.strokePath()}}changeAIDifficulty(e){this.aiOpponent&&(Me.currentDifficulty=e,this.aiOpponent.stop(),this.aiOpponent.setDifficulty(e),this.scene.time.delayedCall(500,()=>{this.aiOpponent?.start()}),this.showDifficultyNotification(e))}showDifficultyNotification(e){const t={[ee.EASY]:"#4CAF50",[ee.MEDIUM]:"#FFA726",[ee.HARD]:"#F44336"},s=this.scene.add.text(this.scene.cameras.main.centerX,160,`AI: ${e}`,{fontSize:"18px",color:t[e],fontFamily:"Arial",fontStyle:"bold",stroke:"#000000",strokeThickness:3});s.setOrigin(.5),s.setDepth(1500),s.setScale(0),this.scene.tweens.add({targets:s,scale:1,duration:200,ease:"Back.easeOut"}),this.scene.time.delayedCall(1200,()=>{this.scene.tweens.add({targets:s,alpha:0,scale:.8,duration:300,ease:"Power2",onComplete:()=>{s.destroy()}})})}onScoreUpdate=e=>{if(!this.gameOver)if(this.scoreEventManager){let t;t=e.isOrphanBonus?{type:_.ORPHAN_DROP,baseValue:e.delta,position:{x:e.x||0,y:e.y||0},isPlayer:!e.isAI,bubbleColor:e.bubbleColor,metadata:{dropCount:Math.floor(e.delta/5)}}:e.matchSize?{type:_.BUBBLE_MATCH,baseValue:e.delta,position:{x:e.x||0,y:e.y||0},matchSize:e.matchSize,isPlayer:!e.isAI,bubbleColor:e.bubbleColor}:{type:_.SPECIAL_BONUS,baseValue:e.delta,position:{x:e.x||0,y:e.y||0},isPlayer:!e.isAI,bubbleColor:e.bubbleColor},this.scoreEventManager.queueEvent(t)}else{let t=e.delta;e.isOrphanBonus?t=e.delta:e.matchSize&&this.comboManager&&(t=this.comboManager.calculateScore(e.matchSize,e.x,e.y,e.bubbleColor)),e.isAI?(this.aiScore+=t,this.enhancedScoreDisplay?.updateOpponentScore(this.aiScore)):(this.playerScore+=t,this.enhancedScoreDisplay?.updatePlayerScore(this.playerScore))}};checkChestHit=e=>{if(this.gameOver||!this.objective||!e.visible)return;if(Phaser.Math.Distance.Between(e.x,e.y,this.objective.x,this.objective.y)<this.config.objectiveSize/2+w.SIZE/2){const t="player"===e.getShooter();this.objective.hit(),this.gameOver=!0,e.setVisible(!1);const s=this.objective;this.objective=null,s.playVictoryAnimation(()=>{this.triggerGameOver(t)})}};checkVictoryCondition=e=>{if(this.gameOver)return;const t=e.bubble;if(!t.visible||!t.getGridPosition())return;const s=this.scene.cameras.main.height-C.PLAYER_OFFSET,i=C.OPPONENT_OFFSET;if(t.y>s)this.triggerGameOver(!1);else if(t.y<i){const e=t.getGridPosition();if(e){const s=this.bubbleGrid.hexToPixel(e);if(Phaser.Math.Distance.Between(t.x,t.y,s.x,s.y)<5)return void this.triggerGameOver(!0)}}};wasAIShot(e){const t=this.scene.cameras.main.centerY;return e.y<t-100}triggerGameOver(e){this.gameOver&&(this.victoryScreen||this.defeatScreen)||(this.gameOver=!0,this.scene.physics.pause(),this.aiOpponent?.stop(),this.shootingSystem?.destroy(),e?this.scene.events.emit("victory"):this.scene.events.emit("defeat"),e?(this.victoryScreen=new ae(this.scene,this.playerScore,this.restartGame,this.returnToMenu),this.scene.cameras.main.flash(500,255,215,0)):(this.defeatScreen=new ne(this.scene,this.playerScore,this.restartGame,this.returnToMenu),this.scene.cameras.main.fade(500,0,0,0,!1),this.scene.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.cameras.main.fadeIn(500)})),this.scene.events.emit("game-over",{winner:e?"player":"ai",playerScore:this.playerScore,aiScore:this.aiScore}))}restartGame=()=>{try{if(this.isRestarting)return;this.isRestarting=!0,this.victoryScreen&&(this.victoryScreen.destroy(),this.victoryScreen=void 0),this.defeatScreen&&(this.defeatScreen.destroy(),this.defeatScreen=void 0);try{this.scene.children.removeAll(!0),this.gameOver=!1,this.playerScore=0,this.aiScore=0,this.isRestarting=!1;this.scene.scene.key;this.scene.scene.restart()}catch(e){window.location.href=window.location.href.split("?")[0]+"?t="+Date.now(),setTimeout(()=>{window.location.reload(!0)},100)}}catch(t){try{document.location.reload(!0)}catch(s){window.history.go(0)}}};returnToMenu=()=>{try{if(this.isRestarting)return;this.isRestarting=!0,this.victoryScreen&&(this.victoryScreen.destroy(),this.victoryScreen=void 0),this.defeatScreen&&(this.defeatScreen.destroy(),this.defeatScreen=void 0);try{this.scene.children.removeAll(!0),this.gameOver=!1,this.playerScore=0,this.aiScore=0,this.isRestarting=!1;this.scene.scene.key;this.scene.scene.restart()}catch(e){window.location.href=window.location.href.split("?")[0]+"?t="+Date.now()}}catch(t){window.location.reload()}};checkDangerZoneProximity(){if(this.gameOver)return;const e=this.scene.cameras.main.height-C.PLAYER_OFFSET,t=C.OPPONENT_OFFSET;let s=!1;const i=this.gridAttachmentSystem.getGridBubbles();for(let a=0;a<i.length;a++){const n=i[a];if(!n.visible)continue;const r=e-n.y;if(r<40&&r>0){s=!0,this.activateDangerWarning(this.playerDangerLine,!0);break}const o=n.y-t;if(o<40&&o>0){s=!0,this.activateDangerWarning(this.opponentDangerLine,!1);break}}!s&&this.dangerWarningActive&&this.deactivateDangerWarning()}activateDangerWarning(e,t){e&&!this.dangerWarningActive&&(this.dangerWarningActive=!0,this.scene.events.emit("danger-warning",{isPlayer:t}),this.scene.tweens.add({targets:e,alpha:{from:.6,to:1},duration:C.PULSE_DURATION/2,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),t&&this.scene.cameras.main.flash(200,255,0,0,!1))}deactivateDangerWarning(){this.dangerWarningActive=!1,this.playerDangerLine&&(this.scene.tweens.killTweensOf(this.playerDangerLine),this.playerDangerLine.setAlpha(1)),this.opponentDangerLine&&(this.scene.tweens.killTweensOf(this.opponentDangerLine),this.opponentDangerLine.setAlpha(1))}destroy(){this.inputManager?.destroy(),this.shootingSystem?.destroy(),this.gridAttachmentSystem?.clearGrid(),this.matchDetectionSystem?.reset(),this.aiOpponent?.destroy(),this.bubbles.forEach(e=>e.destroy()),this.bubblePool.forEach(e=>e.destroy()),this.objective?.destroy(),this.playerLauncher?.destroy(),this.opponentLauncher?.destroy(),this.debugGraphics?.destroy(),this.enhancedScoreDisplay?.destroy(),this.comboManager?.reset(),this.scoreEventManager?.destroy(),this.unifiedFeedbackSystem?.destroy(),this.paintSplatterSystem?.destroy(),this.victoryScreen?.destroy(),this.defeatScreen?.destroy(),this.scene.events.off("score-update",this.onScoreUpdate,this),this.scene.events.off("bubble-attached",this.checkVictoryCondition,this),this.scene.events.off("bubble-position-update",this.checkChestHit,this)}getPaintSplatterSystem(){return this.paintSplatterSystem}setGraphicsQuality(e){this.paintSplatterSystem?.setQualityPreset(e)}}class Ce{scene;sounds=new Map;muted=!1;masterVolume=.5;volumes={shoot:.3,attach:.4,combo:.6,celebration:1,arsenal:.5,victory:.9,background:.2};constructor(e){this.scene=e,this.initializeSounds()}initializeSounds(){const e=this.scene.cache.audio;Object.values(d).forEach(t=>{e.exists(t)})}playShootSound(){this.muted||this.playSound(d.BUBBLE_SHOOT,this.volumes.shoot)}playAttachSound(){this.muted||this.playSound(d.BUBBLE_ATTACH,this.volumes.attach)}playBubblesDropSound(){this.muted||this.playSound(d.BUBBLES_DROP,.6*this.volumes.combo,.85)}playComboSound(e){if(this.muted)return;let t,s=this.volumes.combo;if(3===e)t=d.COMBO_3,this.playSound(t,s);else if(4===e)t=d.COMBO_4,this.playSound(t,s);else{if(!(e>=5))return;t=d.COMBO_5_PLUS,s=.7*this.volumes.combo,this.playSound(t,s,.85),setTimeout(()=>{this.playSound(d.COMBO_CELEBRATION,this.volumes.celebration)},200)}}playMatchSound(e){this.playComboSound(e)}playArsenalPickupSound(){this.muted||this.playSound(d.ARSENAL_PICKUP,this.volumes.arsenal)}playSuccessObjectiveSound(){this.muted||this.playSound(d.SUCCESS_OBJECTIVE,1.2*this.volumes.arsenal)}playVictorySound(){this.muted||this.playSound(d.VICTORY,this.volumes.victory)}playDefeatSound(){this.muted||this.playSound(d.DEFEAT,.7*this.volumes.victory)}playPowerUpSound(){this.muted||this.playSound(d.ARSENAL_PICKUP,this.volumes.arsenal)}playClickSound(){this.muted||this.playSound(d.BUBBLE_ATTACH,.5*this.volumes.attach)}playBackgroundMusic(){if(this.muted)return;const e=d.BACKGROUND_MUSIC;if(!this.scene.cache.audio.exists(e))return;const t=this.sounds.get("background-music");t&&t.stop();const s=this.scene.sound.add(e,{volume:this.volumes.background*this.masterVolume,loop:!0});return this.sounds.set("background-music",s),s.play(),s}playSound(e,t=.5,s=1){try{if(!this.scene.cache.audio.exists(e))return;const i=this.scene.sound.add(e,{volume:t*this.masterVolume,rate:s});i.play(),i.once("complete",()=>{i.destroy()})}catch(i){}}toggleMute(){return this.muted=!this.muted,this.scene.sound.mute=this.muted,this.muted}setMasterVolume(e){this.masterVolume=Math.max(0,Math.min(1,e)),this.scene.sound.volume=this.masterVolume}testAllSounds(){const e=[{key:d.BUBBLE_SHOOT,name:"Shoot"},{key:d.BUBBLE_ATTACH,name:"Attach"},{key:d.COMBO_3,name:"Combo 3"},{key:d.COMBO_4,name:"Combo 4"},{key:d.COMBO_5_PLUS,name:"Combo 5+"},{key:d.VICTORY,name:"Victory"}];let t=0;e.forEach(({key:e,name:s})=>{setTimeout(()=>{this.playSound(e,.5)},t),t+=1e3})}getInfo(){return{muted:this.muted,masterVolume:this.masterVolume,soundsLoaded:Object.values(d).filter(e=>this.scene.cache.audio.exists(e)).length,totalSounds:Object.values(d).length}}destroy(){this.sounds.forEach(e=>{e.stop(),e.destroy()}),this.sounds.clear()}}class Te{static instance=null;scene;activeTweens=new Map;tweenGroups=new Map;frameCounter=0;constructor(e){this.scene=e,Te.instance=this}static getInstance(e){return!Te.instance&&e&&(Te.instance=new Te(e)),Te.instance}createOptimizedTween(e,t,s,i,a={}){if(-1===a.repeat&&a.group){const e=this.getGroupTween(a.group);if(e&&this.canShareTween(e,s))return this.addTargetToTween(e,t,a.stagger),e}const n={targets:t,...s,duration:i,yoyo:a.yoyo||!1,repeat:a.repeat||0,ease:a.ease||"Linear",delay:a.delay||0};-1===a.repeat&&(n.callbackScope=this,n.onUpdate=this.throttleUpdate.bind(this,e));const r=this.scene.tweens.add(n);return this.activeTweens.set(e,r),a.group&&(this.tweenGroups.has(a.group)||this.tweenGroups.set(a.group,new Set),this.tweenGroups.get(a.group).add(e)),r}throttleUpdate(e){this.frameCounter++,this.frameCounter}canShareTween(e,t){const s=e.data[0];if(!s)return!1;for(const i in t)if(s.key===i)return!0;return!1}addTargetToTween(e,t,s){const i=e.data[0];if(!i)return;const a={targets:t,duration:i.duration,yoyo:e.yoyo,repeat:e.repeat,ease:i.ease,delay:s||0};e.data.forEach(e=>{a[e.key]={from:e.start,to:e.end}}),this.scene.tweens.add(a)}getGroupTween(e){const t=this.tweenGroups.get(e);if(!t||0===t.size)return null;const s=t.values().next().value;return this.activeTweens.get(s)||null}removeTween(e){const t=this.activeTweens.get(e);t&&(t.destroy(),this.activeTweens.delete(e),this.tweenGroups.forEach((t,s)=>{t.delete(e),0===t.size&&this.tweenGroups.delete(s)}))}pauseGroup(e){const t=this.tweenGroups.get(e);t&&t.forEach(e=>{const t=this.activeTweens.get(e);t&&t.pause()})}resumeGroup(e){const t=this.tweenGroups.get(e);t&&t.forEach(e=>{const t=this.activeTweens.get(e);t&&t.resume()})}destroy(){this.activeTweens.forEach(e=>e.destroy()),this.activeTweens.clear(),this.tweenGroups.clear(),Te.instance=null}getStats(){const e=new Map;return this.tweenGroups.forEach((t,s)=>{e.set(s,t.size)}),{totalTweens:this.activeTweens.size,groups:this.tweenGroups.size,tweensPerGroup:e}}}class Ee extends t.Scene{sceneManager;performanceMonitor;arenaSystem;soundSystem;backgroundSystem;backgroundMusic;fpsText;frameCount=0;lastFPSUpdate=0;isPaused=!1;tweenOptimizer;constructor(){super({key:n.GAME})}preload(){this.load.audio("background-music","assets/audio/background_music.mp3")}init(e){this.backgroundMusic&&(this.backgroundMusic.stop(),this.backgroundMusic.destroy(),this.backgroundMusic=void 0),e&&e.theme&&this.registry.set("gameTheme",e.theme);const t=!!window.Capacitor;this.game.registry.set("isCapacitor",t),this.sceneManager=o.getInstance(),this.sceneManager.setCurrentScene(n.GAME),this.performanceMonitor=new h,this.performanceMonitor.setEventEmitter(this.game.events),this.isPaused=!1}create(){try{this.cameras.main.setBackgroundColor("#3498db"),this.tweenOptimizer=new Te(this),this.createBackground(),this.createSoundSystem(),this.createBackgroundMusic(),this.createArena(),this.createUI(),this.setupInputHandlers(),this.game.events.emit(r.SCENE_READY,{scene:n.GAME})}catch(e){}}createSoundSystem(){try{this.soundSystem=new Ce(this)}catch(e){}}createBackgroundMusic(){try{this.backgroundMusic&&(this.backgroundMusic.stop(),this.backgroundMusic.destroy(),this.backgroundMusic=void 0),this.soundSystem&&(this.backgroundMusic=this.soundSystem.playBackgroundMusic(),this.backgroundMusic)}catch(e){}}createBackground(){const e=this.registry.get("isCapacitor")?"medium":"high",t=this.registry.get("gameTheme")||this.registry.get("selectedTheme")||"ocean";this.backgroundSystem=new g(this,{theme:t,quality:e,enableParticles:!0,enableAnimation:!0})}createArena(){try{this.arenaSystem=new Me(this),this.arenaSystem.setupArena(!0,ee.HARD),this.setupSoundEvents()}catch(e){throw e}}setupSoundEvents(){this.soundSystem&&(this.events.on("bubble-shoot",()=>{this.soundSystem.playShootSound()}),this.events.on("bubble-attached",()=>{}),this.events.on("bubble-attach-collision",()=>{this.soundSystem.playAttachSound()}),this.events.on("bubble-attached-sound",()=>{}),this.events.on("match-found",e=>{e&&e.matchSize&&this.soundSystem.playMatchSound(e.matchSize)}),this.events.on("power-up-activated",()=>{this.soundSystem.playPowerUpSound()}),this.events.on("ui-click",()=>{this.soundSystem.playClickSound()}),this.events.on("victory",()=>{this.soundSystem.playVictorySound()}),this.events.on("defeat",()=>{this.soundSystem.playDefeatSound()}),this.events.on("floating-bubbles-drop",()=>{this.soundSystem.playBubblesDropSound()}),this.events.on("mystery-box-collected",()=>{this.soundSystem.playSuccessObjectiveSound()}),this.events.on("objective-hit",()=>{this.soundSystem.playSuccessObjectiveSound()}))}createFPSDisplay(){const e=this.cameras.main.width,t=this.cameras.main.height;this.fpsText=this.add.text(e-100,t-100,"FPS: 0",{fontSize:"20px",color:"#00FF00",fontFamily:"Arial, sans-serif",fontStyle:"bold",backgroundColor:"#000000CC",padding:{x:10,y:6}}),this.fpsText.setDepth(G+1e3),this.fpsText.setScrollFactor(0),this.fpsText.setOrigin(.5,.5),this.frameCount=0,this.lastFPSUpdate=performance.now()}createUI(){this.createFPSDisplay(),this.game.events.on("match-completed",e=>{if(e.combo>0){const t=this.add.text(this.cameras.main.width/2,90,`COMBO x${e.combo+1}!`,{fontFamily:"Arial",fontSize:"20px",fontStyle:"bold",color:"#FF6B6B",stroke:"#000000",strokeThickness:2}).setOrigin(.5);t.setDepth(G),this.tweens.add({targets:t,scale:1.5,alpha:0,duration:1e3,ease:"Power2",onComplete:()=>t.destroy()})}})}setupInputHandlers(){this.input.keyboard?.on("keydown-ESC",()=>{this.returnToMenu()}),this.input.keyboard?.on("keydown-P",()=>{this.togglePause()}),this.input.keyboard?.on("keydown-SPACE",()=>{this.testBubblePop()}),this.input.keyboard?.on("keydown-T",()=>{this.soundSystem?.testAllSounds();this.soundSystem?.getInfo()}),this.input.keyboard?.on("keydown-M",()=>{const e=this.soundSystem?.toggleMute();this.backgroundMusic&&(e?this.backgroundMusic.pause():this.backgroundMusic.resume())}),this.registry.get("isCapacitor")||(this.input.keyboard?.on("keydown-FIVE",()=>{this.backgroundSystem?.setTheme("ocean")}),this.input.keyboard?.on("keydown-SIX",()=>{this.backgroundSystem?.setTheme("sunset")}),this.input.keyboard?.on("keydown-SEVEN",()=>{this.backgroundSystem?.setTheme("forest")}),this.input.keyboard?.on("keydown-EIGHT",()=>{this.backgroundSystem?.setTheme("space")}),this.input.keyboard?.on("keydown-NINE",()=>{this.backgroundSystem?.setTheme("aurora")}))}testBubblePop(){const e=this.arenaSystem.getBubbles();if(e.length>0){const t=e[Math.floor(Math.random()*e.length)];t&&t.pop()}}togglePause(){this.isPaused=!this.isPaused,this.isPaused?(this.physics.pause(),this.backgroundMusic?.pause(),this.showPauseOverlay()):(this.physics.resume(),this.backgroundMusic?.resume(),this.hidePauseOverlay())}showPauseOverlay(){const e=this.add.rectangle(this.cameras.main.centerX,this.cameras.main.centerY,this.cameras.main.width,this.cameras.main.height,0,.7);e.setDepth(G+10),e.setData("isPauseOverlay",!0);const t=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,"PAUSED",{fontFamily:"Arial",fontSize:"48px",color:"#ffffff"}).setOrigin(.5);t.setDepth(G+11),t.setData("isPauseOverlay",!0);const s=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY+60,"Press P to Resume",{fontFamily:"Arial",fontSize:"20px",color:"#ffffff"}).setOrigin(.5);s.setDepth(G+11),s.setData("isPauseOverlay",!0)}hidePauseOverlay(){this.children.list.forEach(e=>{e.getData("isPauseOverlay")&&e.destroy()})}returnToMenu(){this.backgroundMusic&&(this.backgroundMusic.stop(),this.backgroundMusic.destroy(),this.backgroundMusic=void 0),this.arenaSystem?.destroy(),this.soundSystem?.destroy(),this.sceneManager.transitionTo(n.MENU)}update(e,t){this.isPaused||(this.updateFPSDisplay(),this.arenaSystem?.update(e,t))}updateFPSDisplay(){if(!this.fpsText)return;this.frameCount++;const e=performance.now(),t=e-this.lastFPSUpdate;if(t>=1e3){const s=Math.round(1e3*this.frameCount/t);this.fpsText.setText(`FPS: ${s}`),s>=100?this.fpsText.setColor("#00FF00"):s>=60?this.fpsText.setColor("#FFFF00"):s>=30?this.fpsText.setColor("#FFA500"):this.fpsText.setColor("#FF0000"),this.frameCount=0,this.lastFPSUpdate=e}}shutdown(){this.backgroundMusic&&(this.backgroundMusic.stop(),this.backgroundMusic.destroy(),this.backgroundMusic=void 0),this.arenaSystem?.destroy(),this.soundSystem?.destroy(),this.backgroundSystem?.destroy(),this.performanceMonitor?.reset()}}
/*! Capacitor: https://capacitorjs.com/ - MIT License */(ue=de||(de={})).Unimplemented="UNIMPLEMENTED",ue.Unavailable="UNAVAILABLE";class xe extends Error{constructor(e,t,s){super(e),this.message=e,this.code=t,this.data=s}}const Oe=e=>{const t=e.CapacitorCustomPlatform||null,s=e.Capacitor||{},i=s.Plugins=s.Plugins||{},a=()=>null!==t?t.name:(e=>{var t,s;return(null==e?void 0:e.androidBridge)?"android":(null===(s=null===(t=null==e?void 0:e.webkit)||void 0===t?void 0:t.messageHandlers)||void 0===s?void 0:s.bridge)?"ios":"web"})(e),n=e=>{var t;return null===(t=s.PluginHeaders)||void 0===t?void 0:t.find(t=>t.name===e)},r=new Map;return s.convertFileSrc||(s.convertFileSrc=e=>e),s.getPlatform=a,s.handleError=t=>e.console.error(t),s.isNativePlatform=()=>"web"!==a(),s.isPluginAvailable=e=>{const t=r.get(e);return!!(null==t?void 0:t.platforms.has(a()))||!!n(e)},s.registerPlugin=(e,o={})=>{const h=r.get(e);if(h)return h.proxy;const c=a(),l=n(e);let d;const u=i=>{let a;const n=(...n)=>{const r=(async()=>(!d&&c in o?d=d="function"==typeof o[c]?await o[c]():o[c]:null!==t&&!d&&"web"in o&&(d=d="function"==typeof o.web?await o.web():o.web),d))().then(t=>{const r=((t,i)=>{var a,n;if(!l){if(t)return null===(n=t[i])||void 0===n?void 0:n.bind(t);throw new xe(`"${e}" plugin is not implemented on ${c}`,de.Unimplemented)}{const n=null==l?void 0:l.methods.find(e=>i===e.name);if(n)return"promise"===n.rtype?t=>s.nativePromise(e,i.toString(),t):(t,a)=>s.nativeCallback(e,i.toString(),t,a);if(t)return null===(a=t[i])||void 0===a?void 0:a.bind(t)}})(t,i);if(r){const e=r(...n);return a=null==e?void 0:e.remove,e}throw new xe(`"${e}.${i}()" is not implemented on ${c}`,de.Unimplemented)});return"addListener"===i&&(r.remove=async()=>a()),r};return n.toString=()=>`${i.toString()}() { [capacitor code] }`,Object.defineProperty(n,"name",{value:i,writable:!1,configurable:!1}),n},p=u("addListener"),m=u("removeListener"),g=(e,t)=>{const s=p({eventName:e},t),i=async()=>{const i=await s;m({eventName:e,callbackId:i},t)},a=new Promise(e=>s.then(()=>e({remove:i})));return a.remove=async()=>{await i()},a},y=new Proxy({},{get(e,t){switch(t){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return l?g:p;case"removeListener":return m;default:return u(t)}}});return i[e]=y,r.set(e,{name:e,proxy:y,platforms:new Set([...Object.keys(o),...l?[c]:[]])}),y},s.Exception=xe,s.DEBUG=!!s.DEBUG,s.isLoggingEnabled=!!s.isLoggingEnabled,s},ve=(e=>e.Capacitor=Oe(e))("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}),Ae=ve.registerPlugin;class ke{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,t){let s=!1;this.listeners[e]||(this.listeners[e]=[],s=!0),this.listeners[e].push(t);const i=this.windowListeners[e];i&&!i.registered&&this.addWindowListener(i),s&&this.sendRetainedArgumentsForEvent(e);return Promise.resolve({remove:async()=>this.removeListener(e,t)})}async removeAllListeners(){this.listeners={};for(const e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,t,s){const i=this.listeners[e];if(i)i.forEach(e=>e(t));else if(s){let s=this.retainedEventArguments[e];s||(s=[]),s.push(t),this.retainedEventArguments[e]=s}}hasListeners(e){var t;return!!(null===(t=this.listeners[e])||void 0===t?void 0:t.length)}registerWindowListener(e,t){this.windowListeners[t]={registered:!1,windowEventName:e,pluginEventName:t,handler:e=>{this.notifyListeners(t,e)}}}unimplemented(e="not implemented"){return new ve.Exception(e,de.Unimplemented)}unavailable(e="not available"){return new ve.Exception(e,de.Unavailable)}async removeListener(e,t){const s=this.listeners[e];if(!s)return;const i=s.indexOf(t);this.listeners[e].splice(i,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){const t=this.retainedEventArguments[e];t&&(delete this.retainedEventArguments[e],t.forEach(t=>{this.notifyListeners(e,t)}))}}const Ie=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),Le=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class De extends ke{async getCookies(){const e=document.cookie,t={};return e.split(";").forEach(e=>{if(e.length<=0)return;let[s,i]=e.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");s=Le(s).trim(),i=Le(i).trim(),t[s]=i}),t}async setCookie(e){try{const t=Ie(e.key),s=Ie(e.value),i=`; expires=${(e.expires||"").replace("expires=","")}`,a=(e.path||"/").replace("path=",""),n=null!=e.url&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${t}=${s||""}${i}; path=${a}; ${n};`}catch(t){return Promise.reject(t)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(t){return Promise.reject(t)}}async clearCookies(){try{const e=document.cookie.split(";")||[];for(const t of e)document.cookie=t.replace(/^ +/,"").replace(/=.*/,`=;expires=${(new Date).toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}}Ae("CapacitorCookies",{web:()=>new De});const Ge=(e,t={})=>{const s=Object.assign({method:e.method||"GET",headers:e.headers},t),i=((e={})=>{const t=Object.keys(e);return Object.keys(e).map(e=>e.toLocaleLowerCase()).reduce((s,i,a)=>(s[i]=e[t[a]],s),{})})(e.headers)["content-type"]||"";if("string"==typeof e.data)s.body=e.data;else if(i.includes("application/x-www-form-urlencoded")){const t=new URLSearchParams;for(const[s,i]of Object.entries(e.data||{}))t.set(s,i);s.body=t.toString()}else if(i.includes("multipart/form-data")||e.data instanceof FormData){const t=new FormData;if(e.data instanceof FormData)e.data.forEach((e,s)=>{t.append(s,e)});else for(const s of Object.keys(e.data))t.append(s,e.data[s]);s.body=t;const i=new Headers(s.headers);i.delete("content-type"),s.headers=i}else(i.includes("application/json")||"object"==typeof e.data)&&(s.body=JSON.stringify(e.data));return s};class Fe extends ke{async request(e){const t=Ge(e,e.webFetchExtra),s=((e,t=!0)=>e?Object.entries(e).reduce((e,s)=>{const[i,a]=s;let n,r;return Array.isArray(a)?(r="",a.forEach(e=>{n=t?encodeURIComponent(e):e,r+=`${i}=${n}&`}),r.slice(0,-1)):(n=t?encodeURIComponent(a):a,r=`${i}=${n}`),`${e}&${r}`},"").substr(1):null)(e.params,e.shouldEncodeUrlParams),i=s?`${e.url}?${s}`:e.url,a=await fetch(i,t),n=a.headers.get("content-type")||"";let r,o,{responseType:h="text"}=a.ok?e:{};switch(n.includes("application/json")&&(h="json"),h){case"arraybuffer":case"blob":o=await a.blob(),r=await(async e=>new Promise((t,s)=>{const i=new FileReader;i.onload=()=>{const e=i.result;t(e.indexOf(",")>=0?e.split(",")[1]:e)},i.onerror=e=>s(e),i.readAsDataURL(e)}))(o);break;case"json":r=await a.json();break;default:r=await a.text()}const c={};return a.headers.forEach((e,t)=>{c[t]=e}),{data:r,headers:c,status:a.status,url:a.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}}var Re,Ne,Ue,_e;Ae("CapacitorHttp",{web:()=>new Fe}),(Ne=Re||(Re={})).Dark="DARK",Ne.Light="LIGHT",Ne.Default="DEFAULT",(_e=Ue||(Ue={})).None="NONE",_e.Slide="SLIDE",_e.Fade="FADE";const ze=Ae("StatusBar");var je,Ve,qe,He;(Ve=je||(je={})).Dark="DARK",Ve.Light="LIGHT",Ve.Default="DEFAULT",(He=qe||(qe={})).Body="body",He.Ionic="ionic",He.Native="native",He.None="none";const Ye=Ae("Keyboard"),We={},Xe=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){const e=document.getElementsByTagName("link");i=Promise.all(t.map(t=>{if(t=function(e,t){return new URL(e,t).href}(t,s),t in We)return;We[t]=!0;const i=t.endsWith(".css"),a=i?'[rel="stylesheet"]':"";if(!!s)for(let s=e.length-1;s>=0;s--){const a=e[s];if(a.href===t&&(!i||"stylesheet"===a.rel))return}else if(document.querySelector(`link[href="${t}"]${a}`))return;const n=document.createElement("link");return n.rel=i?"stylesheet":"modulepreload",i||(n.as="script",n.crossOrigin=""),n.href=t,document.head.appendChild(n),i?new Promise((e,s)=>{n.addEventListener("load",e),n.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${t}`)))}):void 0}))}return i.then(()=>e()).catch(e=>{const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e})},Ze=Ae("App",{web:()=>Xe(()=>import("./web-BlZCzgdn.js"),__vite__mapDeps([0,1]),import.meta.url).then(e=>new e.AppWeb)}),$e=Ae("PerformancePlugin",{web:()=>Promise.resolve({maximizePerformance:async()=>({success:!0,message:"Web platform - no optimization needed"}),getDeviceCapabilities:async()=>({model:"Web Browser",systemVersion:navigator.userAgent,processorCount:navigator.hardwareConcurrency||4,physicalMemory:0,thermalState:0,lowPowerMode:!1,batteryLevel:1,supportsProMotion:!1})})});class Qe{static instance;constructor(){}static getInstance(){return Qe.instance||(Qe.instance=new Qe),Qe.instance}async initialize(){if(ve.isNativePlatform())try{await this.hideStatusBar(),await this.configureKeyboard(),this.handleAppStateChanges(),this.disableOverscroll(),this.optimizeWebView(),this.requestHighPerformance()}catch(e){}}async maximizeDevicePerformance(){try{const e=await $e.getDeviceCapabilities();await $e.maximizePerformance();e.supportsProMotion,e.lowPowerMode}catch(e){}}async hideStatusBar(){try{await ze.hide()}catch(e){}}async configureKeyboard(){try{await Ye.setResizeMode({mode:"none"}),await Ye.setAccessoryBarVisible({isVisible:!1})}catch(e){}}handleAppStateChanges(){Ze.addListener("appStateChange",({isActive:e})=>{e?this.onAppResume():this.onAppPause()})}disableOverscroll(){"ios"===ve.getPlatform()&&(document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%",document.body.style.height="100%",document.body.addEventListener("touchmove",e=>{e.touches.length>1||e.preventDefault()},{passive:!1}))}optimizeWebView(){document.body.style.userSelect="none",document.body.style.webkitUserSelect="none",document.body.style.webkitTapHighlightColor="transparent",document.body.style.transform="translateZ(0)",document.body.style.webkitTransform="translateZ(0)",document.body.style.webkitTouchCallout="none";const e=document.querySelector('meta[name="viewport"]');e&&e.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover")}requestHighPerformance(){"wakeLock"in navigator&&navigator.wakeLock.request("screen").then(()=>{}).catch(e=>{})}onAppResume(){const e=window.audioContext;e&&"suspended"===e.state&&e.resume(),"wakeLock"in navigator&&navigator.wakeLock.request("screen").catch(()=>{})}onAppPause(){const e=window.audioContext;e&&"running"===e.state&&e.suspend()}destroy(){Ze.removeAllListeners(),"wakeLock"in navigator&&navigator.wakeLock.release().catch(()=>{})}}new class{game=null;constructor(){this.initialize()}async initialize(){if(ve.isNativePlatform()){const e=Qe.getInstance();await e.initialize()}this.setupErrorHandling(),this.waitForDOM(()=>{this.createGame(),this.hideLoadingScreen()})}setupErrorHandling(){window.addEventListener("error",e=>{}),window.addEventListener("unhandledrejection",e=>{})}waitForDOM(e){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}createGame(){const t=function(t){const i=s.getInstance(),a=i.getOptimalResolution();return/iPad|iPhone|iPod/.test(navigator.userAgent),window.Capacitor,i.getCapabilities().isMobile,{type:e.WEBGL,parent:"game",backgroundColor:"#1a1a2e",width:a.width,height:a.height,scale:{mode:e.Scale.FIT,autoCenter:e.Scale.CENTER_BOTH,width:a.width,height:a.height},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},fps:{target:120,forceSetTimeOut:!1},render:{antialias:!1,pixelArt:!1,roundPixels:!1,transparent:!1,clearBeforeRender:!0,preserveDrawingBuffer:!1,premultipliedAlpha:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",batchSize:4096,resolution:Math.min(window.devicePixelRatio||1,3),maxLights:1,maxTextures:-1,mipmapFilter:"LINEAR",desynchronized:!0,autoMobilePipeline:!1,multiTexture:!0,antialiasSamples:0,depth:!1,stencil:!1,webGLTimeout:0,forceWebGL1:!1},scene:t,audio:{disableWebAudio:!1,noAudio:!1},input:{activePointers:2,smoothFactor:0,windowEvents:!1},disableVisibilityChange:!1,banner:!1}}([c,p,m,y,Ee]);try{this.game=new e.Game(t),this.setupGameEventListeners()}catch(i){this.showErrorMessage("Failed to initialize game. Please refresh the page.")}}setupGameEventListeners(){this.game&&(this.game.events.on("ready",()=>{}),this.game.events.on("destroy",()=>{}),window.addEventListener("beforeunload",()=>{this.game&&this.game.destroy(!0,!1)}))}hideLoadingScreen(){setTimeout(()=>{const e=document.getElementById("loading");e&&(e.style.transition="opacity 0.5s",e.style.opacity="0",setTimeout(()=>{e.style.display="none"},500))},1e3)}showErrorMessage(e){const t=document.getElementById("loading");t&&(t.innerHTML=`\n                <div style="color: #e74c3c; font-size: 20px;">${e}</div>\n                <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">\n                    Check the console for more details\n                </div>\n            `)}getGame(){return this.game}};export{ke as W};
//# sourceMappingURL=index-B0aQ3y6f.js.map
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["./web-BlZCzgdn.js","./phaser-D4TLMTam.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}